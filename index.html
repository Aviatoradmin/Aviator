      <!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#111;
    --accent:#00b04f;
    --muted:#888;
    --yellow:#f0c000;
    --red:#d9534f;
  }
  body{
    margin:0;
    background:var(--bg);
    color:white;
    font-family:sans-serif;
  }
  #app{display:none; flex-direction:column; align-items:center; padding:10px;}
  #loading{position:fixed;top:0;left:0;width:100%;height:100%;background:#000;display:flex;align-items:center;justify-content:center;color:#fff;font-size:1.5em;}
  .panel{background:var(--panel); padding:10px; margin:5px; border-radius:6px;}
  .bet-button{padding:5px 10px;border:none;border-radius:4px;color:#fff;cursor:pointer;}
  .bet-button.bet{background:var(--accent);}
  .bet-button.cancel{background:var(--red);}
  .bet-button.yellow{background:var(--yellow);color:#000;}
  .past-item{margin:2px 0;}
</style>
</head>
<body>
<div id="loading">Loading...</div>
<div id="app">
  <div id="sessionName" class="panel">
    <span id="userNameTxt"></span> | Balance: <span id="balanceBox">1000</span>
    <button id="logoutBtn">Logout</button>
    <button id="loginBtn">Login</button>
  </div>

  <div class="panel">
    <input type="number" id="stakeInput" placeholder="Stake" />
    <button id="betButton" class="bet-button bet">Bet</button>
    <span>Current Bet: <span id="betAmount">0</span></span>
  </div>

  <div class="panel">
    <div id="roundStateMsg"></div>
    <div>Countdown: <span id="roundTimer">0s</span></div>
    <div>Live Multiplier: <span id="liveMultiplier">×1.00</span></div>
  </div>

  <div class="panel">
    <h4>Past Multipliers</h4>
    <div id="pastList"></div>
  </div>

  <div class="panel">
    <button id="withdrawBtn">Withdraw</button>
    <button id="depositBtn">Deposit</button>
    <button id="maxBtn">Max</button>
    <button id="plus10">+10</button>
    <button id="plus50">+50</button>
    <div id="statusBox"></div>
  </div>
</div>

<!-- AUTH OVERLAY -->
<div id="authOverlay" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;flex-direction:column;">
  <h2 id="authTitle"></h2>
  <div id="loginForm">
    <input id="loginPhone" placeholder="Phone" />
    <input id="loginPass" type="password" placeholder="Password" />
    <button id="doLogin">Login</button>
    <a href="#" id="showRegister">Register</a>
    <button id="closeAuth">Close</button>
  </div>
  <div id="registerForm">
    <input id="regName" placeholder="Name" />
    <input id="regPhone" placeholder="Phone" />
    <input id="regPass" type="password" placeholder="Password" />
    <input id="regPass2" type="password" placeholder="Confirm Password" />
    <button id="doRegister">Register</button>
    <a href="#" id="showLogin">Login</a>
    <button id="closeAuth">Close</button>
  </div>
</div>

<script>
(() => {
  const DEFAULT_BALANCE = 1000;
  const CYCLE = 15000; // 15s per round
  const PRE_ROUND = 5000; // 5s countdown between rounds
  const FLIGHT = CYCLE - PRE_ROUND;
  const TOTAL = 250;
  const MULTIPLIERS = Array.from({length:TOTAL}, ()=>1 + Math.random()*5);

  // ********** STORAGE HELPERS **********
  const key_accounts = 'avi_accounts';
  const key_session = 'avi_session';
  const key_past = 'avi_past';
  function loadAccounts(){ try { return JSON.parse(localStorage.getItem(key_accounts) || '{}') } catch(e){return {}}}
  function saveAccounts(obj){ localStorage.setItem(key_accounts, JSON.stringify(obj)) }
  function setSession(phone){ localStorage.setItem(key_session, phone) }
  function clearSession(){ localStorage.removeItem(key_session) }
  function getSession(){ return localStorage.getItem(key_session) }
  function loadPast(){ try { return JSON.parse(localStorage.getItem(key_past) || '[]') } catch(e){return []}}
  function savePast(arr){ localStorage.setItem(key_past, JSON.stringify(arr.slice(0,100))) }

  // ********** DOM **********
  const app = document.getElementById('app');
  const loading = document.getElementById('loading');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authOverlay = document.getElementById('authOverlay');
  const authTitle = document.getElementById('authTitle');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');
  const doLogin = document.getElementById('doLogin');
  const doRegister = document.getElementById('doRegister');
  const closeAuth = document.getElementById('closeAuth');
  const sessionName = document.getElementById('sessionName');
  const userNameTxt = document.getElementById('userNameTxt');
  const balanceBox = document.getElementById('balanceBox');
  const stakeInput = document.getElementById('stakeInput');
  const betButton = document.getElementById('betButton');
  const betAmount = document.getElementById('betAmount');
  const statusBox = document.getElementById('statusBox');
  const genIndex = document.getElementById('genIndex');
  const liveMultiplierEl = document.getElementById('liveMultiplier');
  const roundTimer = document.getElementById('roundTimer');
  const pastList = document.getElementById('pastList');
  const withdrawBtn = document.getElementById('withdrawBtn');
  const depositBtn = document.getElementById('depositBtn');
  const maxBtn = document.getElementById('maxBtn');
  const plus10 = document.getElementById('plus10');
  const plus50 = document.getElementById('plus50');
  const roundStateMsg = document.getElementById('roundStateMsg');

  // auth fields
  const loginPhone = document.getElementById('loginPhone');
  const loginPass = document.getElementById('loginPass');
  const regName = document.getElementById('regName');
  const regPhone = document.getElementById('regPhone');
  const regPass = document.getElementById('regPass');
  const regPass2 = document.getElementById('regPass2');

  // ********** APP STATE **********
  let accounts = loadAccounts();
  let past = loadPast();
  let currentUser = getSession();
  let userObj = currentUser ? accounts[currentUser] : null;
  let queuedBet = null;
  let activeBet = null;

  function now(){ return Date.now() }
  function formatNumber(n){ return Number(n).toFixed(2) }
  function safeNum(v){ return Math.max(0, Number(v) || 0) }
  function ensureAccount(phone){
    accounts = loadAccounts();
    if(!accounts[phone]){
      accounts[phone] = { name: phone, phone, pass: '', balance: DEFAULT_BALANCE };
      saveAccounts(accounts);
    }
    return accounts[phone];
  }

  function getRoundIndexForTime(t){
    const idx = Math.floor(t / CYCLE) % TOTAL;
    return idx;
  }
  function getCurrentRoundInfo(){
    const t = now();
    const cycleIndex = Math.floor(t / CYCLE);
    const roundIndex = cycleIndex % TOTAL;
    const cycleStart = cycleIndex * CYCLE;
    const elapsed = t - cycleStart;
    const phase = (elapsed < PRE_ROUND) ? 'pre' : 'flight';
    const phaseElapsed = (phase === 'pre') ? elapsed : (elapsed - PRE_ROUND);
    const phaseRemaining = (phase === 'pre') ? (PRE_ROUND - elapsed) : (CYCLE - elapsed);
    const generated = MULTIPLIERS[roundIndex];
    return { roundIndex, generated, phase, phaseElapsed, phaseRemaining, elapsed, cycleStart };
  }
  function getLiveMultiplier(phase, phaseElapsed, generated){ return (phase !== 'flight') ? 1.00 : 1 + (generated-1)*Math.max(0,Math.min(phaseElapsed/FLIGHT,1)); }

  function pushPast(mult){ past.unshift(Number(mult)); if(past.length>50) past.length=50; savePast(past); renderPast(); }
  function renderPast(){ pastList.innerHTML=''; for(let i=0;i<Math.min(10,past.length);i++){ const v=past[i]; const el=document.createElement('div'); el.className='past-item'; el.textContent='×'+formatNumber(v); pastList.appendChild(el); } }

  function refreshSession(){ currentUser=getSession(); userObj=currentUser?accounts[currentUser]:null; if(userObj){ sessionName.style.display='inline-block'; userNameTxt.textContent=userObj.name||userObj.phone; loginBtn.style.display='none'; logoutBtn.style.display='inline-block'; balanceBox.textContent=String(userObj.balance); } else { sessionName.style.display='none'; loginBtn.style.display='inline-block'; logoutBtn.style.display='none'; balanceBox.textContent='1000'; } }

  loginBtn.addEventListener('click', ()=>{ openAuth('login') });
  closeAuth.addEventListener('click', ()=>{ closeAuthOverlay() });
  logoutBtn.addEventListener('click', ()=>{ clearSession(); queuedBet=null; activeBet=null; statusBox.textContent='Logged out'; refreshSession(); });
  showRegister.addEventListener('click', ()=>{ openAuth('register') });
  showLogin.addEventListener('click', ()=>{ openAuth('login') });

  function openAuth(mode='login'){ authOverlay.style.display='flex'; if(mode==='login'){ authTitle.textContent='Login'; loginForm.style.display='block'; registerForm.style.display='none'; } else { authTitle.textContent='Create account'; loginForm.style.display='none'; registerForm.style.display='block'; } }
  function closeAuthOverlay(){ authOverlay.style.display='none'; }

  doRegister.addEventListener('click', ()=>{
    const name = regName.value.trim() || regPhone.value.trim();
    const phone = regPhone.value.trim();
    const p1 = regPass.value;
    const p2 = regPass2.value;
    if(!phone){ alert('Enter phone'); return; }
    if(!p1 || p1.length<3){ alert('Password too short'); return; }
    if(p1!==p2){ alert('Passwords do not match'); return; }
    accounts = loadAccounts();
    if(accounts[phone]){ alert('Account exists with this phone'); return; }
    accounts[phone] = { name, phone, pass: p1, balance: DEFAULT_BALANCE };
    saveAccounts(accounts);
    setSession(phone);
    closeAuthOverlay();
    refreshSession();
  });

  doLogin.addEventListener('click', ()=>{
    const phone = loginPhone.value.trim();
    const pass = loginPass.value;
    if(!phone||!pass){ alert('Enter phone and password'); return; }
    accounts = loadAccounts();
    const acc = accounts[phone];
    if(!acc){ alert('No account found'); return; }
    if(acc.pass!==pass){ alert('Password incorrect'); return; }
    setSession(phone);
    closeAuthOverlay();
    refreshSession();
  });

  function updateBetUI(){ betAmount.textContent=(queuedBet?queuedBet.amount:(activeBet?activeBet.amount:0)); if(activeBet){ betButton.className='bet-button yellow'; betButton.textContent='Cash out'; } else if(queuedBet){ betButton.className='bet-button cancel'; betButton.textContent='Cancel'; } else { betButton.className='bet-button bet'; betButton.textContent='Bet'; } }

  betButton.addEventListener('click', ()=>{
    if(!currentUser){ openAuth('login'); return; }
    const stake=safeNum(stakeInput.value);
    if(betButton.classList.contains('bet')){
      if(stake<=0){ alert('Enter stake amount'); return; }
      if(stake>userObj.balance){ alert('Stake must be <= balance'); return; }
      queuedBet={amount:stake};
      statusBox.textContent='Queued for next round. You may cancel before flight starts.';
      updateBetUI();
    } else if(betButton.classList.contains('cancel')){
      queuedBet=null;
      statusBox.textContent='Bet cancelled';
      updateBetUI();
    } else if(betButton.classList.contains('yellow')){
      if(!activeBet) return;
      const ri=activeBet.roundIndex;
      const generated=MULTIPLIERS[ri];
      const info=getCurrentRoundInfo();
      const live=getLiveMultiplier(info.phase, info.phaseElapsed, generated);
      accounts=loadAccounts();
      accounts[currentUser].balance+=activeBet.amount*live;
      saveAccounts(accounts);
      userObj=accounts[currentUser];
      activeBet=null;
      statusBox.textContent='Cashed out: ×'+formatNumber(live)+' → +'+formatNumber(activeBet.amount*live);
      balanceBox.textContent=String(Math.round(userObj.balance*100)/100);
      updateBetUI();
    }
  });

  function deductForActive(amt){ accounts=loadAccounts(); accounts[currentUser].balance-=amt; saveAccounts(accounts); userObj=accounts[currentUser]; balanceBox.textContent=String(Math.round(userObj.balance*100)/100); }

  let lastRoundIndex=null;
  function mainTick(){
    const info=getCurrentRoundInfo();
    const idx=info.roundIndex;
    renderPast();

    // only show countdown during PRE_ROUND (5s between rounds)
    if(info.phase==='pre'){
      roundStateMsg.textContent='Betting — place stake';
      roundTimer.textContent=Math.ceil(info.phaseRemaining/1000)+'s';
      liveMultiplierEl.textContent='×1.00';
    } else {
      roundStateMsg.textContent='Flight — live';
      liveMultiplierEl.textContent='×1.00'; // no multiplier during flight
      roundTimer.textContent=''; // remove 5s countdown during flight
    }

    if(lastRoundIndex===null) lastRoundIndex=idx;
    if(idx!==lastRoundIndex){
      const prevGen=MULTIPLIERS[lastRoundIndex];
      pushPast(prevGen);
      activeBet=null;
    }

    if(info.phase==='flight'){
      if(queuedBet && !activeBet){
        activeBet={amount:queuedBet.amount, roundIndex:idx};
        queuedBet=null;
        if(currentUser){
          deductForActive(activeBet.amount);
          statusBox.textContent='Bet active — good luck';
        } else {
          activeBet=null;
          statusBox.textContent='No session — bet cancelled';
        }
      }
    }
    updateBetUI();
    lastRoundIndex=idx;
  }
  setInterval(mainTick,120);

  withdrawBtn.addEventListener('click', ()=>{ alert('Withdrawal clicked (dummy).'); });
  depositBtn.addEventListener('click', ()=>{
    if(!currentUser){ openAuth('login'); return; }
    const amt=Number(prompt('Enter amount to deposit :','100'))||0;
    if(amt===0) return;
    accounts=loadAccounts();
    accounts[currentUser].balance+=amt;
    saveAccounts(accounts);
    userObj=accounts[currentUser];
    balanceBox.textContent=String(Math.round(userObj.balance*100)/100);
    statusBox.textContent='Deposited '+amt;
  });
  maxBtn.addEventListener('click', ()=>{ if(!currentUser){ openAuth('login'); return; } accounts=loadAccounts(); stakeInput.value=accounts[currentUser].balance||DEFAULT_BALANCE; });
  plus10.addEventListener('click', ()=>{ stakeInput.value=safeNum(stakeInput.value)+10; });
  plus50.addEventListener('click', ()=>{ stakeInput.value=safeNum(stakeInput.value)+50; });
  stakeInput.addEventListener('input', ()=>{ betAmount.textContent=queuedBet?queuedBet.amount:(activeBet?activeBet.amount:safeNum(stakeInput.value)); });

  function init(){ accounts=loadAccounts(); past=loadPast(); refreshSession(); renderPast(); loading.style.display='none'; app.style.display='flex'; updateBetUI(); }
  init();

})();
</script>
</body>
  </html>
