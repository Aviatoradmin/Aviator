<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator</title>
    <style>
        /* --- CSS STYLING: Mobile-First Layout --- */
        :root {
            --bg-color: #000000;
            --login-bg: #000080; /* Blue login page as requested */
            --primary-red: #E23D3D;
            --success-green: #28a745;
            --btn-yellow: #ffc107;
            --btn-blue: #007bff;
            --text-white: #ffffff;
            --text-grey: #888888;
            --panel-bg: #151515;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            font-family: 'Arial', sans-serif;
            color: var(--text-white);
            overflow: hidden;
        }

        /* --- LOGIN / AUTH SCREEN --- */
        #auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--login-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-box {
            width: 85%;
            max-width: 350px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .auth-input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary { background: var(--success-green); color: white; }
        .btn-secondary { background: #444; color: white; }
        .password-toggle { position: absolute; right: 25px; top: 12px; cursor: pointer; color: #aaa; }
        .input-group { position: relative; display: flex; align-items: center; justify-content: center; }

        /* --- GAME INTERFACE --- */
        #game-screen {
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: black; /* General page color black */
        }

        /* TOP BAR (25% height approx split) */
        .top-bar {
            height: 50px;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            align-items: center;
        }

        .stat-box {
            border-radius: 5px;
            padding: 8px 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
            cursor: pointer;
        }

        #withdraw-btn {
            background: var(--btn-yellow);
            color: black;
            position: relative;
        }

        #balance-display {
            background: var(--success-green);
            color: white;
        }

        /* PAST MULTIPLIERS (vii) */
        .history-bar {
            height: 30px;
            background: #111;
            display: flex;
            align-items: center;
            overflow-x: scroll;
            padding: 0 10px;
            gap: 8px;
            white-space: nowrap;
        }
        .history-bar::-webkit-scrollbar { display: none; } /* Hide scrollbar */


        .history-pill {
            background: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 12px;
            flex-shrink: 0;
            color: #ccc;
        }
        .history-pill.high { color: var(--primary-red); }

        /* GAME CANVAS (50% height approx) */
        .game-area {
            flex-grow: 1;
            position: relative;
            background: black;
            overflow: hidden;
            height: 50vh; /* Approximate half screen height */
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .center-info {
            position: absolute;
            top: 25%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
        }

        #live-multiplier {
            font-size: 60px;
            font-weight: bold;
            color: white;
            transition: color 0.2s;
        }

        #game-status {
            font-size: 18px;
            color: var(--btn-yellow);
            margin-bottom: 5px;
        }

        /* BOTTOM CONTROLS (25% approx) */
        .control-panel {
            background: var(--panel-bg);
            padding: 15px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            height: calc(25vh - 60px); /* Adjust to fit screen */
            align-items: flex-start;
            border-top: 1px solid #333;
        }

        /* Left: Stake Input (vii) */
        .stake-container {
            flex: 1;
            background: #222;
            border-radius: 8px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%;
        }

        .stake-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        
        #stake-input {
            background: black;
            border: 1px solid #444;
            color: white;
            font-size: 18px;
            width: 100%;
            text-align: center;
            padding: 5px 0;
            border-radius: 4px;
        }
        
        /* Right: Big Button (vi) */
        .action-btn-container {
            flex: 1.5;
            height: 100%;
        }

        #main-action-btn {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 8px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: var(--success-green);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.1s;
        }

        /* Button States */
        .btn-bet { background: var(--success-green); }
        .btn-cashout { background: var(--btn-yellow); color: black !important; }
        .btn-cancel { background: var(--primary-red); }

        .btn-subtext { font-size: 12px; font-weight: normal; opacity: 0.8; margin-top: 5px; }

        /* Withdrawal Modal (iii) */
        #withdraw-modal {
            position: absolute;
            top: 50px;
            left: 0;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            display: none;
            z-index: 200;
            width: 180px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .proceed-btn {
            background: var(--btn-blue);
            color: white;
            border: none;
            padding: 8px;
            width: 100%;
            margin-top: 8px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

    </style>
</head>
<body>

    <div id="auth-screen">
        <h2 style="color:white; margin-bottom:30px;">AVIATOR</h2>
        
        <div class="toggle-container" style="display:flex; gap:10px; margin-bottom:20px;">
            <button class="btn btn-primary" onclick="toggleAuthMode('login')" id="login-toggle-btn">Login</button>
            <button class="btn btn-secondary" onclick="toggleAuthMode('signup')" id="signup-toggle-btn">Create Account</button>
        </div>

        <div class="auth-box" id="login-box">
            <h3 style="color:white;">Player Login</h3>
            <input type="tel" id="login-phone" class="auth-input" placeholder="Phone Number">
            <div class="input-group">
                <input type="password" id="login-pass" class="auth-input" placeholder="Password">
                <span class="password-toggle material-icons" onclick="togglePasswordVisibility('login-pass')">üëÅÔ∏è</span>
            </div>
            <button class="btn btn-primary" onclick="handleLogin()">Log In</button>
        </div>

        <div class="auth-box" id="signup-box" style="display:none;">
            <h3 style="color:white;">Create Account</h3>
            <input type="tel" id="signup-phone" class="auth-input" placeholder="Phone Number">
            <div class="input-group">
                <input type="password" id="signup-pass" class="auth-input" placeholder="Password">
                <span class="password-toggle material-icons" onclick="togglePasswordVisibility('signup-pass')">üëÅÔ∏è</span>
            </div>
            <div class="input-group">
                <input type="password" id="signup-confirm" class="auth-input" placeholder="Confirm Password">
                <span class="password-toggle material-icons" onclick="togglePasswordVisibility('signup-confirm')">üëÅÔ∏è</span>
            </div>
            <label style="color:#aaa; font-size:12px; display:block; text-align:left; margin-top:5px;">
                <input type="checkbox" id="save-password-signup" style="margin-right:5px;"> Save Password to browser (Optional)
            </label>
            <button class="btn btn-primary" onclick="handleSignup()">Register</button>
        </div>
    </div>

    <div id="game-screen">
        
        <div class="top-bar">
            <div class="stat-box" id="withdraw-btn" onclick="toggleWithdrawModal()">
                Withdraw
                <div id="withdraw-modal">
                    <input type="number" id="withdraw-amount" placeholder="Enter amount" class="auth-input" style="width:90%; margin:0 0 5px 0;">
                    <button class="proceed-btn" onclick="processWithdraw()">PROCEED</button>
                </div>
            </div>
            <div class="stat-box" id="balance-display">1000.00</div>
        </div>

        <div class="history-bar" id="history-bar">
            </div>

        <div class="game-area" id="game-area">
            <div class="center-info">
                <div id="game-status"></div>
                <div id="live-multiplier">1.00x</div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="control-panel">
            <div class="stake-container">
                <div class="stake-label">STAKE</div>
                <input type="number" id="stake-input" value="10.00" min="1" step="0.01" oninput="updateBetAmount()">
                <div style="display:flex; justify-content:space-around; margin-top:5px;">
                    <button style="background:#333; border:none; color:#fff; border-radius:4px; padding:5px; flex:1; margin-right:5px;" onclick="adjustStake(-10)">-10</button>
                    <button style="background:#333; border:none; color:#fff; border-radius:4px; padding:5px; flex:1;" onclick="adjustStake(10)">+10</button>
                </div>
            </div>

            <div class="action-btn-container">
                <button id="main-action-btn" onclick="handleMainAction()">
                    <span id="btn-text">BET</span>
                    <span id="btn-sub" class="btn-subtext">10.00</span>
                </button>
            </div>
        </div>
    </div>

    <div id="admin-log" style="display:none;"></div>

    <script>
        /** * --- JAVASCRIPT LOGIC --- 
         */
        
        // --- USER & ADMIN STATE ---
        let currentUser = null;
        let balance = 1000.00;
        let adminData = JSON.parse(localStorage.getItem('adminLog')) || { users: {}, withdrawals: [], multipliers: [] };

        // --- GAME STATE ---
        const STATE_WAITING = 0; // 5 second countdown
        const STATE_FLYING = 1;  // Plane moving, multiplier rising
        const STATE_BURST = 2;   // Plane flew away
        
        let gameState = STATE_WAITING;
        let currentMultiplier = 1.00;
        let crashPoint = 1.00;
        
        // --- BETTING STATE ---
        let stakeAmount = 10.00; // Amount from Stake Box
        let activeBet = null;    // Bet that is currently deducted and riding
        let nextRoundBet = null; // Bet queued for the next round
        
        // --- TIMING & CANVAS ---
        let lastTime = 0;
        let countdownTimer = 5.00;
        let planeX = 0;
        let planeY = 0;
        let animationId;

        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = document.getElementById('game-area').clientWidth;
            canvas.height = document.getElementById('game-area').clientHeight;
            if (gameState === STATE_WAITING || gameState === STATE_BURST) {
                // Reset plane position when resizing if not flying
                planeX = 0;
                planeY = canvas.height;
            }
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function updateStakeAmount() {
            stakeAmount = parseFloat(document.getElementById('stake-input').value) || 0;
            if (!activeBet && !nextRoundBet) {
                document.getElementById('btn-sub').innerText = stakeAmount.toFixed(2);
            }
        }
        document.getElementById('stake-input').addEventListener('input', updateStakeAmount);

        /* =========================================
           A. AUTHENTICATION LOGIC
           ========================================= */

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        function toggleAuthMode(mode) {
            document.getElementById('login-box').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('signup-box').style.display = mode === 'signup' ? 'block' : 'none';
            document.getElementById('login-toggle-btn').className = mode === 'login' ? 'btn btn-primary' : 'btn btn-secondary';
            document.getElementById('signup-toggle-btn').className = mode === 'signup' ? 'btn btn-primary' : 'btn btn-secondary';
        }

        function handleSignup() {
            const phone = document.getElementById('signup-phone').value;
            const pass = document.getElementById('signup-pass').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (pass !== confirm) { alert("Passwords do not match"); return; }
            if (!phone || !pass) { alert("Fill all fields"); return; }
            if (adminData.users[phone]) { alert("Account already exists for this number."); return; }

            // Save to Admin Log (Simulated)
            adminData.users[phone] = { phone, pass, balance: 1000.00 };
            localStorage.setItem('adminLog', JSON.stringify(adminData));
            
            // Save to LocalStorage for the user's login state
            localStorage.setItem('user_' + phone, JSON.stringify(adminData.users[phone]));

            console.log(`[ADMIN LOG] New User Created: Phone: ${phone}, Pass: ${pass}`);
            
            alert("Account created! Please log in.");
            toggleAuthMode('login');
        }

        function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            
            const userData = adminData.users[phone];
            
            if (!userData || userData.pass !== pass) { 
                alert("Invalid Phone Number or Password."); 
                return; 
            }

            // Success
            currentUser = userData;
            balance = userData.balance;
            updateBalanceUI();
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            resizeCanvas();
            startGameLoop();
        }

        function logOut() {
            currentUser = null;
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            // Clear current bet states
            activeBet = null;
            nextRoundBet = null;
        }

        // Re-login check on visiting other links/apps
        document.addEventListener("visibilitychange", () => {
            if (document.visibilityState === 'hidden' && currentUser) {
                // Simulate log out when user leaves
                logOut();
                alert("Session expired. Please log in again.");
            }
        });

        /* =========================================
           B. GAME LOOP & LOGIC
           ========================================= */

        // Generate Multiplier based on current minute in Nairobi time (UTC+3)
        // This simulates synchronization without a server.
        function generateCrashPoint() {
            const now = new Date();
            // Get current time in Nairobi (UTC+3)
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
            const nairobiTime = new Date(utc + (3600000 * 3));
            
            // Seed based on minute/second
            const seed = (nairobiTime.getMinutes() * 60) + nairobiTime.getSeconds();
            
            // Simple PRNG (Pseudo-Random Number Generator)
            const x = Math.sin(seed * 10) * 10000;
            let random = x - Math.floor(x); // 0.0 to 1.0
            
            // Aviator Logic: 
            let multiplier = 0.99 / (1 - random);

            // Ensure minimum 1.00x and apply a soft cap for stability
            if(multiplier < 1.00) multiplier = 1.00;
            if(multiplier > 50.00) multiplier = 50.00; 

            // Save multiplier and time to Admin log
            adminData.multipliers.push({
                time: nairobiTime.toISOString(),
                crash: multiplier.toFixed(2)
            });
            localStorage.setItem('adminLog', JSON.stringify(adminData));
            
            return parseFloat(multiplier.toFixed(2));
        }

        function startGameLoop() {
            lastTime = Date.now();
            requestAnimationFrame(update);
        }

        function update() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000; // Delta time in seconds
            lastTime = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (gameState === STATE_WAITING) {
                updateWaiting(dt);
            } else if (gameState === STATE_FLYING) {
                updateFlying(dt);
            } else if (gameState === STATE_BURST) {
                updateBurst(dt);
            }

            updateUI();
            animationId = requestAnimationFrame(update);
        }

        function updateWaiting(dt) {
            countdownTimer -= dt;
            
            if (countdownTimer <= 0) {
                startFlight();
            }
        }

        function startFlight() {
            gameState = STATE_FLYING;
            crashPoint = generateCrashPoint();
            currentMultiplier = 1.00;
            planeX = 0;
            planeY = canvas.height;

            // Process Queued Bet (The successful stake logic)
            if (nextRoundBet) {
                activeBet = nextRoundBet; // Move queued bet to active
                nextRoundBet = null; // Clear queue
                
                // DEDUCT BALANCE (Stake deducted immediately when round starts)
                balance -= activeBet.amount;
                updateBalanceUI();
            }
        }

        function updateFlying(dt) {
            // Live Multiplier calculation (close to linear/exponential)
            // Multiplier rate increases slightly over time
            const rate = 0.5 + (currentMultiplier / 100); 
            currentMultiplier += rate * dt;

            // --- Plane Movement (i) ---
            const W = canvas.width;
            const H = canvas.height;
            const maxX = W * 0.75; // 3/4 of its path diagonal
            const t = currentMultiplier - 1.0; // Time factor since 1.00x

            // 1. Diagonal movement (up to 3/4 distance)
            if (planeX < maxX) {
                // x increases with increasing increment
                planeX = (W / crashPoint) * t * 10;
                // y reduces with increasing reduction (diagonal path)
                planeY = H - (planeX * (H / W) * 1.5); 
                if (planeY < H * 0.25) planeY = H * 0.25; // Don't go too high initially
                if (planeX > maxX) planeX = maxX; // Cap X at 3/4
            } else {
                // 2. Smooth Wave Motion (after 3/4 distance)
                planeX = maxX;
                const waveAmplitude = H * 0.15; // Vertical distance up/down
                const waveFrequency = 5;
                const baseHeight = H * 0.3; 
                
                // Up/Down smooth movement
                planeY = baseHeight + waveAmplitude * Math.sin(t * waveFrequency);
            }

            drawPlane(planeX, planeY);

            // Check Crash
            if (currentMultiplier >= crashPoint) {
                burst();
            }
        }

        function burst() {
            gameState = STATE_BURST;
            countdownTimer = 5.0; // Reset countdown for next round
            
            // Add to history
            const hist = document.getElementById('history-bar');
            const pill = document.createElement('div');
            pill.className = 'history-pill ' + (crashPoint >= 2.0 ? 'high' : '');
            pill.innerText = crashPoint.toFixed(2) + 'x';
            hist.prepend(pill);
            // Limit to 10 past multipliers
            if(hist.children.length > 10) hist.removeChild(hist.lastChild);

            // Handle Loss logic
            if (activeBet) {
                // Active bet still exists = loss (money was already deducted)
                activeBet = null; 
            }

            // Simulate plane disappearing
            setTimeout(() => {
                if(gameState === STATE_BURST) {
                    // Start countdown to next round
                    gameState = STATE_WAITING; 
                }
            }, 2000); 
        }

        function updateBurst(dt) {
            // Plane quickly flies off screen
            planeX += 500 * dt;
            planeY -= 200 * dt;
            drawPlane(planeX, planeY);
        }

        /* =========================================
           DRAWING THE PLANE (i)
           ========================================= */
        function drawPlane(x, y) {
            ctx.fillStyle = "transparent";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Trajectory Line (Rope holding plane to 0,0)
            ctx.strokeStyle = "#444444";
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height); // Start (bottom left corner of the box)
            
            // Draw a smooth curve up to the current plane position
            const cpX = x * 0.5; // Control point for smooth curve
            const cpY = canvas.height;
            ctx.quadraticCurveTo(cpX, cpY, x, y);
            ctx.stroke();

            // Red Plane Shape (Simple Triangle for performance)
            ctx.fillStyle = var(--primary-red);
            ctx.beginPath();
            ctx.moveTo(x + 10, y);
            ctx.lineTo(x - 20, y - 5);
            ctx.lineTo(x - 20, y + 5);
            ctx.closePath();
            ctx.fill();
            
            // Live Multiplier text flying with plane
            if (gameState === STATE_FLYING) {
                ctx.fillStyle = "white";
                ctx.font = "bold 24px Arial";
                const multiText = currentMultiplier.toFixed(2) + "x";
                ctx.fillText(multiText, x, y - 30);
            }
        }

        /* =========================================
           BETTING & UI LOGIC (vi, vii)
           ========================================= */
        
        function updateUI() {
            const statusEl = document.getElementById('game-status');
            const multiEl = document.getElementById('live-multiplier');
            const btn = document.getElementById('main-action-btn');
            const btnText = document.getElementById('btn-text');
            const btnSub = document.getElementById('btn-sub');
            
            // Ensure stake amount is synced to the input field
            updateStakeAmount();

            if (gameState === STATE_WAITING) {
                // 5 second countdown (time to bet)
                statusEl.innerText = "STARTING IN " + Math.ceil(countdownTimer) + "s";
                statusEl.style.color = var(--btn-yellow);
                multiEl.innerText = "1.00x";
                multiEl.style.color = "white";

                if (nextRoundBet) {
                    // Player has pressed BET during countdown
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Waiting for next round";
                } else {
                    // Normal BET state
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = stakeAmount.toFixed(2);
                }

            } else if (gameState === STATE_FLYING) {
                statusEl.innerText = "LIVE ROUND";
                statusEl.style.color = var(--success-green);
                multiEl.innerText = currentMultiplier.toFixed(2) + "x";
                multiEl.style.color = currentMultiplier >= 2.0 ? var(--primary-red) : var(--success-green);
                
                if (activeBet) {
                    // Player is IN the game (Cash Out state)
                    const winAmount = (activeBet.amount * currentMultiplier).toFixed(2);
                    btn.className = "btn-cashout";
                    btnText.innerText = "CASH OUT";
                    btnSub.innerText = winAmount; // Real-time calculated winnings
                } else if (nextRoundBet) {
                    // Player missed the round but pressed BET for the next one
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Wait for next round";
                } else {
                    // Player missed the round, can BET for next
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = stakeAmount.toFixed(2);
                }

            } else if (gameState === STATE_BURST) {
                statusEl.innerText = "FLEW AWAY @ " + crashPoint.toFixed(2) + "x";
                statusEl.style.color = var(--primary-red);
                multiEl.innerText = crashPoint.toFixed(2) + "x";
                multiEl.style.color = var(--primary-red);
                
                // Button state reverts to normal bet/cancel queue
                if (nextRoundBet) {
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Waiting...";
                } else {
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = stakeAmount.toFixed(2);
                }
            }
        }

        // Handle Main Button Click
        function handleMainAction() {
            // 1. CASHOUT (Priority if Flying and Active)
            if (gameState === STATE_FLYING && activeBet) {
                // Successful Cash Out
                const winnings = activeBet.amount * currentMultiplier;
                balance += winnings;
                updateBalanceUI();
                activeBet = null;
                return;
            }

            // 2. CANCEL (If queued bet exists in ANY state other than active flying)
            if (nextRoundBet) {
                // Withdraw from the coming draw (no balance change since not deducted yet)
                nextRoundBet = null; 
                return;
            }

            // 3. PLACE BET (Queue for next round / Immediate Bet if in WAITING)
            if (!activeBet && !nextRoundBet) {
                if (stakeAmount <= 0) { alert("Stake cannot be zero."); return; }
                if (stakeAmount > balance) { alert("Insufficient Balance."); return; }
                
                nextRoundBet = { amount: stakeAmount };
                
                // If clicked during the ongoing draw, they see CANCEL immediately (handled by updateUI)
                // If clicked during the 5s WAITING, they also see CANCEL immediately (handled by updateUI)
            }
        }

        function adjustStake(val) {
            let v = parseFloat(document.getElementById('stake-input').value);
            v = isNaN(v) ? 0 : v;
            v += val;
            if (v < 1) v = 1;
            document.getElementById('stake-input').value = v.toFixed(2);
            updateStakeAmount();
        }

        function updateBalanceUI() {
            document.getElementById('balance-display').innerText = balance.toFixed(2);
            // Sync user data to admin log and local storage
            if(currentUser) {
                adminData.users[currentUser.phone].balance = balance;
                localStorage.setItem('adminLog', JSON.stringify(adminData));
                localStorage.setItem('user_' + currentUser.phone, JSON.stringify(adminData.users[currentUser.phone]));
            }
        }

        /* =========================================
           WITHDRAWAL LOGIC (iii)
           ========================================= */
        function toggleWithdrawModal() {
            const modal = document.getElementById('withdraw-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        function processWithdraw() {
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            if (isNaN(amt) || amt <= 0) { alert("Enter a valid amount."); return; }
            if (amt > balance) { alert("Insufficient Balance."); return; }

            // Deduct
            balance -= amt;
            updateBalanceUI();

            // Record in Admin Log (Simulating submission to GitHub/Email)
            const withdrawalRecord = {
                user: currentUser.phone,
                amount: amt.toFixed(2),
                time: new Date().toISOString()
            };
            adminData.withdrawals.push(withdrawalRecord);
            localStorage.setItem('adminLog', JSON.stringify(adminData));
            console.log(`[ADMIN LOG] Withdrawal Request: ${JSON.stringify(withdrawalRecord)}`);

            // UI Feedback
            const btn = document.querySelector('#withdraw-modal .proceed-btn');
            const originalText = btn.innerText;
            btn.style.background = var(--success-green);
            btn.innerText = "SUBMITTED";

            setTimeout(() => {
                toggleWithdrawModal();
                btn.innerText = originalText;
                btn.style.background = var(--btn-blue);
                document.getElementById('withdraw-amount').value = "";
            }, 1500);
        }

        // Initialize UI
        updateBalanceUI();
        toggleAuthMode('login');
    </script>
</body>
</html>
