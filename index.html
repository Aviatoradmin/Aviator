<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Aviator</title>
<style>
  :root{
    --bg:#0b0b0b;
    --panel:#111;
    --accent:#00b04f;
    --muted:#888;
    --yellow:#f0c000;
    --red:#d9534f;
  }
  body{ margin:0; font-family:sans-serif; background:var(--bg); color:#fff; }
  #app{ display:none; flex-direction:column; align-items:center; padding:10px; }
  #loading{ color:#888; }
  .bet-button{ padding:5px 10px; margin:5px; border:none; cursor:pointer; }
  .bet-button.bet{ background:var(--accent); color:#000; }
  .bet-button.cancel{ background:var(--red); color:#fff; }
  .bet-button.yellow{ background:var(--yellow); color:#000; }
  #authOverlay{ display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.8); justify-content:center; align-items:center; }
  #authOverlay div{ background:#111; padding:20px; border-radius:8px; }
  #planeCanvas{ width:100%; height:200px; background:#071018; margin-top:10px; }
  .past-item{ display:inline-block; margin:2px 4px; font-size:12px; }
</style>
</head>
<body>
<div id="loading">Loading...</div>
<div id="app">
  <div>
    <span id="sessionName" style="display:none;">Hello, <span id="userNameTxt"></span></span>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
  </div>
  <div>Balance: <span id="balanceBox">0</span></div>
  <input type="number" id="stakeInput" placeholder="Stake" />
  <button id="betButton" class="bet-button bet">Bet</button>
  <span>Bet Amount: <span id="betAmount">0</span></span>
  <div id="statusBox"></div>
  <div>Round: <span id="genIndex">0</span></div>
  <div>Multiplier: <span id="liveMultiplier">×1.00</span></div>
  <div>Timer: <span id="roundTimer">0s</span></div>
  <div id="roundStateMsg"></div>
  <div>Past: <div id="pastList"></div></div>
  <button id="withdrawBtn">Withdraw</button>
  <button id="depositBtn">Deposit</button>
  <button id="maxBtn">Max</button>
  <button id="plus10">+10</button>
  <button id="plus50">+50</button>
  <canvas id="planeCanvas"></canvas>
</div>

<div id="authOverlay">
  <div>
    <h3 id="authTitle">Login</h3>
    <form id="loginForm">
      <input type="text" id="loginPhone" placeholder="Phone" /><br/>
      <input type="password" id="loginPass" placeholder="Password" /><br/>
      <button type="button" id="doLogin">Login</button><br/>
      <a href="javascript:;" id="showRegister">Register</a>
    </form>
    <form id="registerForm" style="display:none;">
      <input type="text" id="regName" placeholder="Name" /><br/>
      <input type="text" id="regPhone" placeholder="Phone" /><br/>
      <input type="password" id="regPass" placeholder="Password" /><br/>
      <input type="password" id="regPass2" placeholder="Confirm Password" /><br/>
      <button type="button" id="doRegister">Register</button><br/>
      <a href="javascript:;" id="showLogin">Login</a>
    </form>
    <button id="closeAuth">Close</button>
  </div>
</div>

<script>
(() => {
  const DEFAULT_BALANCE = 1000;
  const CYCLE = 15000; // ms per round
  const PRE_ROUND = 5000;
  const FLIGHT = CYCLE - PRE_ROUND;
  const TOTAL = 250;
  const MULTIPLIERS = Array.from({length:TOTAL}, ()=>Math.random()*5 + 1);

  // ********** STORAGE HELPERS **********
  const key_accounts = 'avi_accounts';
  const key_session = 'avi_session';
  const key_past = 'avi_past';

  function loadAccounts(){ try { return JSON.parse(localStorage.getItem(key_accounts) || '{}') } catch(e){return {}}}
  function saveAccounts(obj){ localStorage.setItem(key_accounts, JSON.stringify(obj)) }
  function setSession(phone){ localStorage.setItem(key_session, phone) }
  function clearSession(){ localStorage.removeItem(key_session) }
  function getSession(){ return localStorage.getItem(key_session) }
  function loadPast(){ try { return JSON.parse(localStorage.getItem(key_past) || '[]') } catch(e){return []}}
  function savePast(arr){ localStorage.setItem(key_past, JSON.stringify(arr.slice(0,100))) }

  // ********** DOM **********
  const app = document.getElementById('app');
  const loading = document.getElementById('loading');
  const loginBtn = document.getElementById('loginBtn');
  const logoutBtn = document.getElementById('logoutBtn');
  const authOverlay = document.getElementById('authOverlay');
  const authTitle = document.getElementById('authTitle');
  const loginForm = document.getElementById('loginForm');
  const registerForm = document.getElementById('registerForm');
  const showRegister = document.getElementById('showRegister');
  const showLogin = document.getElementById('showLogin');
  const doLogin = document.getElementById('doLogin');
  const doRegister = document.getElementById('doRegister');
  const closeAuth = document.getElementById('closeAuth');
  const sessionName = document.getElementById('sessionName');
  const userNameTxt = document.getElementById('userNameTxt');
  const balanceBox = document.getElementById('balanceBox');
  const stakeInput = document.getElementById('stakeInput');
  const betButton = document.getElementById('betButton');
  const betAmount = document.getElementById('betAmount');
  const statusBox = document.getElementById('statusBox');
  const genIndex = document.getElementById('genIndex');
  const liveMultiplierEl = document.getElementById('liveMultiplier');
  const roundTimer = document.getElementById('roundTimer');
  const pastList = document.getElementById('pastList');
  const withdrawBtn = document.getElementById('withdrawBtn');
  const depositBtn = document.getElementById('depositBtn');
  const maxBtn = document.getElementById('maxBtn');
  const plus10 = document.getElementById('plus10');
  const plus50 = document.getElementById('plus50');
  const roundStateMsg = document.getElementById('roundStateMsg');
  const planeCanvas = document.getElementById('planeCanvas');

  const loginPhone = document.getElementById('loginPhone');
  const loginPass = document.getElementById('loginPass');
  const regName = document.getElementById('regName');
  const regPhone = document.getElementById('regPhone');
  const regPass = document.getElementById('regPass');
  const regPass2 = document.getElementById('regPass2');
  const showRegisterLink = showRegister;
  const showLoginLink = showLogin;

  // ********** APP STATE **********
  let accounts = loadAccounts();
  let past = loadPast();
  let currentUser = getSession();
  let userObj = currentUser ? accounts[currentUser] : null;

  let queuedBet = null;
  let activeBet = null;

  const ctx = planeCanvas.getContext ? planeCanvas.getContext('2d') : null;
  let planeImg = new Image();
  planeImg.src = 'planeA.png';
  planeImg.onerror = ()=>{ planeImg = null; }

  function resizeCanvas(){
    planeCanvas.width = planeCanvas.clientWidth * devicePixelRatio;
    planeCanvas.height = planeCanvas.clientHeight * devicePixelRatio;
    ctx && ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
  }
  window.addEventListener('resize', resizeCanvas);

  function now(){ return Date.now() }
  function formatNumber(n){ return Number(n).toFixed(2) }
  function safeNum(v){ return Math.max(0, Number(v) || 0) }

  function ensureAccount(phone){
    accounts = loadAccounts();
    if(!accounts[phone]){
      accounts[phone] = { name: phone, phone, pass: '', balance: DEFAULT_BALANCE };
      saveAccounts(accounts);
    }
    return accounts[phone];
  }

  function getRoundIndexForTime(t){
    const idx = Math.floor(t / CYCLE) % TOTAL;
    return idx;
  }
  function getRoundStartTimeForIndex(i){
    const cyclesSinceEpoch = Math.floor(Date.now() / CYCLE);
    const currentIndex = cyclesSinceEpoch % TOTAL;
    const diff = (i - currentIndex + TOTAL) % TOTAL;
    return (cyclesSinceEpoch + diff) * CYCLE;
  }

  function getCurrentRoundInfo(){
    const t = now();
    const cycleIndex = Math.floor(t / CYCLE);
    const roundIndex = cycleIndex % TOTAL;
    const cycleStart = cycleIndex * CYCLE;
    const elapsed = t - cycleStart;
    const phase = (elapsed < PRE_ROUND) ? 'pre' : 'flight';
    const phaseElapsed = (phase === 'pre') ? elapsed : (elapsed - PRE_ROUND);
    const phaseRemaining = (phase === 'pre') ? (PRE_ROUND - elapsed) : (CYCLE - elapsed);
    const generated = MULTIPLIERS[roundIndex];
    return { roundIndex, generated, phase, phaseElapsed, phaseRemaining, elapsed, cycleStart };
  }

  function getLiveMultiplier(phase, phaseElapsed, generated){
    if(phase !== 'flight') return 1.00;
    const t = Math.max(0, Math.min(phaseElapsed, FLIGHT));
    const ratio = t / FLIGHT;
    return 1 + (generated - 1) * ratio;
  }

  function pushPast(mult){
    past.unshift(Number(mult));
    if(past.length>50) past.length=50;
    savePast(past);
    renderPast();
  }
  function renderPast(){
    pastList.innerHTML = '';
    for(let i=0;i<Math.min(10,past.length);i++){
      const v = past[i];
      const el = document.createElement('div');
      el.className='past-item';
      el.textContent = '×' + formatNumber(v);
      pastList.appendChild(el);
    }
  }

  function refreshSession(){
    currentUser = getSession();
    userObj = currentUser ? (accounts[currentUser]) : null;
    if(userObj){
      sessionName.style.display='inline-block';
      userNameTxt.textContent = userObj.name || userObj.phone;
      loginBtn.style.display='none';
      logoutBtn.style.display='inline-block';
      balanceBox.textContent = String(userObj.balance);
    } else {
      sessionName.style.display='none';
      loginBtn.style.display='inline-block';
      logoutBtn.style.display='none';
      balanceBox.textContent = String(DEFAULT_BALANCE);
    }
  }

  loginBtn.addEventListener('click', ()=>{ openAuth('login') });
  closeAuth.addEventListener('click', ()=>{ closeAuthOverlay() });
  logoutBtn.addEventListener('click', ()=>{
    clearSession();
    queuedBet = null; activeBet = null;
    statusBox.textContent = 'Logged out';
    refreshSession();
  });

  showRegisterLink.addEventListener('click', ()=>{ openAuth('register') });
  showLoginLink.addEventListener('click', ()=>{ openAuth('login') });

  function openAuth(mode='login'){
    authOverlay.style.display='flex';
    if(mode==='login'){
      authTitle.textContent='Login';
      loginForm.style.display='block';
      registerForm.style.display='none';
    } else {
      authTitle.textContent='Create account';
      loginForm.style.display='none';
      registerForm.style.display='block';
    }
  }
  function closeAuthOverlay(){ authOverlay.style.display='none'; }

  doRegister.addEventListener('click', ()=>{
    const name = regName.value.trim() || regPhone.value.trim();
    const phone = regPhone.value.trim();
    const p1 = regPass.value;
    const p2 = regPass2.value;
    if(!phone){ alert('Enter phone'); return; }
    if(!p1 || p1.length < 3){ alert('Password too short'); return; }
    if(p1 !== p2){ alert('Passwords do not match'); return; }
    accounts = loadAccounts();
    if(accounts[phone]){ alert('Account exists with this phone'); return; }
    accounts[phone] = { name, phone, pass: p1, balance: DEFAULT_BALANCE };
    saveAccounts(accounts);
    setSession(phone);
    closeAuthOverlay();
    refreshSession();
  });

  doLogin.addEventListener('click', ()=>{
    const phone = loginPhone.value.trim();
    const pass = loginPass.value;
    if(!phone || !pass){ alert('Enter phone and password'); return; }
    accounts = loadAccounts();
    const acc = accounts[phone];
    if(!acc){ alert('No account found'); return; }
    if(acc.pass !== pass){ alert('Password incorrect'); return; }
    setSession(phone);
    closeAuthOverlay();
    refreshSession();
  });

  function updateBetUI(){
    betAmount.textContent = (queuedBet ? queuedBet.amount : (activeBet? activeBet.amount : 0));
    if(activeBet){
      betButton.className = 'bet-button yellow';
      betButton.textContent = 'Cash out';
    } else if(queuedBet){
      betButton.className = 'bet-button cancel';
      betButton.textContent = 'Cancel';
    } else {
      betButton.className = 'bet-button bet';
      betButton.textContent = 'Bet';
    }
  }

  betButton.addEventListener('click', ()=>{
    if(!currentUser){ openAuth('login'); return; }
    const stake = safeNum(stakeInput.value);
    if(betButton.classList.contains('bet')){
      if(stake <= 0){ alert('Enter stake amount'); return; }
      if(stake > userObj.balance){ alert('Stake must be <= balance'); return; }
      queuedBet = { amount: stake };
      statusBox.textContent = 'Queued for next round. You may cancel before flight starts.';
      updateBetUI();
    } else if(betButton.classList.contains('cancel')){
      queuedBet = null;
      statusBox.textContent = 'Bet cancelled';
      updateBetUI();
    } else if(betButton.classList.contains('yellow')){
      if(!activeBet){ return; }
      const ri = activeBet.roundIndex;
      const generated = MULTIPLIERS[ri];
      const info = getCurrentRoundInfo();
      const live = getLiveMultiplier(info.phase, info.phaseElapsed, generated);
      const win = activeBet.amount * live;
      accounts = loadAccounts();
      accounts[currentUser].balance = Number(accounts[currentUser].balance) + win;
      saveAccounts(accounts);
      userObj = accounts[currentUser];
      activeBet = null;
      statusBox.textContent = 'Cashed out: ×' + formatNumber(live) + ' → +' + formatNumber(win);
      balanceBox.textContent = String(Math.round(userObj.balance*100)/100);
      updateBetUI();
    }
  });

  function deductForActive(amt){
    accounts = loadAccounts();
    accounts[currentUser].balance = Number(accounts[currentUser].balance) - amt;
    saveAccounts(accounts);
    userObj = accounts[currentUser];
    balanceBox.textContent = String(Math.round(userObj.balance*100)/100);
  }

  let lastRoundIndex = null;
  function mainTick(){
    const info = getCurrentRoundInfo();
    const idx = info.roundIndex;
    genIndex.textContent = idx + 1;
    renderPast();
    if(info.phase === 'pre'){
      roundStateMsg.textContent = 'Betting — place stake';
      roundTimer.textContent = Math.ceil(info.phaseRemaining/1000) + 's';
      liveMultiplierEl.textContent = '×1.00';
    } else {
      roundStateMsg.textContent = 'Flight — live';
      roundTimer.textContent = Math.ceil(info.phaseRemaining/1000) + 's';
      const live = getLiveMultiplier(info.phase, info.phaseElapsed, info.generated);
      liveMultiplierEl.textContent = '×' + formatNumber(live);
    }

    if(lastRoundIndex === null) lastRoundIndex = idx;

    if(idx !== lastRoundIndex){
      const prevGen = MULTIPLIERS[lastRoundIndex];
      pushPast(prevGen);
      activeBet = null;
    }

    if(info.phase === 'flight'){
      if(queuedBet && !activeBet){
        activeBet = { amount: queuedBet.amount, roundIndex: idx };
        queuedBet = null;
        if(currentUser){
          deductForActive(activeBet.amount);
          statusBox.textContent = 'Bet active — good luck';
        } else {
          activeBet = null;
          statusBox.textContent = 'No session — bet cancelled';
        }
      }
    }
    updateBetUI();
    lastRoundIndex = idx;
  }
  setInterval(mainTick, 120);

  function drawPlane(progress, generated, burst){
    const w = planeCanvas.clientWidth;
    const h = planeCanvas.clientHeight;
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = '#071018';
    ctx.fillRect(0,0,w,h);

    const margin = 40;
    const width = w - margin*2;
    const height = h - margin*2;
    const t = Math.max(0, Math.min(progress,1));
    const x = margin + t * width;

    let yRel = -4*(t-0.5)*(t-0.5) + 1;
