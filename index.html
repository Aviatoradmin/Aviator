<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Kenya - Bet & Win</title>
    <style>
        /* --- CSS STYLES --- */
        :root {
            --bg-color: #000000;
            --panel-color: #1b1b1b;
            --text-color: #ffffff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --accent-yellow: #ffc107;
            --accent-blue: #007bff;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* AUTH PAGES */
        #auth-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            background: #111;
            padding: 20px;
        }

        .auth-box {
            background: var(--panel-color);
            padding: 30px;
            border-radius: 10px;
            width: 100%;
            max-width: 350px;
            text-align: center;
        }

        input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #555;
            color: white;
            border-radius: 5px;
            font-size: 16px;
        }

        button {
            cursor: pointer;
            font-weight: bold;
            border: none;
            border-radius: 5px;
        }

        .btn-primary {
            background: var(--accent-green);
            color: white;
            padding: 12px;
            width: 100%;
            margin-top: 10px;
            font-size: 18px;
        }

        .btn-link {
            background: none;
            color: var(--accent-blue);
            margin-top: 15px;
            text-decoration: underline;
        }

        /* GAME UI */
        #game-section {
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            background: #111;
        }

        .bar-box {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .withdraw-bar {
            background: var(--accent-yellow);
            color: black;
            cursor: pointer;
        }

        .balance-bar {
            background: var(--accent-green);
            color: white;
        }

        /* Multiplier History */
        .history-bar {
            display: flex;
            overflow-x: auto;
            padding: 5px;
            background: #222;
            height: 30px;
            align-items: center;
        }
        
        .history-item {
            background: #333;
            padding: 2px 8px;
            border-radius: 10px;
            margin-right: 5px;
            font-size: 12px;
            min-width: 40px;
            text-align: center;
        }

        .history-item.high { color: var(--accent-green); }
        .history-item.low { color: var(--accent-blue); }

        /* Main Canvas Area */
        #canvas-container {
            flex-grow: 1;
            position: relative;
            background: black;
            border-bottom: 1px solid #333;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .live-multiplier {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 48px;
            font-weight: bold;
            color: white;
            text-shadow: 0 0 10px rgba(255,255,255,0.5);
        }

        /* Betting Controls */
        .controls-area {
            background: #1b1b1b;
            padding: 15px;
            border-top: 2px solid #333;
        }

        .control-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
        }

        .stake-box input {
            width: 100px;
            text-align: center;
            margin: 0;
            border: 1px solid #555;
        }

        .bet-btn-container {
            flex-grow: 1;
            height: 60px;
        }

        .big-btn {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            color: white;
            font-size: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        .btn-bet { background: var(--accent-green); }
        .btn-cancel { background: var(--accent-red); }
        .btn-cashout { background: var(--accent-yellow); color: black; }
        .btn-waiting { background: #555; color: #aaa; }

        .sub-text { font-size: 12px; margin-top: 4px; }

        /* Withdrawal Modal */
        #withdraw-modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid var(--accent-yellow);
            z-index: 100;
            width: 80%;
            max-width: 300px;
            text-align: center;
        }

        .proceed-btn {
            background: var(--accent-blue);
            color: white;
            width: 100%;
            padding: 10px;
            margin-top: 10px;
        }

    </style>
</head>
<body>

    <div id="auth-section">
        <h1 style="color: var(--accent-red);">AVIATOR KENYA</h1>
        
        <div id="login-form" class="auth-box">
            <h2>Login</h2>
            <input type="tel" id="login-phone" placeholder="Phone Number" required>
            <input type="password" id="login-pass" placeholder="Password" required>
            <button class="btn-primary" onclick="app.login()">LOG IN</button>
            <button class="btn-link" onclick="app.toggleAuth('register')">Create Account</button>
        </div>

        <div id="register-form" class="auth-box" style="display: none;">
            <h2>Create Account</h2>
            <input type="tel" id="reg-phone" placeholder="Phone Number" required>
            <div style="position:relative">
                <input type="password" id="reg-pass" placeholder="Password" required>
                <span onclick="app.togglePass('reg-pass')" style="position:absolute; right:10px; top:20px; cursor:pointer; color:#aaa;">üëÅÔ∏è</span>
            </div>
            <input type="password" id="reg-confirm" placeholder="Confirm Password" required>
            <button class="btn-primary" onclick="app.register()">CREATE ACCOUNT</button>
            <button class="btn-link" onclick="app.toggleAuth('login')">Back to Login</button>
        </div>
    </div>

    <div id="game-section">
        <div class="top-bar">
            <div class="bar-box withdraw-bar" onclick="gameUI.openWithdraw()">
                WITHDRAW
            </div>
            <div class="bar-box balance-bar">
                <span id="balance-display">1000.00</span> &nbsp;KES
            </div>
        </div>

        <div class="history-bar" id="history-container">
            </div>

        <div id="canvas-container">
            <canvas id="gameCanvas"></canvas>
            <div class="live-multiplier" id="live-counter">1.00x</div>
            <div id="countdown-overlay" style="position:absolute; top:40%; left:50%; transform:translate(-50%,-50%); font-size:60px; color:var(--accent-red); display:none;">5</div>
        </div>

        <div class="controls-area">
            <div class="control-row">
                <div class="stake-box">
                    <label style="color:#aaa; font-size:12px; display:block;">Stake Amount</label>
                    <input type="number" id="stake-amount" value="10" min="1">
                </div>
                
                <div class="bet-btn-container" id="bet-control-box">
                    </div>
            </div>
        </div>
    </div>

    <div id="withdraw-modal">
        <h3 style="color:var(--accent-yellow)">Withdraw Funds</h3>
        <input type="number" id="withdraw-amount" placeholder="Amount">
        <button class="proceed-btn" onclick="gameUI.submitWithdraw()">PROCEED</button>
        <button class="btn-link" onclick="document.getElementById('withdraw-modal').style.display='none'">Cancel</button>
    </div>

    <script>
        /* --- LOGIC SYSTEM --- */

        // 1. AUTHENTICATION & DATA HANDLING
        const app = {
            currentUser: null,
            
            init: function() {
                // Check if logged in
                const savedUser = localStorage.getItem('aviator_active_user');
                if(savedUser) {
                    this.currentUser = JSON.parse(savedUser);
                    this.loadGame();
                }
                
                // Safety Monitor: Log out if tab switched
                document.addEventListener("visibilitychange", () => {
                    if (document.hidden && this.currentUser) {
                        // To be strict per prompt: Ask to log in again
                        this.logout(); 
                    }
                });
            },

            toggleAuth: function(mode) {
                document.getElementById('login-form').style.display = mode === 'login' ? 'block' : 'none';
                document.getElementById('register-form').style.display = mode === 'register' ? 'block' : 'none';
            },

            togglePass: function(id) {
                const el = document.getElementById(id);
                el.type = el.type === 'password' ? 'text' : 'password';
            },

            register: function() {
                const phone = document.getElementById('reg-phone').value;
                const pass = document.getElementById('reg-pass').value;
                const confirm = document.getElementById('reg-confirm').value;

                if(pass !== confirm) { alert("Passwords do not match!"); return; }
                if(!phone || !pass) { alert("Fill all fields"); return; }

                const userData = { phone, pass, balance: 1000.00 };
                localStorage.setItem('user_' + phone, JSON.stringify(userData));
                
                // Simulate sending to Admin
                console.log("SENDING TO ADMIN PANEL: New User", userData);
                
                alert("Account Created! Please Login.");
                this.toggleAuth('login');
            },

            login: function() {
                const phone = document.getElementById('login-phone').value;
                const pass = document.getElementById('login-pass').value;
                
                const stored = JSON.parse(localStorage.getItem('user_' + phone));
                
                if(stored && stored.pass === pass) {
                    this.currentUser = stored;
                    localStorage.setItem('aviator_active_user', JSON.stringify(stored));
                    this.loadGame();
                } else {
                    alert("Invalid Phone or Password");
                }
            },

            logout: function() {
                this.currentUser = null;
                localStorage.removeItem('aviator_active_user');
                document.getElementById('game-section').style.display = 'none';
                document.getElementById('auth-section').style.display = 'flex';
                alert("Security: You left the page. Please login again.");
            },

            loadGame: function() {
                document.getElementById('auth-section').style.display = 'none';
                document.getElementById('game-section').style.display = 'flex';
                gameEngine.updateBalanceDisplay();
                gameEngine.startSystem();
            }
        };

        // 2. GAME ENGINE (The Aviator Logic)
        const gameEngine = {
            state: 'IDLE', // IDLE, COUNTDOWN, FLYING, BURST
            balance: 0,
            currentMultiplier: 1.00,
            crashPoint: 0,
            history: [],
            
            // Betting Logic
            nextRoundBet: 0, // Amount queued for next round
            currentBet: 0,   // Amount in current live round
            hasCashedOut: false,

            canvas: null,
            ctx: null,
            planeImg: new Image(),
            
            startSystem: function() {
                this.balance = app.currentUser.balance;
                this.updateBalanceDisplay();
                
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());

                // Create Red Plane using Canvas paths for simplicity (or load an image)
                // Ideally use an image, but for this code block I'll draw it
                
                this.loop(); // Start animation loop
            },

            resizeCanvas: function() {
                this.canvas.width = this.canvas.parentElement.offsetWidth;
                this.canvas.height = this.canvas.parentElement.offsetHeight;
            },

            // Synchronization using Nairobi Time (Simulated Server)
            getSyncedCrashPoint: function() {
                // Logic: Get current time in Nairobi, floor to nearest 15 seconds
                // This ensures all clients generate same hash
                const date = new Date();
                const timeVal = date.getTime(); 
                // Simple Pseudo Random function seeded by time
                const seed = Math.floor(timeVal / 10000); // Change every 10s
                const x = Math.sin(seed) * 10000;
                const rand = x - Math.floor(x); // 0.0 to 1.0
                
                // Aviator probability distribution (Exponential)
                // 1% chance of instant bust (1.00), rest distributed
                const multiplier = Math.floor(100 / (1 - rand) ) / 100; 
                return Math.max(1.00, Math.min(multiplier, 100)); // Cap at 100x
            },

            // Main Game Loop
            loop: function() {
                // Determines state based on time
                const now = Date.now();
                // Define a cycle: 5s Countdown + Flight Time + 2s Post Burst
                // Simplified state machine for this demo:
                
                if(this.state === 'IDLE') {
                    this.startCountdown();
                }

                requestAnimationFrame(() => this.draw());
            },

            startCountdown: function() {
                this.state = 'COUNTDOWN';
                let seconds = 5;
                const el = document.getElementById('countdown-overlay');
                el.style.display = 'block';
                
                // Lock in the crash point for this round
                this.crashPoint = this.getSyncedCrashPoint(); 
                
                const timer = setInterval(() => {
                    el.innerText = seconds;
                    gameUI.updateBetButtonState(); // Check if user wants to cancel
                    
                    seconds--;
                    if(seconds < 0) {
                        clearInterval(timer);
                        el.style.display = 'none';
                        this.startFlight();
                    }
                }, 1000);
            },

            startFlight: function() {
                this.state = 'FLYING';
                this.currentMultiplier = 1.00;
                this.hasCashedOut = false;

                // Move Queued Bet to Live Bet
                if(this.nextRoundBet > 0) {
                    this.currentBet = this.nextRoundBet;
                    this.nextRoundBet = 0; // Clear queue
                    // Deduct balance NOW
                    this.balance -= this.currentBet;
                    this.updateUserBalance();
                }
                
                gameUI.updateBetButtonState(); // Show Cashout

                const startTime = Date.now();

                const flightInterval = setInterval(() => {
                    const elapsed = (Date.now() - startTime) / 1000;
                    
                    // Growth function: Exponential like real Aviator
                    this.currentMultiplier = 1 + (0.1 * Math.exp(elapsed * 0.5));
                    
                    // Update UI
                    document.getElementById('live-counter').innerText = this.currentMultiplier.toFixed(2) + 'x';
                    
                    // Check Bust
                    if(this.currentMultiplier >= this.crashPoint) {
                        clearInterval(flightInterval);
                        this.burst();
                    }

                    // If user cashed out, buttons handled in UI
                    gameUI.updateCashoutWinnings();

                }, 50);
            },

            burst: function() {
                this.state = 'BURST';
                document.getElementById('live-counter').innerText = "FULE AWAY!";
                document.getElementById('live-counter').style.color = "var(--accent-red)";
                
                // Add to history
                this.history.unshift(this.crashPoint.toFixed(2));
                if(this.history.length > 10) this.history.pop();
                gameUI.renderHistory();

                // Reset Bet if not cashed out
                if(this.currentBet > 0 && !this.hasCashedOut) {
                    // LOSS
                    this.currentBet = 0;
                }

                gameUI.updateBetButtonState();

                // Wait 3 seconds then restart
                setTimeout(() => {
                    this.state = 'IDLE';
                    document.getElementById('live-counter').style.color = "white";
                    document.getElementById('live-counter').innerText = "1.00x";
                    this.loop();
                }, 3000);
            },

            draw: function() {
                const w = this.canvas.width;
                const h = this.canvas.height;
                const ctx = this.ctx;

                // Clear
                ctx.clearRect(0,0,w,h);

                // Draw Grid/Axes
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 1;
                ctx.beginPath();
                ctx.moveTo(20, h-20); ctx.lineTo(w, h-20); // X
                ctx.moveTo(20, h-20); ctx.lineTo(20, 0);   // Y
                ctx.stroke();

                if(this.state === 'FLYING') {
                    // Draw Curve
                    ctx.strokeStyle = 'var(--accent-red)';
                    ctx.lineWidth = 4;
                    ctx.beginPath();
                    ctx.moveTo(20, h-20);

                    // Logic for curve: Diagonal then Wave
                    // Normalize progress 0 to 1
                    let progress = Math.min(1, (this.currentMultiplier - 1) / (this.crashPoint + 2)); 
                    // Visual limit 
                    if(progress > 1) progress = 1;

                    const endX = 20 + (progress * (w-40));
                    const endY = (h-20) - (progress * (h-40));

                    // The Wave Motion logic requested
                    // If 3/4th way (0.75), start wave
                    let finalX = endX;
                    let finalY = endY;

                    if(progress > 0.75) {
                       // Add sine wave to Y
                       const wave = Math.sin(Date.now() / 200) * 20;
                       finalY += wave;
                    }

                    // Draw Quad curve
                    ctx.quadraticCurveTo(w/2, h-20, finalX, finalY);
                    ctx.stroke();

                    // Draw Plane
                    ctx.fillStyle = 'red';
                    ctx.beginPath();
                    ctx.arc(finalX, finalY, 8, 0, Math.PI*2);
                    ctx.fill();
                    
                    // "Rope" visual
                    ctx.strokeStyle = 'rgba(255,0,0,0.3)';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    ctx.moveTo(20, h-20);
                    ctx.lineTo(finalX, finalY);
                    ctx.stroke();
                }
                
                if(this.state === 'FLYING' || this.state === 'COUNTDOWN') {
                     requestAnimationFrame(() => this.draw());
                }
            },

            updateUserBalance: function() {
                app.currentUser.balance = this.balance;
                localStorage.setItem('user_' + app.currentUser.phone, JSON.stringify(app.currentUser));
                this.updateBalanceDisplay();
            },

            updateBalanceDisplay: function() {
                document.getElementById('balance-display').innerText = this.balance.toFixed(2);
            }
        };

        // 3. UI CONTROLLER (Connecting HTML to Logic)
        const gameUI = {
            container: document.getElementById('bet-control-box'),
            
            updateBetButtonState: function() {
                let html = '';
                const stake = document.getElementById('stake-amount').value;

                // SCENARIO 1: Counting Down (Can place next bet)
                if(gameEngine.state === 'COUNTDOWN') {
                    if(gameEngine.nextRoundBet > 0) {
                        // Already bet for next round, show Cancel
                        html = `<button class="big-btn btn-cancel" onclick="gameUI.cancelBet()">
                                    CANCEL
                                    <span class="sub-text">Waiting for next round</span>
                                </button>`;
                    } else {
                        // Can place bet
                        html = `<button class="big-btn btn-bet" onclick="gameUI.placeBet()">
                                    BET <br> ${stake} KES
                                </button>`;
                    }
                }
                // SCENARIO 2: Flying
                else if(gameEngine.state === 'FLYING') {
                    if(gameEngine.currentBet > 0 && !gameEngine.hasCashedOut) {
                        // Active in game -> Show Cash Out
                        const winnings = (gameEngine.currentBet * gameEngine.currentMultiplier).toFixed(2);
                        html = `<button class="big-btn btn-cashout" onclick="gameUI.cashOut()">
                                    CASH OUT
                                    <span class="sub-text">${winnings} KES</span>
                                </button>`;
                    } else if (gameEngine.nextRoundBet > 0) {
                         // Missed this round, waiting for next
                         html = `<button class="big-btn btn-cancel" onclick="gameUI.cancelBet()">
                                    CANCEL
                                    <span class="sub-text">Waiting for next round</span>
                                </button>`;
                    } else {
                        // Missed round, place bet for NEXT
                        html = `<button class="big-btn btn-bet" onclick="gameUI.placeBetNext()">
                                    BET (NEXT ROUND) <br> ${stake} KES
                                </button>`;
                    }
                }
                // SCENARIO 3: Burst
                else {
                     html = `<button class="big-btn btn-waiting">
                                WAITING...
                            </button>`;
                }

                this.container.innerHTML = html;
            },

            updateCashoutWinnings: function() {
                const btn = document.querySelector('.btn-cashout .sub-text');
                if(btn) {
                    const winnings = (gameEngine.currentBet * gameEngine.currentMultiplier).toFixed(2);
                    btn.innerText = winnings + ' KES';
                }
            },

            placeBet: function() {
                const amount = parseFloat(document.getElementById('stake-amount').value);
                if(amount > gameEngine.balance) { alert("Insufficient Balance"); return; }
                
                gameEngine.nextRoundBet = amount;
                // Note: Deduction happens when flight starts as per request
                this.updateBetButtonState();
            },

            placeBetNext: function() {
                this.placeBet(); // Same logic, queues it
            },

            cancelBet: function() {
                gameEngine.nextRoundBet = 0;
                this.updateBetButtonState();
            },

            cashOut: function() {
                if(gameEngine.hasCashedOut) return;
                
                gameEngine.hasCashedOut = true;
                const winAmount = gameEngine.currentBet * gameEngine.currentMultiplier;
                gameEngine.balance += winAmount;
                gameEngine.updateUserBalance();
                
                // Visual feedback
                this.container.innerHTML = `<button class="big-btn btn-primary">WON: ${winAmount.toFixed(2)}</button>`;
            },

            renderHistory: function() {
                const cont = document.getElementById('history-container');
                cont.innerHTML = '';
                gameEngine.history.forEach(val => {
                    const div = document.createElement('div');
                    div.className = `history-item ${val >= 2.0 ? 'high' : 'low'}`;
                    div.innerText = val + 'x';
                    cont.appendChild(div);
                });
            },

            openWithdraw: function() {
                document.getElementById('withdraw-modal').style.display = 'block';
            },

            submitWithdraw: function() {
                const amount = parseFloat(document.getElementById('withdraw-amount').value);
                if(amount > gameEngine.balance) {
                    alert("Insufficient Balance");
                    return;
                }
                
                // Process
                gameEngine.balance -= amount;
                gameEngine.updateUserBalance();
                
                // Mock Admin Send
                const log = {
                    user: app.currentUser.phone,
                    withdrawAmount: amount,
                    time: new Date()
                };
                console.log("SENT TO ADMIN: Withdraw Request", log);
                
                // Feedback
                const btn = document.querySelector('.proceed-btn');
                const originalText = btn.innerText;
                btn.innerText = "SUBMITTED";
                btn.style.background = "grey";
                
                setTimeout(() => {
                    document.getElementById('withdraw-modal').style.display = 'none';
                    btn.innerText = originalText;
                    btn.style.background = "var(--accent-blue)";
                }, 1500);
            }
        };

        // Initialize App
        app.init();

    </script>
</body>
</html>
