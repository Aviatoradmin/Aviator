<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator</title>
    <style>
        /* General Setup */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            color: white;
            background-color: black;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Full Screen Pages */
        .page {
            width: 100vw;
            height: 100vh;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            background-color: blue; /* Login/Create Account page color */
        }
        #game-page {
            background-color: black; /* Aviator game page color */
            justify-content: flex-start;
        }
        .page.active {
            display: flex;
        }

        /* Auth Form Styles */
        .auth-container {
            width: 90%;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            background-color: #1a1a1a;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
        }
        .auth-container h2 {
            text-align: center;
            margin-bottom: 20px;
        }
        .input-group {
            margin-bottom: 15px;
            position: relative;
        }
        .input-group input {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 5px;
            background-color: #333;
            color: white;
            box-sizing: border-box;
        }
        .input-group input:focus {
            outline: 2px solid yellow;
        }
        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #ccc;
            font-size: 0.8em;
        }
        .auth-container button {
            width: 100%;
            padding: 12px;
            margin-top: 10px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
            background-color: yellow;
            color: black;
        }
        .auth-container button:hover {
            background-color: #ffcc00;
        }
        .switch-link {
            text-align: center;
            margin-top: 15px;
            color: #ccc;
            cursor: pointer;
            text-decoration: underline;
        }

        /* Game UI Layout (Mobile-First) */
        #game-ui {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar: Withdrawal, Multiplier Countdown, Balance */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1vh 2vw;
            box-sizing: border-box;
            height: 7vh;
        }
        .top-bar > div {
            padding: 0.5vh 2vw;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        #withdrawal-bar {
            background-color: yellow;
            color: black;
            cursor: pointer;
        }

        #balance-bar {
            background-color: green;
        }

        #multiplier-countdown {
            background-color: black;
            border: 1px solid blue;
            color: blue;
            border-radius: 50%;
            width: 5vh;
            height: 5vh;
            justify-content: center;
            align-items: center;
            font-size: 2.5vh;
        }
        
        /* Aviator Plane Box (Largest Area) */
        #aviator-plane-box {
            flex-grow: 1; /* Takes up most of the vertical space */
            position: relative;
            background-color: #222;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Plane and Multiplier Display */
        #plane-animation {
            position: absolute;
            left: 0;
            bottom: 0;
            width: 50px; /* Base size */
            height: 50px;
            transform: translate(0, 0); /* Initial position */
            transition: transform 0.05s linear;
        }
        .plane-svg {
            width: 100%;
            height: 100%;
            fill: yellow;
        }
        #live-multiplier-display {
            position: absolute;
            font-size: 6vw;
            font-weight: bold;
            color: yellow;
            opacity: 0;
            text-shadow: 0 0 10px rgba(255, 255, 0, 0.7);
        }
        #multiplier-info {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5vw;
            font-weight: bold;
            color: white;
            text-align: center;
        }
        
        /* Past Multipliers Bar */
        #past-multipliers {
            width: 100%;
            height: 4vh;
            padding: 0.5vh 1vw;
            box-sizing: border-box;
            background-color: #111;
            display: flex;
            align-items: center;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }
        .multiplier-item {
            display: inline-block;
            padding: 0.5vh 1.5vw;
            margin-right: 1vw;
            border-radius: 5px;
            font-size: 3vw;
            font-weight: bold;
        }
        .multiplier-low {
            background-color: #444;
            color: #eee;
        }
        .multiplier-high {
            background-color: green;
            color: black;
        }
        .multiplier-very-high {
            background-color: darkgreen;
            color: yellow;
        }

        /* Bottom Bar: Stake and Bet/Cashout */
        .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1vh 2vw;
            box-sizing: border-box;
            height: 10vh;
        }

        #stake-box {
            background-color: blue;
            flex: 1;
            margin-right: 1vw;
            padding: 1vh 2vw;
            border-radius: 5px;
        }
        #stake-input {
            width: 100%;
            padding: 0.5vh 0;
            border: none;
            background: transparent;
            color: white;
            font-size: 4vw;
            font-weight: bold;
            text-align: center;
        }
        #stake-input::placeholder {
            color: #ccc;
        }
        #stake-box h4 {
            margin: 0;
            font-size: 2.5vw;
            text-align: center;
        }

        #bet-button-container {
            flex: 1;
            margin-left: 1vw;
            height: 100%;
        }

        #bet-cashout-button {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 0;
            transition: background-color 0.2s;
        }

        /* Button States */
        .bet-default {
            background-color: green;
            color: white;
        }
        .bet-default .button-data {
            font-size: 5vw;
            font-weight: bolder;
        }

        .cashout-active {
            background-color: yellow;
            color: black;
        }
        .cashout-active .button-name {
            font-size: 3.5vw;
        }
        .cashout-active .button-data {
            font-size: 5vw;
            font-weight: bolder;
        }

        .bet-cancel-wait {
            background-color: red;
            color: white;
        }
        .bet-cancel-wait .button-name {
            font-size: 4vw;
            font-weight: bolder;
        }
        .bet-cancel-wait .button-data {
            font-size: 2.5vw;
        }

        /* Logout */
        #logout-button {
            position: absolute;
            top: 2vh;
            right: 2vw;
            background: #444;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            z-index: 100;
        }
        
    </style>
</head>
<body>

<div id="auth-page" class="page active">
    <div class="auth-container">
        <div id="create-account-form">
            <h2>Create Account</h2>
            <div class="input-group">
                <input type="tel" id="create-phone" placeholder="Enter Phone Number" required>
            </div>
            <div class="input-group">
                <input type="password" id="create-password" placeholder="Enter Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('create-password')">Show</span>
            </div>
            <div class="input-group">
                <input type="password" id="confirm-password" placeholder="Confirm Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('confirm-password')">Show</span>
            </div>
            <button onclick="createAccount()">Create Account</button>
            <div class="switch-link" onclick="showLoginForm()">Already have an account? Log In</div>
        </div>

        <div id="login-form" style="display: none;">
            <h2>Log In</h2>
            <div class="input-group">
                <input type="tel" id="login-phone" placeholder="Phone Number" required>
            </div>
            <div class="input-group">
                <input type="password" id="login-password" placeholder="Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('login-password')">Show</span>
            </div>
            <button onclick="login()">Log In</button>
            <div class="switch-link" onclick="showCreateForm()">Create New Account</div>
        </div>
        <p id="auth-message" style="color: yellow; text-align: center; margin-top: 10px;"></p>
    </div>
</div>

<div id="game-page" class="page">
    <button id="logout-button" onclick="logout()">Log Out</button>

    <div class="top-bar">
        <div id="withdrawal-bar">WITHDRAW</div>
        <div id="multiplier-countdown"></div>
        <div id="balance-bar">Balance: <span id="player-balance">1000</span></div>
    </div>
    
    <div id="aviator-plane-box">
        <div id="multiplier-info">Waiting for next round...</div>
        <div id="plane-animation">
            <svg class="plane-svg" viewBox="0 0 100 100">
                <path d="M50,10 L80,90 L50,70 L20,90 Z" transform="rotate(-15 50 50)"/>
            </svg>
        </div>
        <span id="live-multiplier-display"></span>
    </div>

    <div id="past-multipliers">
        </div>

    <div class="bottom-bar">
        <div id="stake-box">
            <h4>STAKE</h4>
            <input type="number" id="stake-input" placeholder="Amount" min="1" step="any" oninput="updateBetDisplay()">
        </div>
        <div id="bet-button-container">
            <button id="bet-cashout-button" class="bet-default" onclick="handleBetOrCashout()">
                <span class="button-name">BET</span>
                <span class="button-data" id="bet-cashout-data">0</span>
            </button>
        </div>
    </div>
</div>

<script>
    // --- 1. GAME DATA (Generated Multipliers) ---
    const MULTIPLIERS = [
        1.27, 2.14, 1.03, 3.82, 7.41, 1.56, 1.11, 4.27, 12.49, 1.24, 2.71, 1.09, 8.35, 1.63, 1.02, 5.42, 2.03, 1.18, 3.54, 10.83,
        1.15, 1.07, 6.48, 2.32, 1.95, 1.04, 1.34, 9.64, 1.13, 3.09, 1.26, 4.91, 2.67, 1.08, 1.52, 1.21, 14.72, 1.03, 2.18, 1.09,
        1.88, 3.47, 1.06, 7.22, 1.24, 1.11, 2.97, 5.84, 1.04, 18.93, 1.27, 1.18, 4.48, 1.06, 2.54, 1.77, 8.92, 1.39, 1.08, 3.63,
        1.14, 1.04, 22.41, 1.57, 2.01, 1.07, 4.12, 6.83, 1.09, 1.28, 3.96, 2.38, 1.05, 1.16, 15.74, 1.23, 1.02, 9.83, 2.91, 1.31,
        1.18, 4.34, 1.47, 1.06, 13.56, 1.09, 2.26, 1.04, 6.37, 3.04, 1.07, 1.12, 5.78, 2.79, 1.03, 1.61, 12.84, 1.05, 4.53, 1.07,
        1.32, 6.92, 1.14, 1.03, 24.61, 1.19, 2.47, 1.08, 3.26, 1.51, 1.11, 11.77, 1.09, 1.04, 4.16, 2.94, 1.07, 1.15, 7.41, 3.84,
        1.05, 1.32, 10.34, 1.29, 2.11, 1.04, 4.07, 1.62, 1.06, 18.47, 1.13, 1.07, 5.59, 3.17, 1.05, 1.26, 8.92, 1.03, 1.18, 12.33,
        1.21, 1.09, 4.67, 2.61, 1.06, 1.03, 6.44, 1.88, 1.05, 1.17, 14.85, 1.04, 2.36, 1.06, 3.77, 1.58, 1.07, 16.23, 1.31, 1.03,
        7.29, 2.41, 1.09, 1.12, 5.42, 3.98, 1.07, 1.23, 9.14, 1.05, 1.04, 11.81, 1.32, 1.14, 4.84, 2.33, 1.06, 1.03, 7.62, 4.91,
        1.08, 1.17, 12.47, 1.03, 3.72, 1.26, 2.05, 1.04, 1.14, 25.93, 1.36, 1.07, 4.53, 3.64, 1.05, 1.12, 6.21, 1.09, 1.04, 8.71,
        1.26, 1.05, 5.32, 2.47, 1.07, 1.11, 14.31, 1.03, 1.07, 10.57, 1.19, 1.14, 4.91, 3.53, 1.04, 1.26, 9.07, 1.03, 1.18, 13.24,
        1.39, 1.06, 4.62, 2.83, 1.07, 1.03, 6.97, 1.92, 1.05, 1.21, 18.61, 1.06, 3.22, 1.15, 2.41, 1.05, 1.08, 11.39, 1.12, 1.03,
        8.51, 1.28, 1.04, 4.17, 3.11, 1.06, 1.18, 7.73, 1.04, 1.29
    ];
    
    // --- 2. GAME STATE ---
    const gameState = {
        balance: 1000,
        currentStake: 0,
        isBetPlaced: false,
        isRoundActive: false,
        hasCashedOut: false,
        currentMultiplier: 1.00,
        burstMultiplier: 0,
        roundIndex: 0,
        pastMultipliers: [],
        countdownTimer: 0, // 5 seconds
        animationFrameId: null,
        roundStartTime: 0
    };

    // --- 3. DOM ELEMENTS ---
    const elements = {
        authPage: document.getElementById('auth-page'),
        gamePage: document.getElementById('game-page'),
        createForm: document.getElementById('create-account-form'),
        loginForm: document.getElementById('login-form'),
        authMessage: document.getElementById('auth-message'),

        playerBalance: document.getElementById('player-balance'),
        multiplierCountdown: document.getElementById('multiplier-countdown'),
        aviatorPlaneBox: document.getElementById('aviator-plane-box'),
        planeAnimation: document.getElementById('plane-animation'),
        liveMultiplierDisplay: document.getElementById('live-multiplier-display'),
        multiplierInfo: document.getElementById('multiplier-info'),
        pastMultipliersDiv: document.getElementById('past-multipliers'),
        stakeInput: document.getElementById('stake-input'),
        betCashoutButton: document.getElementById('bet-cashout-button'),
        betCashoutName: document.querySelector('#bet-cashout-button .button-name'),
        betCashoutData: document.getElementById('bet-cashout-data')
    };

    // --- 4. AUTHENTICATION LOGIC ---

    // Utility to toggle password visibility
    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        const span = input.nextElementSibling;
        if (input.type === 'password') {
            input.type = 'text';
            span.textContent = 'Hide';
        } else {
            input.type = 'password';
            span.textContent = 'Show';
        }
    }

    // Switch between login and create forms
    function showLoginForm() {
        elements.createForm.style.display = 'none';
        elements.loginForm.style.display = 'block';
        elements.authMessage.textContent = '';
    }

    function showCreateForm() {
        elements.createForm.style.display = 'block';
        elements.loginForm.style.display = 'none';
        elements.authMessage.textContent = '';
    }

    // Create Account Logic
    function createAccount() {
        const phone = document.getElementById('create-phone').value;
        const password = document.getElementById('create-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!phone || !password || !confirmPassword) {
            elements.authMessage.textContent = 'All fields are required.';
            return;
        }
        if (password !== confirmPassword) {
            elements.authMessage.textContent = 'Passwords do not match.';
            return;
        }
        if (localStorage.getItem(phone)) {
            elements.authMessage.textContent = 'Account already exists for this phone number. Please log in.';
            return;
        }

        // Store account (Simulation - not secure)
        localStorage.setItem(phone, JSON.stringify({ password: password, balance: 1000 }));
        elements.authMessage.textContent = 'Account created successfully! Logging in...';
        
        // Auto-login after creation
        setTimeout(() => {
            gameState.balance = 1000;
            updateBalanceDisplay();
            localStorage.setItem('currentUser', phone);
            showGamePage();
        }, 1000);
    }

    // Login Logic
    function login() {
        const phone = document.getElementById('login-phone').value;
        const password = document.getElementById('login-password').value;
        const accountData = localStorage.getItem(phone);

        if (!accountData) {
            elements.authMessage.textContent = 'Account not found. Please create an account.';
            return;
        }

        const account = JSON.parse(accountData);

        if (account.password !== password) {
            elements.authMessage.textContent = 'Incorrect password.';
            return;
        }

        elements.authMessage.textContent = 'Login successful!';
        
        // Set game state and transition
        gameState.balance = account.balance;
        updateBalanceDisplay();
        localStorage.setItem('currentUser', phone);
        
        setTimeout(showGamePage, 1000);
    }

    // Logout Logic
    function logout() {
        // Save current balance before logging out
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            const accountData = JSON.parse(localStorage.getItem(currentUser));
            accountData.balance = gameState.balance;
            localStorage.setItem(currentUser, JSON.stringify(accountData));
        }

        localStorage.removeItem('currentUser');
        showAuthPage();
        // Reset game state for next login
        resetGameState();
    }

    // Check if user is already logged in on page load
    window.onload = function() {
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            const accountData = JSON.parse(localStorage.getItem(currentUser));
            gameState.balance = accountData.balance;
            updateBalanceDisplay();
            showGamePage();
        } else {
            showAuthPage();
        }

        // Ensure we handle URL/App visits by forcing login check (e.g. on focus)
        window.addEventListener('blur', () => {
            if (gameState.isRoundActive) return; // Don't log out during a round
            // This is a simplified check for 'visiting other links/apps'
            if (elements.gamePage.classList.contains('active')) {
                logout();
            }
        });
    }

    // Page Switching
    function showAuthPage() {
        elements.authPage.classList.add('active');
        elements.gamePage.classList.remove('active');
        elements.authMessage.textContent = '';
        // Stop any running game logic
        cancelAnimationFrame(gameState.animationFrameId);
    }

    function showGamePage() {
        elements.authPage.classList.remove('active');
        elements.gamePage.classList.add('active');
        elements.authMessage.textContent = '';
        startNextRoundDelay();
        // Reset inputs on game entry
        elements.stakeInput.value = '';
        updateBetDisplay();
    }


    // --- 5. GAME UI UPDATES ---

    function updateBalanceDisplay() {
        elements.playerBalance.textContent = gameState.balance.toFixed(2);
        // Save balance to localStorage immediately on update
        const currentUser = localStorage.getItem('currentUser');
        if (currentUser) {
            const accountData = JSON.parse(localStorage.getItem(currentUser));
            accountData.balance = gameState.balance;
            localStorage.setItem(currentUser, JSON.stringify(accountData));
        }
    }

    function updateBetDisplay() {
        const stake = parseFloat(elements.stakeInput.value) || 0;
        elements.betCashoutData.textContent = stake.toFixed(2);
    }

    function updateLiveMultiplierDisplay() {
        if (gameState.isRoundActive) {
            elements.liveMultiplierDisplay.textContent = `x${gameState.currentMultiplier.toFixed(2)}`;
            elements.liveMultiplierDisplay.style.opacity = 1;
            elements.multiplierInfo.style.opacity = 0;
        } else {
            elements.liveMultiplierDisplay.style.opacity = 0;
            elements.multiplierInfo.style.opacity = 1;
        }
    }

    function updatePastMultipliers() {
        elements.pastMultipliersDiv.innerHTML = '';
        // Only show the last 10
        const displayMultipliers = gameState.pastMultipliers.slice(-10); 
        displayMultipliers.forEach(m => {
            const item = document.createElement('div');
            item.className = 'multiplier-item';
            item.textContent = `${m.toFixed(2)}x`;
            if (m >= 10) {
                item.classList.add('multiplier-very-high');
            } else if (m >= 2) {
                item.classList.add('multiplier-high');
            } else {
                item.classList.add('multiplier-low');
            }
            elements.pastMultipliersDiv.appendChild(item);
        });
        // Scroll to the end to show latest
        elements.pastMultipliersDiv.scrollLeft = elements.pastMultipliersDiv.scrollWidth;
    }

    function updateButtonState(state, data) {
        elements.betCashoutButton.className = ''; // Reset class
        switch (state) {
            case 'BET':
                elements.betCashoutButton.classList.add('bet-default');
                elements.betCashoutName.textContent = 'BET';
                elements.betCashoutData.textContent = data.toFixed(2);
                break;
            case 'CASHOUT':
                elements.betCashoutButton.classList.add('cashout-active');
                elements.betCashoutName.textContent = 'Cash Out';
                elements.betCashoutData.textContent = data.toFixed(2);
                break;
            case 'CANCEL':
                elements.betCashoutButton.classList.add('bet-cancel-wait');
                elements.betCashoutName.textContent = 'CANCEL';
                elements.betCashoutData.textContent = data; // e.g., "Waiting for next round"
                break;
            case 'LOST':
                elements.betCashoutButton.classList.add('bet-cancel-wait');
                elements.betCashoutName.textContent = 'LOST';
                elements.betCashoutData.textContent = data.toFixed(2); // e.g., "10.00"
                break;
            case 'WON':
                elements.betCashoutButton.classList.add('bet-default');
                elements.betCashoutName.textContent = 'WON';
                elements.betCashoutData.textContent = data.toFixed(2); // e.g., "50.00"
                break;
        }
    }

    // --- 6. GAME ROUND LOGIC ---

    function startNextRoundDelay() {
        if (gameState.isRoundActive) return;

        resetRound();
        
        elements.stakeInput.disabled = false;
        elements.multiplierInfo.textContent = 'Round starting in...';

        const startTime = Date.now();
        const delayDuration = 5000; // 5 seconds
        
        // Inner function for countdown loop
        const countdownLoop = () => {
            const elapsed = Date.now() - startTime;
            const remaining = Math.max(0, delayDuration - elapsed);
            const seconds = (remaining / 1000).toFixed(2);

            elements.multiplierCountdown.textContent = seconds;
            elements.multiplierInfo.textContent = `Round starting in: ${seconds}s`;

            if (remaining > 0) {
                gameState.countdownTimer = requestAnimationFrame(countdownLoop);
            } else {
                // Countdown finished, start the game round
                elements.multiplierCountdown.textContent = '';
                if (gameState.isBetPlaced && !gameState.isRoundActive) {
                    // Successful stake logic: Deduct balance and join draw
                    if (!gameState.hasCashedOut) {
                        gameState.balance -= gameState.currentStake;
                        updateBalanceDisplay();
                        updateButtonState('CASHOUT', gameState.currentStake);
                    }
                }
                startGameRound();
            }
        };

        // If player has a pending bet, change button to CANCEL/Waiting
        if (gameState.currentStake > 0 && !gameState.isBetPlaced) {
            updateButtonState('CANCEL', 'Waiting for next round');
        } else if (!gameState.isBetPlaced) {
             updateButtonState('BET', parseFloat(elements.stakeInput.value) || 0);
        }

        countdownLoop();
    }

    function startGameRound() {
        cancelAnimationFrame(gameState.countdownTimer); // Stop countdown
        
        // Set up the round
        gameState.isRoundActive = true;
        gameState.currentMultiplier = 1.00;
        gameState.burstMultiplier = MULTIPLIERS[gameState.roundIndex % MULTIPLIERS.length];
        gameState.roundIndex++;
        gameState.roundStartTime = Date.now();
        
        elements.stakeInput.disabled = true; // Cannot change stake during the round
        elements.multiplierInfo.textContent = '';
        
        // Start animation loop
        gameLoop();
    }

    // Main Game Animation Loop
    function gameLoop() {
        const elapsed = (Date.now() - gameState.roundStartTime) / 1000; // Time in seconds

        // The multiplier growth curve: An exponential-like curve based on time.
        // Formula: M = 1 + K * T^2, where K is a scaling factor for speed.
        const K = 0.5; // Adjust this to change speed/feel
        let newMultiplier = 1.00 + K * elapsed * elapsed;
        
        // The plane trajectory curve (Parabola: y = a*x^2 + b*x + c)
        // Here, we use time to drive a parabolic-like path (decay curve in path).
        const maxPlaneX = elements.aviatorPlaneBox.clientWidth * 0.9;
        const maxPlaneY = elements.aviatorPlaneBox.clientHeight * 0.9;
        
        // x increases linearly with time (up to a point, then slows or caps)
        let planeX = Math.min(maxPlaneX, elapsed * 150); 
        
        // y increases but reduces increment over time (parabolic trajectory)
        // A simple curve where y starts fast and then levels out slightly
        let planeY = Math.min(maxPlaneY, 50 * Math.log(newMultiplier)); 
        
        // Live Multiplier Check
        if (newMultiplier >= gameState.burstMultiplier) {
            newMultiplier = gameState.burstMultiplier;
            elements.liveMultiplierDisplay.textContent = `x${newMultiplier.toFixed(2)}`;
            endGameRound(newMultiplier);
            return;
        }

        gameState.currentMultiplier = newMultiplier;
        updateLiveMultiplierDisplay();

        // Update Plane Position and Winnings
        elements.planeAnimation.style.transform = `translate(${planeX}px, -${planeY}px)`;
        elements.planeAnimation.style.left = `${10}px`; // Start near left edge

        if (gameState.isBetPlaced && !gameState.hasCashedOut) {
            const winnings = gameState.currentStake * gameState.currentMultiplier;
            updateButtonState('CASHOUT', winnings);
        }

        gameState.animationFrameId = requestAnimationFrame(gameLoop);
    }


    function endGameRound(finalMultiplier) {
        cancelAnimationFrame(gameState.animationFrameId);
        
        gameState.isRoundActive = false;
        
        // Store the final multiplier
        gameState.pastMultipliers.push(finalMultiplier);
        updatePastMultipliers();

        // Display Burst/Result
        elements.liveMultiplierDisplay.textContent = `BUSTED! x${finalMultiplier.toFixed(2)}`;
        elements.planeAnimation.style.transform = `translate(0, 0)`; // Reset plane visual

        if (gameState.isBetPlaced) {
            if (gameState.hasCashedOut) {
                // Already cashed out, do nothing with balance
                updateButtonState('WON', gameState.cashedOutWinnings);
            } else {
                // Did not cash out, player loses stake (already deducted)
                updateButtonState('LOST', gameState.currentStake);
            }
        } else {
            // Player did not bet in this round
            updateButtonState('BET', parseFloat(elements.stakeInput.value) || 0);
        }

        // Wait 5 seconds, then start the next round delay
        setTimeout(startNextRoundDelay, 5000);
    }

    // --- 7. BUTTON HANDLERS ---

    function handleBetOrCashout() {
        const buttonClass = elements.betCashoutButton.className;
        const stakeAmount = parseFloat(elements.stakeInput.value);

        if (buttonClass.includes('bet-default')) {
            // BET logic
            if (!stakeAmount || stakeAmount <= 0) {
                alert("Please enter a valid stake amount.");
                return;
            }
            if (stakeAmount > gameState.balance) {
                alert("Insufficient balance.");
                return;
            }

            gameState.currentStake = stakeAmount;
            
            if (gameState.isRoundActive) {
                // Missed current round: Bet for next round
                gameState.isBetPlaced = false; // Not in THIS round
                updateButtonState('CANCEL', 'Waiting for next round');
            } else {
                // Bet during 5s countdown: Bet for next round
                gameState.isBetPlaced = true; // In the next round
                updateButtonState('CANCEL', 'Waiting for next round');
            }

        } else if (buttonClass.includes('cashout-active')) {
            // CASHOUT logic
            if (!gameState.isRoundActive || gameState.hasCashedOut) return;

            const winnings = gameState.currentStake * gameState.currentMultiplier;
            const netWinnings = winnings - gameState.currentStake;
            gameState.balance += winnings;
            gameState.hasCashedOut = true;
            gameState.cashedOutWinnings = winnings;
            updateBalanceDisplay();

            updateButtonState('WON', winnings);
            elements.stakeInput.disabled = false; // Can now change stake for next round
            
        } else if (buttonClass.includes('bet-cancel-wait')) {
            // CANCEL logic (Withdraw next round bet)
            if (gameState.isRoundActive) {
                // Bet was placed during an active round, for the next one
                // Do nothing to balance since deduction only happens at round start
                gameState.currentStake = 0;
                gameState.isBetPlaced = false;
                updateButtonState('BET', parseFloat(elements.stakeInput.value) || 0);
                
            } else {
                // Bet was placed during 5s countdown for the next one
                gameState.currentStake = 0;
                gameState.isBetPlaced = false;
                updateButtonState('BET', parseFloat(elements.stakeInput.value) || 0);
            }
        }
    }

    // --- 8. INITIALISATION AND HELPERS ---

    function resetGameState() {
        gameState.balance = 1000;
        gameState.roundIndex = 0;
        gameState.pastMultipliers = [];
        resetRound();
    }

    function resetRound() {
        gameState.currentStake = 0;
        gameState.isBetPlaced = false;
        gameState.isRoundActive = false;
        gameState.hasCashedOut = false;
        gameState.cashedOutWinnings = 0;
        gameState.currentMultiplier = 1.00;
        
        // UI Reset
        updateBalanceDisplay();
        elements.planeAnimation.style.transform = `translate(0, 0)`;
        elements.liveMultiplierDisplay.textContent = 'x1.00';
        elements.multiplierInfo.textContent = 'Waiting for next round...';
        elements.stakeInput.disabled = false;
        
        // Reset button to BET state (using current stake input value)
        updateButtonState('BET', parseFloat(elements.stakeInput.value) || 0);
    }
    
</script>
</body>
</html>
