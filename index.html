<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator</title>
    <style>
        /* --- General Styling & Mobile Friendliness --- */
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: black;
            color: white;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* --- Global Boxes (Blue for Auth, Black for Game) --- */
        .auth-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #1a1a54; /* Blue color for login/signup */
            padding: 20px;
        }

        .auth-box, .game-container {
            width: 100%;
            max-width: 400px;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            background-color: #1a1a54;
        }

        .game-container {
            display: none; /* Hidden by default, shown after login */
            flex-direction: column;
            background-color: black; /* Black color for game page */
            max-width: none;
            flex-grow: 1;
        }

        /* --- Form Elements --- */
        input[type="tel"], input[type="password"], input[type="number"], .auth-box button, .game-control-btn {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: none;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        .auth-box button {
            background-color: #4CAF50;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .auth-box button:hover:not(:disabled) {
            background-color: #45a049;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #888;
        }

        .input-group {
            position: relative;
        }

        /* --- Game UI Elements --- */
        .header-bar, .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
        }

        .header-bar {
            background-color: #1c1c1c;
        }

        .balance-box, .withdraw-box {
            padding: 5px 10px;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            align-items: center;
            cursor: pointer;
        }

        .balance-box {
            background-color: #388e3c; /* Green */
        }

        .withdraw-box {
            background-color: #fdd835; /* Yellow */
            color: black;
        }

        /* --- Past Multipliers --- */
        #past-multipliers {
            display: flex;
            overflow-x: auto;
            white-space: nowrap;
            padding: 5px 0;
            background-color: #1c1c1c;
            border-top: 1px solid #333;
            border-bottom: 1px solid #333;
        }

        .multiplier-chip {
            padding: 3px 8px;
            margin-right: 5px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: bold;
            color: black;
            background-color: lightgray;
        }

        /* --- Game Canvas/Plane Box --- */
        #plane-box {
            flex-grow: 1;
            position: relative;
            background-color: #1c1c1c; /* Dark background for the plane area */
            margin: 10px 0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #live-multiplier {
            position: absolute;
            font-size: 3em;
            font-weight: bold;
            color: #ffcc00; /* Yellow */
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2;
        }

        #plane {
            position: absolute;
            width: 50px;
            height: 50px;
            background-color: red; /* Red Plane */
            border-radius: 50%; /* Simple circle to represent plane */
            transform-origin: 0 100%; /* Pivot point for diagonal movement */
            z-index: 1;
        }
        
        /* Rope/Path Visual - Simple diagonal line on the canvas */
        .rope-path {
            position: absolute;
            width: 100%;
            height: 100%;
            border-top-left-radius: 100%;
            border: 2px dashed rgba(255, 255, 255, 0.2);
            box-sizing: border-box;
        }

        /* --- Bottom Controls --- */
        .bottom-bar {
            background-color: #1c1c1c;
        }

        #stake-box {
            flex-basis: 30%;
            background-color: #2c2c2c;
            border-radius: 5px;
            padding: 5px;
        }

        #stake-amount {
            background-color: #383838;
            color: white;
            border: 1px solid #555;
        }

        #bet-box {
            flex-basis: 65%;
            height: 50px;
            border-radius: 5px;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.3s;
        }

        #bet-box.green {
            background-color: #4CAF50; /* Green: Bet/Cash Out available */
        }
        
        #bet-box.yellow {
            background-color: #fdd835; /* Yellow: Cash Out active */
            color: black;
        }
        
        #bet-box.red {
            background-color: #f44336; /* Red: Cancel/Waiting */
        }
        
        .bet-label {
            font-size: 0.8em;
        }
        
        .bet-data {
            font-size: 1.2em;
        }
        
        /* --- Modal for Withdrawal --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); 
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto; 
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 300px;
            border-radius: 10px;
            color: black;
            text-align: center;
        }

        #withdraw-proceed {
            background-color: #2196F3; /* Blue Proceed button */
            color: white;
            padding: 10px;
            border: none;
            border-radius: 5px;
            margin-top: 10px;
            cursor: pointer;
            width: 100%;
        }

    </style>
</head>
<body>

<div id="auth-screen" class="auth-container">
    <div id="auth-main" class="auth-box">
        <h2>Aviator</h2>
        <button onclick="showCreateAccount()">Create Account</button>
        <button onclick="showLogin()">Log In</button>
    </div>

    <div id="create-account-form" class="auth-box" style="display:none;">
        <h3>Create Account</h3>
        <input type="tel" id="create-phone" placeholder="Enter Phone Number" required>
        <div class="input-group">
            <input type="password" id="create-password" placeholder="Enter Password" required>
            <span class="toggle-password" onclick="togglePassword('create-password')">üëÅÔ∏è</span>
        </div>
        <div class="input-group">
            <input type="password" id="confirm-password" placeholder="Confirm Password" required>
            <span class="toggle-password" onclick="togglePassword('confirm-password')">üëÅÔ∏è</span>
        </div>
        <button onclick="createAccount()">Create Account</button>
        <p style="text-align: center; cursor: pointer;" onclick="showAuthMain()">Back to Main</p>
    </div>

    <div id="login-form" class="auth-box" style="display:none;">
        <h3>Log In</h3>
        <input type="tel" id="login-phone" placeholder="Phone Number" required>
        <div class="input-group">
            <input type="password" id="login-password" placeholder="Password" required>
            <span class="toggle-password" onclick="togglePassword('login-password')">üëÅÔ∏è</span>
        </div>
        <input type="checkbox" id="save-password" style="width: auto;"><label for="save-password"> Save Password to browser (Optional)</label>
        <button onclick="logIn()">Log In</button>
        <p style="text-align: center; cursor: pointer;" onclick="showAuthMain()">Back to Main</p>
    </div>
</div>

<div id="game-screen" class="game-container">
    <div class="header-bar">
        <div id="withdraw-box" class="withdraw-box" onclick="showWithdrawModal()">
            Withdraw
        </div>
        <div id="balance-box" class="balance-box">
            Balance: <span id="current-balance">0</span>
        </div>
        <button onclick="logOut()" style="background: none; color: white; border: none;">Log Out</button>
    </div>

    <div id="past-multipliers">
        </div>

    <div id="plane-box">
        <div class="rope-path"></div>
        <div id="plane"></div>
        <div id="live-multiplier">x1.00</div>
    </div>

    <div class="bottom-bar">
        <div id="stake-box">
            <label for="stake-amount" class="bet-label">Stake</label>
            <input type="number" id="stake-amount" placeholder="Enter Amount" value="10" min="1">
        </div>

        <div id="bet-box" class="green" onclick="handleBetCashOut()">
            <span class="bet-label" id="bet-label">Bet</span>
            <span class="bet-data" id="bet-data">10</span>
        </div>
    </div>
</div>

<div id="withdraw-modal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeWithdrawModal()" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: black;">&times;</span>
        <h3>Withdrawal</h3>
        <input type="number" id="withdraw-amount" placeholder="Enter Amount" required>
        <button id="withdraw-proceed" onclick="processWithdrawal()">Proceed</button>
    </div>
</div>

<script>
    // --- Global Variables ---
    const DB_KEY = 'aviator_users_db';
    let currentUser = null;
    let usersDB = JSON.parse(localStorage.getItem(DB_KEY)) || {};
    let currentBalance = 0;
    let currentStake = 0;
    let betState = 'BET'; // 'BET', 'CANCEL', 'CASHOUT'

    // Game Logic Variables
    let gameInterval;
    let roundTimer;
    let countdown = 5;
    let isRoundActive = false;
    let isBetPlaced = false;
    let liveMultiplier = 1.00;
    let generatedMultiplier = 1.00;
    let animationFrameId = null;
    let startTime = 0;
    const PLANE_START_X = 5;
    const PLANE_START_Y = 95;
    const CANVAS_WIDTH = 100;
    const CANVAS_HEIGHT = 100;

    // --- Utility Functions ---

    /**
     * A simple, deterministic Pseudo-Random Number Generator (PRNG).
     * This will generate the same sequence of numbers given the same seed.
     * We use a daily-based seed for "synchronization."
     * NOTE: This is NOT cryptographically secure or provably fair.
     */
    function seededRandom(seed) {
        let x = Math.sin(seed) * 10000;
        return x - Math.floor(x);
    }

    function generateDailyMultiplier() {
        // Use a daily timestamp as the seed for consistency across users for the day
        const today = new Date();
        const seed = today.getFullYear() * 10000 + (today.getMonth() + 1) * 100 + today.getDate();
        
        // Use the seeded random function
        let r = seededRandom(seed * performance.now() * 1000000); 

        // Aviator burst logic: tends to be low, but can spike high.
        // Formula: floor(100 / (100 - X)) * 100 where X is a random number from 1 to 99.99
        // To get a reasonable distribution (e.g., from 1.00 to 100.00+)
        // Simple logarithmic curve for a non-linear feel (example: 1 + log(rand) * factor)
        // A common formula is: Math.floor((100 / (100 - r)) * 100) / 100 where r is a random float [1, 99]
        // Let's simplify for this simulation:
        
        let p = 0.05; // 5% chance of a high multiplier, 95% chance of a low one
        if (r < 0.7) { // 70% chance of a low crash (1.00 - 3.00)
             return parseFloat((1 + r * 2.0).toFixed(2));
        } else if (r < 0.95) { // 25% chance of a medium crash (3.00 - 10.00)
             return parseFloat((3 + r * 7.0).toFixed(2));
        } else { // 5% chance of a high crash (10.00 - 50.00)
             return parseFloat((10 + r * 40.0).toFixed(2));
        }
    }
    
    function saveUsers() {
        localStorage.setItem(DB_KEY, JSON.stringify(usersDB));
    }

    function updateBalanceDisplay() {
        document.getElementById('current-balance').textContent = currentBalance.toFixed(2);
    }

    function togglePassword(id) {
        const input = document.getElementById(id);
        const icon = input.nextElementSibling;
        if (input.type === "password") {
            input.type = "text";
            icon.textContent = 'üîí';
        } else {
            input.type = "password";
            icon.textContent = 'üëÅÔ∏è';
        }
    }

    // --- Authentication Logic (A) ---

    function showAuthMain() {
        document.getElementById('create-account-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('auth-main').style.display = 'block';
    }

    function showCreateAccount() {
        document.getElementById('auth-main').style.display = 'none';
        document.getElementById('create-account-form').style.display = 'block';
        document.getElementById('login-form').style.display = 'none';
    }

    function showLogin() {
        document.getElementById('auth-main').style.display = 'none';
        document.getElementById('create-account-form').style.display = 'none';
        document.getElementById('login-form').style.display = 'block';
    }

    function createAccount() {
        const phone = document.getElementById('create-phone').value;
        const password = document.getElementById('create-password').value;
        const confirmPassword = document.getElementById('confirm-password').value;

        if (!phone || !password || !confirmPassword) {
            alert("All fields are required.");
            return;
        }
        if (password !== confirmPassword) {
            alert("Passwords do not match.");
            return;
        }
        if (usersDB[phone]) {
            alert("Account already exists for this phone number.");
            return;
        }

        // Store user (insecurely) with an initial balance
        usersDB[phone] = { password: password, balance: 1000, history: [] };
        saveUsers();
        
        currentUser = phone;
        currentBalance = usersDB[phone].balance;
        updateBalanceDisplay();
        
        // Clear forms
        document.getElementById('create-phone').value = '';
        document.getElementById('create-password').value = '';
        document.getElementById('confirm-password').value = '';

        alert("Account created successfully! Redirecting to game.");
        showGameScreen();
    }

    function logIn() {
        const phone = document.getElementById('login-phone').value;
        const password = document.getElementById('login-password').value;
        
        if (!phone || !password) {
            alert("Phone number and password are required.");
            return;
        }

        const user = usersDB[phone];
        if (user && user.password === password) { // Simple password check
            currentUser = phone;
            currentBalance = user.balance;
            updateBalanceDisplay();
            
            // Check for save password option
            if (document.getElementById('save-password').checked) {
                // In a real app, this would save a secure token, not the password.
                localStorage.setItem('aviator_saved_phone', phone);
            } else {
                localStorage.removeItem('aviator_saved_phone');
            }

            // Clear password field
            document.getElementById('login-password').value = '';

            showGameScreen();
        } else {
            alert("Invalid phone number or password. Please try again.");
        }
    }

    function logOut() {
        currentUser = null;
        // Optionally clear saved password if not checked (for security)
        // localStorage.removeItem('aviator_saved_phone'); 
        
        // Stop all game processes
        clearInterval(roundTimer);
        cancelAnimationFrame(animationFrameId);
        isRoundActive = false;

        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('auth-screen').style.display = 'flex';
        showAuthMain();
        alert("You have been logged out.");
    }

    function showGameScreen() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        
        // Start the game loop immediately when logged in
        startNextRoundCountdown(); 
        updateStakeBox();
    }
    
    // --- Withdrawal Modal Logic ---
    function showWithdrawModal() {
        document.getElementById('withdraw-modal').style.display = 'block';
        document.getElementById('withdraw-amount').value = '';
        document.getElementById('withdraw-proceed').textContent = 'Proceed';
    }

    function closeWithdrawModal() {
        document.getElementById('withdraw-modal').style.display = 'none';
    }

    function processWithdrawal() {
        const amount = parseFloat(document.getElementById('withdraw-amount').value);
        if (isNaN(amount) || amount <= 0) {
            alert("Please enter a valid amount.");
            return;
        }

        if (amount > currentBalance) {
            alert("Amount exceeds your current balance.");
            return;
        }

        // Simulate deduction and "SUBMITTED" state
        currentBalance -= amount;
        usersDB[currentUser].balance = currentBalance;
        saveUsers();
        updateBalanceDisplay();

        const proceedBtn = document.getElementById('withdraw-proceed');
        proceedBtn.textContent = 'SUBMITTED';
        proceedBtn.disabled = true;

        // Reset and close after a short delay
        setTimeout(() => {
            closeWithdrawModal();
            proceedBtn.disabled = false;
            proceedBtn.textContent = 'Proceed';
        }, 1500);
    }
    
    // --- Stake and Bet/Cash Out Logic ---
    
    // Updates the data displayed in the Bet box
    function updateBetBox() {
        const betBox = document.getElementById('bet-box');
        const betLabel = document.getElementById('bet-label');
        const betData = document.getElementById('bet-data');
        
        betBox.className = ''; // Clear existing classes
        
        if (betState === 'BET') {
            betBox.classList.add('green');
            betLabel.textContent = 'Bet';
            betData.textContent = currentStake.toFixed(2);
        } else if (betState === 'CANCEL') {
            betBox.classList.add('red');
            betLabel.textContent = 'Cancel';
            betData.textContent = 'Waiting for next round';
        } else if (betState === 'CASHOUT') {
            betBox.classList.add('yellow');
            betLabel.textContent = 'Cash Out';
            // Live calculation: Stake * Live Multiplier
            const winnings = currentStake * liveMultiplier;
            betData.textContent = winnings.toFixed(2); 
        }
    }
    
    function updateStakeBox() {
        const stakeInput = document.getElementById('stake-amount');
        const newStake = parseFloat(stakeInput.value);
        
        if (isNaN(newStake) || newStake <= 0) {
            currentStake = 0;
            stakeInput.value = 1; // Default back to 1
        } else if (newStake > currentBalance) {
            currentStake = currentBalance;
            stakeInput.value = currentBalance.toFixed(2);
        } else {
            currentStake = newStake;
        }
        
        // Update Bet box only if it's in the initial 'BET' state
        if (betState === 'BET') {
            updateBetBox();
        }
    }
    
    document.getElementById('stake-amount').addEventListener('input', updateStakeBox);
    
    function handleBetCashOut() {
        if (betState === 'BET') {
            placeBet();
        } else if (betState === 'CANCEL') {
            cancelBet();
        } else if (betState === 'CASHOUT') {
            cashOut();
        }
    }

    function placeBet() {
        if (currentStake <= 0) {
            alert("Please enter a valid stake amount.");
            return;
        }
        if (currentStake > currentBalance) {
            alert("Insufficient balance.");
            return;
        }
        
        isBetPlaced = true;
        
        if (isRoundActive) {
            // Bet placed during an ongoing round
            betState = 'CANCEL';
            updateBetBox();
        } else {
            // Bet placed during countdown/waiting
            betState = 'CANCEL';
            updateBetBox();
        }
    }
    
    function cancelBet() {
        // Only allowed in 'CANCEL' state (during countdown or ongoing round)
        if (betState === 'CANCEL') {
            isBetPlaced = false;
            betState = 'BET';
            updateBetBox();
        }
    }
    
    function cashOut() {
        if (betState === 'CASHOUT' && isRoundActive) {
            const winnings = currentStake * liveMultiplier;
            currentBalance += winnings;
            usersDB[currentUser].balance = currentBalance;
            saveUsers();
            updateBalanceDisplay();

            // Save multiplier to history
            addMultiplierToHistory(liveMultiplier);

            // End of player's involvement in this round
            isBetPlaced = false;
            betState = 'BET';
            updateBetBox();
            
            // Disable cashout until next round
            document.getElementById('bet-box').onclick = null;
            setTimeout(() => {
                document.getElementById('bet-box').onclick = handleBetCashOut;
            }, 500); // Small delay to prevent double click
        }
    }
    
    function addMultiplierToHistory(multiplier) {
        const historyDiv = document.getElementById('past-multipliers');
        const chip = document.createElement('div');
        chip.classList.add('multiplier-chip');
        chip.textContent = `x${multiplier.toFixed(2)}`;
        
        // Color code based on multiplier value
        if (multiplier < 2.00) {
            chip.style.backgroundColor = 'lightgray';
            chip.style.color = 'black';
        } else if (multiplier < 5.00) {
            chip.style.backgroundColor = '#4CAF50'; // Green
        } else {
            chip.style.backgroundColor = '#f44336'; // Red for high
        }
        
        historyDiv.insertBefore(chip, historyDiv.firstChild);
        
        // Keep only the past 10 multipliers
        while (historyDiv.children.length > 10) {
            historyDiv.removeChild(historyDiv.lastChild);
        }
        usersDB[currentUser].history.unshift(multiplier);
        usersDB[currentUser].history = usersDB[currentUser].history.slice(0, 10);
        saveUsers();
    }


    // --- Game Loop (B) ---
    
    function startNextRoundCountdown() {
        // Clear previous intervals
        clearInterval(roundTimer);
        cancelAnimationFrame(animationFrameId);
        isRoundActive = false;
        
        countdown = 5;
        liveMultiplier = 1.00;
        document.getElementById('live-multiplier').textContent = `NEXT ROUND: ${countdown}s`;
        
        betState = isBetPlaced ? 'CANCEL' : 'BET';
        updateBetBox();

        roundTimer = setInterval(() => {
            countdown--;
            if (countdown <= 0) {
                clearInterval(roundTimer);
                startRound();
            } else {
                document.getElementById('live-multiplier').textContent = `NEXT ROUND: ${countdown}s`;
            }
        }, 1000);
    }
    
    function startRound() {
        generatedMultiplier = generateDailyMultiplier();
        isRoundActive = true;
        startTime = performance.now();
        
        // Handle successful stake logic
        if (isBetPlaced) {
            // Deduction of stake from balance happens NOW (Start of the round)
            currentBalance -= currentStake;
            usersDB[currentUser].balance = currentBalance;
            saveUsers();
            updateBalanceDisplay();
            
            betState = 'CASHOUT';
            // isBetPlaced remains true to track if the player is in the round
        } else {
            betState = 'BET'; // Reset to BET if no bet was placed
        }
        
        updateBetBox();
        
        animatePlane();
    }
    
    function roundBurst() {
        isRoundActive = false;
        
        // Save multiplier to history (the burst value)
        addMultiplierToHistory(generatedMultiplier);

        if (isBetPlaced) {
            // Player lost the bet
            alert(`BUSTED at x${generatedMultiplier.toFixed(2)}! You lost ${currentStake.toFixed(2)}.`);
            isBetPlaced = false;
        }

        document.getElementById('live-multiplier').textContent = `BUSTED! x${generatedMultiplier.toFixed(2)}`;
        document.getElementById('plane').style.display = 'none'; // Hide plane on burst
        
        betState = 'BET'; // Reset bet state
        updateBetBox();

        // Start countdown for the next round
        setTimeout(startNextRoundCountdown, 5000); // 5 seconds waiting time
    }
    
    function animatePlane(timestamp) {
        if (!isRoundActive) return;
        
        if (startTime === 0) startTime = timestamp;
        const elapsed = (timestamp - startTime) / 1000; // seconds
        
        // Live Multiplier calculation based on elapsed time
        // A simple, non-linear growth function
        liveMultiplier = 1 + Math.pow(elapsed * 0.5, 2); 
        
        if (liveMultiplier >= generatedMultiplier) {
            // Burst point reached
            liveMultiplier = generatedMultiplier; // Cap it at the generated value
            roundBurst();
            return;
        }

        // --- Plane Movement Logic ---
        const plane = document.getElementById('plane');
        const multiplierText = document.getElementById('live-multiplier');

        // Stage 1: Diagonal movement (up to 3/4 of the diagonal path)
        const maxDiagonalTime = Math.log(generatedMultiplier) * 0.5; // Estimate time to reach a point
        const totalDuration = Math.log(generatedMultiplier) * 1.5;

        // Use progress towards the burst for movement calculation
        const progress = elapsed / totalDuration;
        
        let x, y;

        if (progress < 0.75) { // 3/4 of the conceptual total path duration
            // Diagonal movement: x and y increase linearly with elapsed time
            const diagonalProgress = elapsed / (totalDuration * 0.75); // 0 to 1 for diagonal phase
            x = PLANE_START_X + (CANVAS_WIDTH - PLANE_START_X) * diagonalProgress * 0.75; 
            y = PLANE_START_Y - (CANVAS_HEIGHT - (CANVAS_HEIGHT - PLANE_START_Y)) * diagonalProgress * 0.75;
        } else {
            // Stage 2: Smooth up and down motion
            const waveTime = elapsed - (totalDuration * 0.75);
            const waveAmplitude = 5; 
            const waveFrequency = 5;
            
            // Continue the general diagonal path from the 3/4 mark
            const baseProgress = 0.75; 
            x = PLANE_START_X + (CANVAS_WIDTH - PLANE_START_X) * baseProgress + (CANVAS_WIDTH - PLANE_START_X) * (progress - 0.75) * 0.25;
            y = PLANE_START_Y - (CANVAS_HEIGHT - (CANVAS_HEIGHT - PLANE_START_Y)) * baseProgress - (CANVAS_HEIGHT - (CANVAS_HEIGHT - PLANE_START_Y)) * (progress - 0.75) * 0.25;
            
            // Add the wave motion to the Y-coordinate
            y += Math.sin(waveTime * waveFrequency) * waveAmplitude;
        }
        
        // Ensure plane stays visible and on the path
        x = Math.min(Math.max(x, PLANE_START_X), CANVAS_WIDTH - 5);
        y = Math.min(Math.max(y, 5), PLANE_START_Y); 

        plane.style.left = `${x}%`;
        plane.style.top = `${y}%`;
        plane.style.display = 'block';

        // Update Multiplier Display
        multiplierText.textContent = `x${liveMultiplier.toFixed(2)}`;
        
        // Update Cash Out Winnings
        if (betState === 'CASHOUT') {
            updateBetBox();
        }
        
        animationFrameId = requestAnimationFrame(animatePlane);
    }
    
    // --- Initial Load Logic ---
    window.onload = function() {
        // Check if user should be logged in based on local storage (simulated "save password")
        const savedPhone = localStorage.getItem('aviator_saved_phone');
        if (savedPhone && usersDB[savedPhone]) {
            currentUser = savedPhone;
            currentBalance = usersDB[savedPhone].balance;
            updateBalanceDisplay();
            showGameScreen();
        } else {
            showAuthMain();
        }
    };

    // Global listener for app/link visits (simulated)
    document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden' && currentUser) {
            // Simulate log out on leaving the app/tab
            // logOut(); // Uncomment this line to enforce strict re-login
        }
    });

</script>

</body>
</html>
