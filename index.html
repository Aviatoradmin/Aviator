<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Game Simulation</title>
    <style>
        /* --- CSS Styling (style.css content merged here) --- */
        body {
            margin: 0;
            font-family: sans-serif;
            color: white;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #111; /* Ensure body is dark */
        }

        #app-container {
            width: 100%;
            max-width: 450px; /* Common phone width constraint */
            height: 100vh;
            box-sizing: border-box;
            position: relative; /* For the absolute popup */
        }

        /* --- Auth Screen Styling (A) --- */
        .blue-bg {
            background-color: #007bff; /* Blue for login screen */
            height: 100%;
            padding: 20px;
            box-sizing: border-box;
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .white-text {
            color: white;
        }

        #auth-buttons button {
            padding: 10px 20px;
            margin: 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        .auth-form input[type="number"], .auth-form input[type="password"] {
            width: 90%;
            padding: 10px;
            margin-bottom: 15px;
            border: none;
            border-radius: 5px;
            box-sizing: border-box;
        }

        .auth-form button {
            width: 90%;
            padding: 10px;
            background-color: #28a745; /* Green button */
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }

        .password-container {
            position: relative;
            width: 90%;
            margin: 0 auto 15px;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #333; /* Darker text for visibility */
            font-size: 0.8em;
        }

        /* --- Game Screen Styling (B) --- */
        .black-bg {
            background-color: black;
            height: 100%;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .top-bar, .bottom-bar {
            display: flex;
            justify-content: space-between;
            width: 100%;
            padding: 5px 0;
        }

        .game-box {
            padding: 10px;
            border-radius: 5px;
            text-align: center;
            font-weight: bold;
            flex-grow: 1;
            margin: 0 5px;
            min-width: 45%;
        }

        #withdraw-box {
            background-color: yellow;
            color: black;
            cursor: pointer;
        }

        #balance-box {
            background-color: green;
            color: white;
        }

        #past-multipliers {
            width: 100%;
            height: 40px;
            background-color: #222;
            margin-bottom: 5px;
            padding: 5px;
            overflow-x: auto;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: flex-start;
        }

        .multiplier {
            padding: 3px 6px;
            border-radius: 3px;
            margin-right: 5px;
            font-size: 0.8em;
            color: white;
            flex-shrink: 0;
        }

        /* --- Plane Area (B.ii) --- */
        #plane-container {
            flex-grow: 1; 
            position: relative;
            overflow: hidden;
            height: 50%; 
            background-color: #111; 
            border-radius: 5px;
            margin-bottom: 5px;
        }

        #aviator-plane {
            position: absolute;
            width: 25px;
            height: 25px;
            background-color: red;
            border-radius: 50%; 
            bottom: 0;
            left: 0;
            transform: translate(0, 0); 
        }

        #live-multiplier-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2em;
            font-weight: bold;
            color: white;
            display: none; 
        }

        /* --- Bottom Bar (B.vi, B.vii) --- */
        .betting-controls {
            display: flex;
            width: 100%;
            justify-content: space-between;
            margin-top: 5px;
        }

        #stake-box {
            background-color: #333;
            color: white;
            padding: 10px;
            border-radius: 5px;
            width: 40%;
        }

        #stake-amount {
            width: 100%;
            padding: 5px;
            box-sizing: border-box;
            margin-top: 5px;
            border: none;
            border-radius: 3px;
            text-align: center;
        }

        #bet-bar {
            width: 55%;
            height: auto;
            min-height: 50px;
            background-color: green;
            color: white;
            padding: 5px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1.2em;
            text-align: center;
        }

        .bet-label {
            font-size: 0.8em;
            margin-bottom: 3px;
        }

        .bet-data {
            font-size: 1.5em;
            font-weight: bold;
        }

        /* Bet states */
        .yellow-cashout {
            background-color: yellow !important;
            color: black !important;
        }

        .red-cancel {
            background-color: red !important;
            color: white !important;
        }

        /* Withdrawal Pop-up (Simulated) */
        #withdrawal-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #333;
            padding: 20px;
            border-radius: 8px;
            z-index: 100;
            display: none;
            color: white;
            text-align: center;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            width: 80%;
        }
        #withdraw-input {
            padding: 10px;
            margin: 10px 0;
            width: 100px;
            border-radius: 5px;
            text-align: center;
        }
        #proceed-btn {
            padding: 10px;
            background-color: blue;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app-container">
        <div id="auth-screen" class="blue-bg">
            <h1 class="white-text">Aviator</h1>
            <div id="auth-buttons">
                <button onclick="showAuthForm('create')">Create Account</button>
                <button onclick="showAuthForm('login')">Log In</button>
            </div>

            <div id="create-account-form" class="auth-form" style="display: none;">
                <input type="number" id="signup-phone" placeholder="1. Enter Phone Number">
                <div class="password-container">
                    <input type="password" id="signup-password" placeholder="2. Enter Password">
                    <span class="toggle-password" onclick="togglePasswordVisibility('signup-password')">Show</span>
                </div>
                <div class="password-container">
                    <input type="password" id="confirm-password" placeholder="3. Confirm Password">
                    <span class="toggle-password" onclick="togglePasswordVisibility('confirm-password')">Show</span>
                </div>
                <label><input type="checkbox" id="save-password-signup"> Save Password (Optional)</label>
                <button onclick="createAccount()">Create & Play</button>
            </div>

            <div id="login-form" class="auth-form" style="display: none;">
                <input type="number" id="login-phone" placeholder="Phone Number">
                <div class="password-container">
                    <input type="password" id="login-password" placeholder="Password">
                    <span class="toggle-password" onclick="togglePasswordVisibility('login-password')">Show</span>
                </div>
                <label><input type="checkbox" id="save-password-login"> Save Password (Optional)</label>
                <button onclick="loginAccount()">Log In & Play</button>
            </div>
            <p id="auth-message" class="white-text"></p>
        </div>

        <div id="game-screen" class="black-bg" style="display: none;">
            <div class="top-bar">
                <div id="withdraw-box" class="game-box" onclick="showWithdrawalPopup()">
                    Withdrawal
                </div>
                <div id="balance-box" class="game-box">
                    Balance: <span id="current-balance">1000</span>
                </div>
            </div>

            <div id="past-multipliers">
                </div>

            <div id="plane-container">
                <div id="aviator-plane" style="display:none;"></div>
                <div id="live-multiplier-display"></div>
            </div>

            <div class="betting-controls">
                <div id="stake-box">
                    Stake
                    <input type="number" id="stake-amount" value="10" min="1" oninput="updateBetBar()">
                </div>
                <div id="bet-bar" onclick="handleBetAction()">
                    <div class="bet-label" id="bet-label">BET</div>
                    <div class="bet-data" id="bet-display">10</div>
                </div>
            </div>
            <button onclick="logout()" style="background: red; color: white; padding: 5px; margin-top: 10px; border: none; border-radius: 3px;">LOG OUT</button>

            <div id="withdrawal-popup">
                <p>Enter Amount to Withdraw</p>
                <input type="number" id="withdraw-input" max="1000" placeholder="Amount">
                <button id="proceed-btn" onclick="processWithdrawal()">Proceed</button>
            </div>
        </div>
    </div>

    <script>
        // --- JavaScript Logic (script.js content merged here) ---
        // --- Global Game Variables ---
        let currentBalance = 1000; // Default for new users
        let stakeAmount = 10;
        let isGameRunning = false;
        let isBetPlaced = false;
        let isWaitingNextRound = false;
        let roundStartTime;
        let animationFrameId;
        let gameInterval;
        let planeBurstMultiplier = 1.0;
        let currentMultiplier = 1.0;

        // --- DOM Elements ---
        const balanceEl = document.getElementById('current-balance');
        const betBarEl = document.getElementById('bet-bar');
        const betLabelEl = document.getElementById('bet-label');
        const betDisplayEl = document.getElementById('bet-display');
        const stakeInputEl = document.getElementById('stake-amount');
        const planeEl = document.getElementById('aviator-plane');
        const multiplierDisplayEl = document.getElementById('live-multiplier-display');
        const planeContainer = document.getElementById('plane-container');
        const authMessageEl = document.getElementById('auth-message');

        // --- Initialization ---
        function init() {
            // Check local storage for existing user data/balance
            const storedUser = localStorage.getItem('aviatorUser');
            if (storedUser) {
                // If a user was previously logged in, try to auto-load their data
                const user = JSON.parse(storedUser);
                currentBalance = user.balance;
                document.getElementById('auth-screen').style.display = 'none';
                document.getElementById('game-screen').style.display = 'flex';
                initGame();
            } else {
                 document.getElementById('auth-screen').style.display = 'flex';
                 document.getElementById('game-screen').style.display = 'none';
                 showAuthForm('login');
            }
            updateUI();
        }

        function updateUI() {
            balanceEl.textContent = currentBalance.toFixed(2);
            stakeAmount = parseFloat(stakeInputEl.value) || 0;
            if (!isBetPlaced) {
                betDisplayEl.textContent = stakeAmount.toFixed(2);
            }
            document.getElementById('withdraw-input').max = currentBalance;
        }

        // --- Account and Login Logic (A) ---

        function showAuthForm(type) {
            document.querySelectorAll('.auth-form').forEach(form => form.style.display = 'none');
            if (type === 'create') {
                document.getElementById('create-account-form').style.display = 'block';
            } else if (type === 'login') {
                document.getElementById('login-form').style.display = 'block';
            }
            authMessageEl.textContent = '';
        }

        function togglePasswordVisibility(id) {
            const input = document.getElementById(id);
            const span = input.nextElementSibling;
            if (input.type === 'password') {
                input.type = 'text';
                span.textContent = 'Hide';
            } else {
                input.type = 'password';
                span.textContent = 'Show';
            }
        }

        function createAccount() {
            const phone = document.getElementById('signup-phone').value;
            const password = document.getElementById('signup-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (!phone || !password || !confirmPassword) {
                authMessageEl.textContent = "All fields are required.";
                return;
            }
            if (password !== confirmPassword) {
                authMessageEl.textContent = "Passwords do not match.";
                return;
            }
            if (localStorage.getItem(phone)) {
                authMessageEl.textContent = "Account with this phone number already exists.";
                return;
            }

            const newUser = { phone, password, balance: 1000 };
            localStorage.setItem(phone, JSON.stringify(newUser));
            localStorage.setItem('aviatorUser', JSON.stringify(newUser)); // Set as currently logged-in user
            currentBalance = 1000;
            
            // Redirect to Game (B)
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            initGame();
        }

        function loginAccount() {
            const phone = document.getElementById('login-phone').value;
            const password = document.getElementById('login-password').value;
            const userData = JSON.parse(localStorage.getItem(phone));

            if (!userData) {
                authMessageEl.textContent = "Account not found. Please create an account.";
                return;
            }
            if (userData.password !== password) {
                authMessageEl.textContent = "Incorrect password.";
                return;
            }

            // Login successful
            localStorage.setItem('aviatorUser', JSON.stringify(userData)); // Set as currently logged-in user
            currentBalance = userData.balance;

            // Redirect to Game (B)
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            initGame();
        }

        function logout() {
            localStorage.removeItem('aviatorUser');
            clearInterval(gameInterval); // Stop game logic
            cancelAnimationFrame(animationFrameId); // Stop plane animation
            document.getElementById('game-screen').style.display = 'none';
            document.getElementById('auth-screen').style.display = 'flex';
            showAuthForm('login'); 
            
            // Reset game state
            isGameRunning = false;
            isBetPlaced = false;
            isWaitingNextRound = false;
            planeEl.style.display = 'none';
            multiplierDisplayEl.style.display = 'none';
        }

        // --- Withdrawal Logic ---

        function showWithdrawalPopup() {
            document.getElementById('withdraw-input').value = '';
            document.getElementById('withdraw-input').max = currentBalance;
            document.getElementById('withdrawal-popup').style.display = 'block';
        }

        function processWithdrawal() {
            const amount = parseFloat(document.getElementById('withdraw-input').value);
            const balance = currentBalance;
            const proceedBtn = document.getElementById('proceed-btn');

            if (isNaN(amount) || amount <= 0 || amount > balance) {
                alert(`Invalid amount. Cannot withdraw more than ${balance.toFixed(2)}.`);
                return;
            }

            // Deduction
            currentBalance -= amount;
            // Update stored balance
            const user = JSON.parse(localStorage.getItem('aviatorUser'));
            user.balance = currentBalance;
            localStorage.setItem(user.phone, JSON.stringify(user));
            localStorage.setItem('aviatorUser', JSON.stringify(user));

            updateUI();
            
            // UI Feedback
            proceedBtn.textContent = 'SUBMITTED';
            proceedBtn.style.backgroundColor = '#28a745'; // Green for submitted
            
            setTimeout(() => {
                document.getElementById('withdrawal-popup').style.display = 'none';
                proceedBtn.textContent = 'Proceed';
                proceedBtn.style.backgroundColor = 'blue';
                // alert(`Successfully withdrew ${amount.toFixed(2)}`); // Final confirmation
            }, 1500);
        }


        // --- Game Logic (B) ---

        function initGame() {
            updateUI();
            if (!gameInterval) {
                gameInterval = setInterval(startNewRound, 5000); // 5 seconds between rounds
            }
            requestAnimationFrame(animatePlane); 
            startNewRound(true); // Start the first round immediately without 5s wait
        }

        function generateBurstMultiplier() {
            // Client-side simulation of generated multiplier
            const random = Math.random();
            let multiplier;
            if (random < 0.3) {
                multiplier = Math.random() * (2.0 - 1.01) + 1.01; 
            } else if (random < 0.8) {
                multiplier = Math.random() * (5.0 - 2.0) + 2.0; 
            } else {
                multiplier = Math.random() * (15.0 - 5.0) + 5.0; 
            }
            return parseFloat(multiplier.toFixed(2));
        }

        function startNewRound(isInitial = false) {
            if (isGameRunning) return;

            planeBurstMultiplier = generateBurstMultiplier();
            currentMultiplier = 1.00;
            isGameRunning = false;
            isWaitingNextRound = false;
            
            planeEl.style.display = 'none';
            planeEl.style.transform = `translate(0px, 0px)`;
            
            // Handle bet from waiting list
            if (isBetPlaced && betLabelEl.textContent === 'WAITING FOR NEXT ROUND') {
                // Successful stake for the next round
                betBarEl.classList.remove('red-cancel');
                betLabelEl.textContent = 'Cash Out';
                
                // Deduction happens immediately at start of the round
                currentBalance -= stakeAmount;
                updateUI();
                
                isWaitingNextRound = false;
                
                playRound();
                return; 
            }
            
            // Start 5-second countdown
            let countdown = 5;
            multiplierDisplayEl.style.display = 'block';
            multiplierDisplayEl.textContent = isInitial ? 'Starting...' : `Next Round in ${countdown}s`;
            
            if (isInitial) {
                // Skip countdown on initial load
                setTimeout(playRound, 1000); 
                return;
            }

            // Countdown loop
            const countdownInterval = setInterval(() => {
                countdown--;
                multiplierDisplayEl.textContent = `Next Round in ${countdown}s`;
                if (countdown <= 0) {
                    clearInterval(countdownInterval);
                    playRound();
                }
            }, 1000);

            // Reset UI state for a fresh round
            betBarEl.classList.remove('yellow-cashout', 'red-cancel');
            if (!isBetPlaced) {
                 betLabelEl.textContent = 'BET';
                 betDisplayEl.textContent = stakeAmount.toFixed(2);
            }
        }

        function playRound() {
            isGameRunning = true;
            roundStartTime = Date.now();
            planeEl.style.display = 'block';
            
            if (isBetPlaced && betLabelEl.textContent === 'BET') {
                // Successful stake deduction happens here if it's a direct bet
                currentBalance -= stakeAmount;
                updateUI();
                betLabelEl.textContent = 'Cash Out';
                betBarEl.classList.add('yellow-cashout');
                betDisplayEl.textContent = (stakeAmount * 1.00).toFixed(2);
            } 
            
            multiplierDisplayEl.style.color = 'white';
            multiplierDisplayEl.textContent = `×1.00`;
        }

        function handleBetAction() {
            if (betLabelEl.textContent === 'BET') {
                // 1. Placing a Bet
                if (stakeAmount <= 0) {
                    authMessageEl.textContent = "Stake amount must be greater than 0.";
                    setTimeout(() => authMessageEl.textContent = '', 2000);
                    return;
                }
                if (stakeAmount > currentBalance) {
                    authMessageEl.textContent = "Insufficient balance.";
                    setTimeout(() => authMessageEl.textContent = '', 2000);
                    return;
                }
                
                isBetPlaced = true;
                
                if (isGameRunning) {
                    // Bet placed during ongoing round
                    betBarEl.classList.add('red-cancel');
                    betLabelEl.textContent = 'CANCEL';
                    betDisplayEl.textContent = 'Waiting for next round';
                    isWaitingNextRound = true;
                } else {
                    // Bet placed during 5-second countdown
                    betBarEl.classList.add('red-cancel');
                    betLabelEl.textContent = 'CANCEL';
                    betDisplayEl.textContent = 'Waiting for next round';
                    isWaitingNextRound = true;
                    // Deduction will occur when playRound() is called
                }
                
            } else if (betLabelEl.textContent === 'Cash Out') {
                // 2. Cashing Out
                if (!isGameRunning) return;

                const winnings = parseFloat(betDisplayEl.textContent);
                currentBalance += winnings;
                
                // Update stored balance
                const user = JSON.parse(localStorage.getItem('aviatorUser'));
                user.balance = currentBalance;
                localStorage.setItem(user.phone, JSON.stringify(user));
                localStorage.setItem('aviatorUser', JSON.stringify(user));

                isBetPlaced = false;
                betBarEl.classList.remove('yellow-cashout');
                betLabelEl.textContent = 'BET';
                updateUI();
                
                // Visually show cash out multiplier on past list
                addPastMultiplier(currentMultiplier, true);
                
                // Reset bet display
                betDisplayEl.textContent = stakeAmount.toFixed(2);
                
            } else if (betLabelEl.textContent === 'CANCEL') {
                // 3. Cancelling a Bet
                if (isWaitingNextRound) {
                    // Player successfully withdrawn
                    isBetPlaced = false;
                    isWaitingNextRound = false;
                    betBarEl.classList.remove('red-cancel');
                    betLabelEl.textContent = 'BET';
                    updateUI();
                }
            }
        }

        function animatePlane(timestamp) {
            if (isGameRunning) {
                const timeElapsed = (Date.now() - roundStartTime) / 1000;
                
                // Calculate Live Multiplier (simulated smooth acceleration)
                // y = 1 + x^2 * k 
                currentMultiplier = 1 + timeElapsed * timeElapsed * 0.15;
                
                if (currentMultiplier >= planeBurstMultiplier) {
                    // Burst Logic
                    isGameRunning = false;
                    multiplierDisplayEl.textContent = `BURST! ${planeBurstMultiplier.toFixed(2)}x`;
                    multiplierDisplayEl.style.color = 'red';
                    
                    // Losing Logic
                    if (isBetPlaced && betLabelEl.textContent === 'Cash Out') {
                        // Bet was placed but not cashed out, player loses stake (already deducted)
                        // Stake is automatically lost
                    }
                    
                    // Reset Bet UI
                    isBetPlaced = false;
                    betBarEl.classList.remove('yellow-cashout', 'red-cancel');
                    betLabelEl.textContent = 'BET';
                    betDisplayEl.textContent = stakeAmount.toFixed(2);
                    
                    addPastMultiplier(planeBurstMultiplier, false);
                    
                    planeEl.style.display = 'none';
                    return; 
                }

                // --- Plane Movement Calculation ---
                const containerWidth = planeContainer.offsetWidth;
                const containerHeight = planeContainer.offsetHeight;
                
                // Max diagonal travel point (3/4 of container height/width)
                const diagonalTarget = Math.min(containerWidth, containerHeight) * 0.75;
                
                // Time factor for movement (adjust this constant to control speed)
                const moveFactor = timeElapsed * 0.5; 
                
                let x, y;
                
                if (currentMultiplier < 4.0) { 
                    // Stage 1: Diagonal movement (increasing speed, smooth curve)
                    x = diagonalTarget * Math.min(1, moveFactor);
                    y = containerHeight - (containerHeight * 0.05) - (diagonalTarget * Math.min(1, moveFactor)); 
                } else {
                    // Stage 2: Wave motion (Starts after hitting 75% point, continues upward-right trend)
                    const baseTime = 3.0; 
                    const waveTime = timeElapsed - baseTime;
                    
                    // x continues to creep right (increasing increment)
                    x = diagonalTarget + (waveTime * 30); 
                    
                    // y moves in a smooth wave motion (y reduce with increasing reduction when moving down, y increase with increasing increment when moving up)
                    const waveAmplitude = containerHeight * 0.1; 
                    const waveFrequency = 5; 
                    const baseHeight = containerHeight * 0.25; // 3/4 up the container

                    // Wave motion on top of base height
                    y = baseHeight - (waveAmplitude * Math.sin(waveTime * waveFrequency));
                }
                
                // Ensure plane stays within bounds
                x = Math.min(x, containerWidth - planeEl.offsetWidth);
                y = Math.max(0, y); // Cannot go below y=0

                planeEl.style.transform = `translate(${x}px, ${y}px)`;
                multiplierDisplayEl.style.transform = `translate(${x + 15}px, ${y - 20}px)`; // Display flies with plane

                // Update Multiplier Display
                multiplierDisplayEl.textContent = `×${currentMultiplier.toFixed(2)}`;
                
                // Update Cash Out Winnings (if bet is active)
                if (isBetPlaced && betLabelEl.textContent === 'Cash Out') {
                    const winnings = stakeAmount * currentMultiplier;
                    betDisplayEl.textContent = winnings.toFixed(2);
                }
            }
            
            animationFrameId = requestAnimationFrame(animatePlane);
        }

        function addPastMultiplier(value, cashedOut) {
            const pastEl = document.getElementById('past-multipliers');
            const chip = document.createElement('div');
            chip.className = 'multiplier';
            chip.textContent = `${value.toFixed(2)}x`;
            
            // Color coding
            if (cashedOut) {
                chip.style.backgroundColor = 'blue'; 
            } else if (value < 2.0) {
                chip.style.backgroundColor = 'gray'; 
            } else if (value < 5.0) {
                chip.style.backgroundColor = 'green';
            } else {
                chip.style.backgroundColor = 'purple'; 
            }
            
            pastEl.prepend(chip); 
            
            // Keep only the last 10
            while (pastEl.children.length > 10) {
                pastEl.removeChild(pastEl.lastChild);
            }
        }

        function updateBetBar() {
            stakeAmount = parseFloat(stakeInputEl.value) || 0;
            if (!isBetPlaced) {
                betDisplayEl.textContent = stakeAmount.toFixed(2);
            }
        }

        // Start the application when the script loads
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
