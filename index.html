<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator Simulation</title>
    <style>
        /* --- General Mobile Styling --- */
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            width: 100%;
            max-width: 450px; /* Typical phone width */
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- Login/Create Account Screen (A) --- */
        #auth-screen {
            background-color: #1a1a1a;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
        }

        .auth-toggle {
            display: flex;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .auth-toggle button {
            flex: 1;
            padding: 15px;
            background-color: #000;
            color: #fff;
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .auth-toggle button.active {
            background-color: #007bff; /* Blue for active login */
        }

        #auth-screen input {
            padding: 15px;
            border: 1px solid #333;
            border-radius: 8px;
            background-color: #2c2c2c;
            color: #fff;
            font-size: 16px;
        }

        .password-container {
            position: relative;
        }

        .password-container .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #999;
            cursor: pointer;
            user-select: none;
        }

        #auth-screen button.submit-btn {
            padding: 15px;
            background-color: #28a745; /* Green */
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 20px;
        }

        /* --- Game Screen (B) --- */
        #game-screen {
            display: none;
            flex-direction: column;
            flex-grow: 1;
        }

        /* Top Bar: Withdraw & Balance */
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            height: 10%; /* 0.25 part of the top area is shared */
            max-height: 50px;
        }

        .top-bar-box {
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            text-align: center;
            min-width: 100px;
            cursor: pointer;
            font-size: 14px;
        }

        #withdraw-bar {
            background-color: #ffc107; /* Yellow */
            color: #000;
            position: relative;
        }

        #balance-bar {
            background-color: #28a745; /* Green */
            color: #fff;
        }

        /* Withdraw Modal within the bar */
        #withdraw-bar.active {
            flex-direction: column;
            height: auto;
            min-height: 50px;
            padding: 5px;
        }

        .withdraw-input-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
            width: 100%;
        }

        #withdraw-amount-input {
            width: 100%;
            padding: 5px;
            border-radius: 4px;
            border: none;
            text-align: center;
        }

        #proceed-btn {
            background-color: #007bff; /* Blue */
            color: #fff;
            padding: 5px;
            border-radius: 4px;
            font-size: 12px;
            margin-top: 5px;
        }
        
        /* Aviator Plane Area */
        #aviator-area {
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            background-color: #0e0e0e;
            overflow: hidden;
            height: 50%; /* Middle half of the screen */
        }

        #live-multiplier {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 4em;
            font-weight: bold;
            color: #fff;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
            transition: font-size 0.5s;
            z-index: 10;
        }

        #plane {
            position: absolute;
            font-size: 2em;
            color: #ff0000; /* Red Plane */
            transition: all 0.05s linear; /* Smooth visual movement */
            z-index: 5;
        }

        #plane.hidden, #live-multiplier.hidden {
            display: none;
        }

        .waiting-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.5em;
            color: #ccc;
            z-index: 1;
        }
        
        /* Bottom Bar: Past Multipliers & Bet Controls */
        .bottom-controls {
            display: flex;
            flex-direction: column;
            height: 35%;
        }

        /* Past Multipliers Bar */
        #past-multipliers {
            padding: 5px 0;
            background-color: #1a1a1a;
            display: flex;
            gap: 5px;
            justify-content: flex-start;
            overflow-x: auto;
            white-space: nowrap;
            height: 5%;
        }

        .multiplier-chip {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: #fff;
        }

        .m-low { background-color: #555; }
        .m-mid { background-color: #007bff; }
        .m-high { background-color: #28a745; }

        /* Stake and Bet/Cashout Buttons */
        .bet-area {
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            padding: 10px 5px;
            flex-grow: 1;
            gap: 10px;
        }

        .bet-box {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            flex: 1;
            height: 100px;
        }

        #stake-box {
            background-color: #1a1a1a;
            color: #fff;
            flex: 0.8;
        }

        #stake-input {
            width: 90%;
            padding: 10px;
            margin-top: 5px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #2c2c2c;
            color: #fff;
            text-align: center;
        }

        #bet-bar {
            background-color: #28a745; /* Green (Default Bet) */
            color: #fff;
            flex: 1.2;
            justify-content: space-between;
            transition: background-color 0.3s;
        }

        .bet-bar-main-text {
            font-size: 1.8em;
            font-weight: bold;
        }

        .bet-bar-sub-text {
            font-size: 1em;
            font-weight: normal;
        }

        /* State Styles for Bet Button */
        .bet-bar-cashout {
            background-color: #ffc107 !important; /* Yellow (Cash Out) */
            color: #000 !important;
        }

        .bet-bar-cancel {
            background-color: #dc3545 !important; /* Red (Cancel/Waiting) */
        }
    </style>
</head>
<body>

<div class="container">
    <div id="auth-screen">
        <h2>Aviator</h2>
        <div class="auth-toggle">
            <button id="login-btn-toggle" class="active">Log In</button>
            <button id="create-btn-toggle">Create Account</button>
        </div>

        <div id="login-form">
            <input type="tel" id="login-phone" placeholder="Phone Number" required>
            <div class="password-container">
                <input type="password" id="login-password" placeholder="Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('login-password')">Show</span>
            </div>
            <button class="submit-btn" onclick="handleLogin()">Log In</button>
        </div>

        <div id="create-form" style="display: none;">
            <input type="tel" id="create-phone" placeholder="Phone Number" required>
            <div class="password-container">
                <input type="password" id="create-password" placeholder="Enter Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('create-password')">Show</span>
            </div>
            <div class="password-container">
                <input type="password" id="confirm-password" placeholder="Confirm Password" required>
                <span class="toggle-password" onclick="togglePasswordVisibility('confirm-password')">Show</span>
            </div>
            <p style="font-size: 0.8em; color: #aaa;">(Optional: Save Password to browser)</p>
            <button class="submit-btn" onclick="handleCreateAccount()">Create Account</button>
        </div>
        <p id="auth-message" style="color: yellow; text-align: center;"></p>
    </div>

    <div id="game-screen">
        <div class="top-bar">
            <div id="withdraw-bar" class="top-bar-box" onclick="toggleWithdrawInput()">
                <span id="withdraw-text">Withdraw</span>
            </div>
            <div id="balance-bar" class="top-bar-box">
                <span id="balance-value">1000</span>
            </div>
        </div>

        <div id="aviator-area">
            <div id="live-multiplier" class="hidden">X1.00</div>
            <div id="plane" class="hidden">✈️</div>
            <div class="waiting-text">Waiting for next round...</div>
        </div>

        <div class="bottom-controls">
            <div id="past-multipliers">
                </div>

            <div class="bet-area">
                <div id="stake-box" class="bet-box">
                    <span class="bet-bar-sub-text">Stake</span>
                    <input type="number" id="stake-input" value="100" min="1" oninput="updateBetDisplay(this.value)">
                </div>

                <div id="bet-bar" class="bet-box" onclick="handleBetAction()">
                    <span id="bet-main" class="bet-bar-main-text">Bet</span>
                    <span id="bet-sub" class="bet-bar-sub-text">100</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // --- Global State Variables ---
    let balance = 1000;
    let stakeAmount = 100;
    let users = {}; // Stores {phone: {password, balance}}
    let loggedInUser = null;
    let gameState = 'WAITING'; // WAITING, COUNTDOWN, FLYING, BURST
    let generatedMultiplier = 1.0;
    let currentMultiplier = 1.0;
    let currentBet = null; // {amount: number, timestamp: Date}
    let lastTime = 0;
    let animationFrameId = null;
    let pastMultipliers = [];

    const PLANE_SPEED = 0.0007; // Speed factor for multiplier growth
    const ROUND_COUNTDOWN = 5; // Seconds

    // --- A. Authentication Logic ---
    function togglePasswordVisibility(id) {
        const input = document.getElementById(id);
        const span = input.nextElementSibling;
        if (input.type === 'password') {
            input.type = 'text';
            span.textContent = 'Hide';
        } else {
            input.type = 'password';
            span.textContent = 'Show';
        }
    }

    document.getElementById('login-btn-toggle').onclick = () => {
        document.getElementById('login-form').style.display = 'flex';
        document.getElementById('create-form').style.display = 'none';
        document.getElementById('login-btn-toggle').classList.add('active');
        document.getElementById('create-btn-toggle').classList.remove('active');
        document.getElementById('auth-message').textContent = '';
    };

    document.getElementById('create-btn-toggle').onclick = () => {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('create-form').style.display = 'flex';
        document.getElementById('login-btn-toggle').classList.remove('active');
        document.getElementById('create-btn-toggle').classList.add('active');
        document.getElementById('auth-message').textContent = '';
    };

    function handleCreateAccount() {
        const phone = document.getElementById('create-phone').value.trim();
        const pass = document.getElementById('create-password').value;
        const confirmPass = document.getElementById('confirm-password').value;
        const msg = document.getElementById('auth-message');

        if (!phone || !pass || !confirmPass) {
            msg.textContent = 'Please fill all fields.';
            return;
        }
        if (pass !== confirmPass) {
            msg.textContent = 'Passwords do not match.';
            return;
        }
        if (users[phone]) {
            msg.textContent = 'Account already exists. Try logging in.';
            return;
        }

        users[phone] = { password: pass, balance: 1000 };
        loggedInUser = phone;
        balance = 1000;
        msg.textContent = `Account created for ${phone}. Default balance: 1000.`;
        setTimeout(showGameScreen, 1000);
    }

    function handleLogin() {
        const phone = document.getElementById('login-phone').value.trim();
        const pass = document.getElementById('login-password').value;
        const msg = document.getElementById('auth-message');

        if (!users[phone] || users[phone].password !== pass) {
            msg.textContent = 'Invalid phone number or password.';
            return;
        }

        loggedInUser = phone;
        balance = users[phone].balance;
        updateBalanceDisplay();
        msg.textContent = 'Login Successful!';
        setTimeout(showGameScreen, 1000);
    }

    function showGameScreen() {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        // Start the game loop on successful login
        if (!animationFrameId) {
            startGameLoop();
        }
    }

    // --- Game UI Updates ---
    function updateBalanceDisplay() {
        document.getElementById('balance-value').textContent = Math.floor(balance);
        users[loggedInUser].balance = balance;
    }

    function updateBetDisplay(newStake) {
        stakeAmount = parseFloat(newStake) || 0;
        document.getElementById('bet-sub').textContent = stakeAmount;
    }

    function updatePastMultipliers() {
        const container = document.getElementById('past-multipliers');
        container.innerHTML = '';
        pastMultipliers.slice(-10).forEach(m => {
            const chip = document.createElement('span');
            chip.className = 'multiplier-chip';
            chip.textContent = `X${m.toFixed(2)}`;
            if (m < 2.0) {
                chip.classList.add('m-low');
            } else if (m < 5.0) {
                chip.classList.add('m-mid');
            } else {
                chip.classList.add('m-high');
            }
            container.appendChild(chip);
        });
        container.scrollLeft = container.scrollWidth;
    }

    // --- Withdrawal Logic ---
    function toggleWithdrawInput() {
        const bar = document.getElementById('withdraw-bar');
        if (bar.classList.contains('active')) {
            // Close state
            bar.classList.remove('active');
            bar.innerHTML = `<span id="withdraw-text">Withdraw</span>`;
        } else {
            // Open state: Split into input and proceed
            bar.classList.add('active');
            bar.innerHTML = `
                <input type="number" id="withdraw-amount-input" placeholder="Amount" min="1" max="${balance}">
                <button id="proceed-btn" onclick="handleWithdraw()">Proceed</button>
            `;
        }
    }

    function handleWithdraw() {
        const input = document.getElementById('withdraw-amount-input');
        const bar = document.getElementById('withdraw-bar');
        const amount = parseFloat(input.value);

        if (isNaN(amount) || amount <= 0 || amount > balance) {
            bar.innerHTML = `<span id="withdraw-text">Invalid Amount</span>`;
            setTimeout(toggleWithdrawInput, 1500); // Revert after 1.5s
            return;
        }

        balance -= amount;
        updateBalanceDisplay();
        bar.innerHTML = `<span id="withdraw-text">SUBMITTED: ${amount}</span>`;
        setTimeout(toggleWithdrawInput, 1500); // Revert after 1.5s
    }

    // --- Game Logic: Betting & State Machine ---
    function updateBetBar() {
        const bar = document.getElementById('bet-bar');
        const mainText = document.getElementById('bet-main');
        const subText = document.getElementById('bet-sub');

        bar.className = 'bet-box'; // Reset classes

        if (gameState === 'FLYING' && currentBet && currentBet.status === 'IN_PLAY') {
            // Cash Out State
            bar.classList.add('bet-bar-cashout');
            mainText.textContent = 'Cash Out';
            subText.textContent = (currentBet.amount * currentMultiplier).toFixed(2); // Winnings
            bar.style.cursor = 'pointer';
        } else if (currentBet && currentBet.status === 'PENDING') {
            // Cancel/Waiting State
            bar.classList.add('bet-bar-cancel');
            mainText.textContent = 'Cancel';
            subText.textContent = 'Waiting for next round';
            bar.style.cursor = 'pointer';
        } else {
            // Bet State (Normal)
            bar.classList.add('bet-bar-bet');
            mainText.textContent = 'Bet';
            subText.textContent = stakeAmount;
            bar.style.cursor = 'pointer';
        }
    }

    function handleBetAction() {
        if (gameState === 'FLYING' && currentBet && currentBet.status === 'IN_PLAY') {
            // 1. Cash Out Action
            const winnings = currentBet.amount * currentMultiplier;
            balance += winnings;
            updateBalanceDisplay();

            currentBet.status = 'CASHED_OUT';
            currentBet.winnings = winnings;

            // Log success
            console.log(`CASH OUT: Won ${winnings.toFixed(2)} at X${currentMultiplier.toFixed(2)}`);

        } else if (currentBet && currentBet.status === 'PENDING') {
            // 2. Cancel Action
            currentBet = null;
            // No balance change needed, as deduction only happens when round starts
            console.log('CANCELLED Bet.');

        } else if (!currentBet && stakeAmount > 0 && stakeAmount <= balance) {
            // 3. Place Bet (for next round or current round if missed)
            currentBet = {
                amount: stakeAmount,
                status: 'PENDING'
            };
            console.log(`Bet of ${stakeAmount} placed. Waiting for start.`);
        }
        updateBetBar();
    }

    function startNewRound() {
        // Reset state for new round
        currentMultiplier = 1.0;
        gameState = 'COUNTDOWN';
        document.querySelector('.waiting-text').textContent = `NEXT ROUND IN ${ROUND_COUNTDOWN}s...`;
        document.getElementById('live-multiplier').classList.add('hidden');
        document.getElementById('plane').classList.add('hidden');

        // Generate the new burst point (Deterministic 'server-less' logic)
        generatedMultiplier = generateDeterministicMultiplier();
        console.log(`New Round. Burst at X${generatedMultiplier.toFixed(2)}`);

        // Start 5-second countdown
        let countdown = ROUND_COUNTDOWN;
        const countdownInterval = setInterval(() => {
            countdown--;
            document.querySelector('.waiting-text').textContent = `NEXT ROUND IN ${countdown}s...`;
            if (countdown <= 0) {
                clearInterval(countdownInterval);
                playRound();
            }
            updateBetBar(); // Allow Cancel/Pending to be visible during countdown
        }, 1000);
    }

    function playRound() {
        gameState = 'FLYING';
        document.querySelector('.waiting-text').textContent = '';
        document.getElementById('live-multiplier').classList.remove('hidden');
        document.getElementById('plane').classList.remove('hidden');

        // Check for PENDING bet and move it to IN_PLAY (deduct balance now)
        if (currentBet && currentBet.status === 'PENDING') {
            currentBet.status = 'IN_PLAY';
            balance -= currentBet.amount;
            updateBalanceDisplay();
            console.log(`Bet of ${currentBet.amount} is now IN PLAY. Balance deducted.`);
        }
        
        lastTime = performance.now();
        updateBetBar(); // Change to Cash Out or stay empty
    }

    function burstRound() {
        gameState = 'BURST';
        pastMultipliers.push(generatedMultiplier);
        updatePastMultipliers();
        document.getElementById('live-multiplier').textContent = `X${generatedMultiplier.toFixed(2)}`;
        document.querySelector('.waiting-text').textContent = `BURSTED AT X${generatedMultiplier.toFixed(2)}`;
        
        // Handle IN_PLAY bets that did not cash out
        if (currentBet && currentBet.status === 'IN_PLAY') {
            currentBet.status = 'LOST';
            console.log(`LOST: Failed to cash out. Stake: ${currentBet.amount}`);
        }
        
        // Clear all bet info
        currentBet = null;

        // Reset display after a short time
        setTimeout(() => {
            document.getElementById('plane').classList.add('hidden');
            document.getElementById('live-multiplier').classList.add('hidden');
            startNewRound();
        }, 1500); // 1.5 seconds visibility for burst
    }

    // --- B. Game Engine & Animation ---

    /**
     * Server-less Burst Point Generation (Deterministic Pseudo-Random)
     * Uses the current UTC hour as a seed to generate the same sequence
     * for all users, fulfilling the "same multiplier at same time" requirement.
     * @returns {number} The burst multiplier (e.g., 1.50, 7.82)
     */
    function generateDeterministicMultiplier() {
        const now = new Date();
        // Use Nairobi Time (UTC+3) for the seed calculation
        // Calculate UTC+3 hour: now.getUTCHours() + 3
        const seed = now.getUTCFullYear() + '' + now.getUTCMonth() + '' + now.getUTCDate() + '' + (now.getUTCHours() + 3);

        // Simple PRNG function (e.g., LCG) based on the seed
        function prng(seed) {
            let s = seed % 2147483647;
            if (s <= 0) s += 2147483646;
            return function() {
                s = (s * 16807) % 2147483647;
                return (s - 1) / 2147483646;
            };
        }

        const random = prng(parseInt(seed));
        // Multiplier Generation: Low chance for very high numbers
        const r = random();
        // Aviator multiplier formula often involves exponential decay: 1 / (1 - r) * (1 - 0.01)
        // We'll use a simpler formula for a predictable range (1.00 to ~20.00)
        let multiplier = Math.max(1.00, Math.pow(1 / (1 - r), 1.2) * (0.5)); 
        return Math.floor(multiplier * 100) / 100; // Round to 2 decimal places
    }

    function updatePlanePosition(elapsedTime) {
        // Plane path logic: Diagonal (3/4) then wavy (1/4)
        const plane = document.getElementById('plane');
        const area = document.getElementById('aviator-area');
        const maxDiagonal = Math.min(area.offsetWidth, area.offsetHeight) * 0.75; // 3/4 of area diagonal
        const multiplierFactor = Math.log(currentMultiplier);

        let x = 0;
        let y = 0;

        // Stage 1: Diagonal movement (until 3/4 of max diagonal)
        if (multiplierFactor * 100 < maxDiagonal) {
            // X increases with increasing increment, Y reduces with increasing reduction (diagonal)
            x = 20 + multiplierFactor * 150; // Simple diagonal move
            y = area.offsetHeight - (20 + multiplierFactor * 150);
        }
        // Stage 2: Wavy movement
        else {
            // Final horizontal position
            x = area.offsetWidth * 0.75;
            
            // Wavy motion: up and down smoothly
            const waveSpeed = 0.005; 
            const waveAmplitude = 50; 
            // Y increases (up) and reduces (down) smoothly
            y = area.offsetHeight * 0.5 + Math.sin(elapsedTime * waveSpeed) * waveAmplitude;
        }

        // Keep plane within box
        x = Math.min(x, area.offsetWidth - 50);
        y = Math.max(y, 20); // Not above top
        y = Math.min(y, area.offsetHeight - 20); // Not below bottom

        plane.style.left = `${x}px`;
        plane.style.top = `${y}px`;
    }

    function gameLoop(currentTime) {
        if (gameState === 'FLYING') {
            const deltaTime = currentTime - lastTime;
            lastTime = currentTime;

            // Simple exponential growth simulation for multiplier
            currentMultiplier += (currentMultiplier * PLANE_SPEED) * deltaTime;
            currentMultiplier = Math.min(currentMultiplier, generatedMultiplier + 0.01); // Don't overshoot too much

            document.getElementById('live-multiplier').textContent = `X${currentMultiplier.toFixed(2)}`;

            updatePlanePosition(currentTime);
            updateBetBar();

            if (currentMultiplier >= generatedMultiplier) {
                burstRound();
            }
        }
        
        // Continuously request new frame
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    function startGameLoop() {
        if (animationFrameId) {
            cancelAnimationFrame(animationFrameId);
        }
        startNewRound(); // Initialize first round
        animationFrameId = requestAnimationFrame(gameLoop);
    }

    // --- Initialize ---
    window.onload = () => {
        // Load initial state (if any saved data)
        updateBalanceDisplay();
        updateBetDisplay(document.getElementById('stake-input').value);
        
        // Log out logic: If not logged in, show auth screen
        // For this demo, we assume the user needs to login every time.
    };

    // NOTE: This simple version requires user to hit F5/Refresh to simulate log-out/re-login from other apps
</script>

</body>
</html>
