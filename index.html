<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Aviator</title>
    <style>
        /* --- CSS STYLING --- */
        :root {
            --bg-color: #000000;
            --panel-bg: #1b1b1b;
            --primary-red: #E23D3D;
            --success-green: #28a745;
            --btn-yellow: #ffc107;
            --text-white: #ffffff;
            --text-grey: #888888;
        }

        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            font-family: 'Arial', sans-serif;
            color: var(--text-white);
            overflow: hidden;
            user-select: none; /* Prevent text selection */
        }

        /* --- LOGIN / AUTH SCREEN --- */
        #auth-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #0f0f0f; /* Blueish tint requested? Keeping dark for game feel */
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .auth-box {
            width: 80%;
            max-width: 350px;
            background: #222;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .auth-input {
            width: 90%;
            padding: 12px;
            margin: 10px 0;
            background: #333;
            border: 1px solid #444;
            color: white;
            border-radius: 5px;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            margin-top: 10px;
        }

        .btn-primary { background: var(--success-green); color: white; }
        .btn-secondary { background: #444; color: white; }

        .toggle-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* --- GAME INTERFACE --- */
        #game-screen {
            display: none; /* Hidden by default */
            flex-direction: column;
            height: 100%;
            width: 100%;
        }

        /* TOP BAR (25% height approx split) */
        .top-bar {
            height: 60px;
            display: flex;
            justify-content: space-between;
            padding: 10px;
            box-sizing: border-box;
            align-items: center;
        }

        .stat-box {
            border-radius: 20px;
            padding: 8px 15px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 100px;
        }

        #withdraw-btn {
            background: var(--btn-yellow);
            color: black;
            cursor: pointer;
            position: relative;
        }

        #balance-display {
            background: var(--success-green);
            color: white;
        }

        /* PAST MULTIPLIERS */
        .history-bar {
            height: 30px;
            background: #111;
            display: flex;
            align-items: center;
            overflow: hidden;
            padding-left: 10px;
            gap: 5px;
        }

        .history-pill {
            background: #333;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            color: #ccc;
        }
        .history-pill.high { color: var(--primary-red); }

        /* GAME CANVAS (Main Area) */
        .game-area {
            flex-grow: 1;
            position: relative;
            background: black;
            overflow: hidden;
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .center-info {
            position: absolute;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: none;
        }

        #live-multiplier {
            font-size: 60px;
            font-weight: bold;
            color: white;
        }

        #game-status {
            font-size: 18px;
            color: var(--btn-yellow);
            margin-bottom: 5px;
        }

        /* BOTTOM CONTROLS (25% approx) */
        .control-panel {
            background: #151515;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            gap: 10px;
            height: 120px;
            align-items: center;
            border-top: 2px solid #333;
        }

        /* Left: Stake Input */
        .stake-container {
            flex: 1;
            background: #222;
            border-radius: 10px;
            padding: 10px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 80%;
        }

        .stake-label { font-size: 12px; color: #888; margin-bottom: 5px; }
        
        #stake-input {
            background: black;
            border: 1px solid #444;
            color: white;
            font-size: 20px;
            width: 100%;
            text-align: center;
            padding: 5px 0;
            border-radius: 5px;
        }

        /* Right: Big Button */
        .action-btn-container {
            flex: 1.5;
            height: 80%;
        }

        #main-action-btn {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
            font-size: 22px;
            font-weight: bold;
            color: white;
            background: var(--success-green); /* Default Bet Green */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 0 #1e7e34;
            transition: all 0.1s;
        }

        #main-action-btn:active {
            transform: translateY(4px);
            box-shadow: none;
        }

        /* Button States */
        .btn-bet { background: var(--success-green) !important; box-shadow: 0 4px 0 #1e7e34 !important; }
        .btn-cashout { background: var(--btn-yellow) !important; color: black !important; box-shadow: 0 4px 0 #d39e00 !important; }
        .btn-cancel { background: var(--primary-red) !important; box-shadow: 0 4px 0 #bd2130 !important; }

        .btn-subtext { font-size: 12px; font-weight: normal; opacity: 0.8; margin-top: 5px; }

        /* Withdrawal Popover */
        #withdraw-modal {
            position: absolute;
            top: 70px;
            left: 10px;
            background: #2a2a2a;
            padding: 10px;
            border-radius: 8px;
            display: none;
            z-index: 200;
            width: 200px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }

        .proceed-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 5px;
            width: 100%;
            margin-top: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        /* Admin Data (Hidden generally, but included for logic) */
        #admin-log { display: none; }

    </style>
</head>
<body>

    <div id="auth-screen">
        <h2 style="color:white; margin-bottom:30px;">AVIATOR</h2>
        <div class="auth-box" id="login-box">
            <h3>Login</h3>
            <input type="tel" id="login-phone" class="auth-input" placeholder="Phone Number">
            <input type="password" id="login-pass" class="auth-input" placeholder="Password">
            <button class="btn btn-primary" onclick="handleLogin()">Log In</button>
            <button class="btn btn-secondary" onclick="toggleAuthMode('signup')">Create Account</button>
        </div>

        <div class="auth-box" id="signup-box" style="display:none;">
            <h3>Create Account</h3>
            <input type="tel" id="signup-phone" class="auth-input" placeholder="Phone Number">
            <input type="password" id="signup-pass" class="auth-input" placeholder="Password">
            <input type="password" id="signup-confirm" class="auth-input" placeholder="Confirm Password">
            <label style="color:#888; font-size:12px;"><input type="checkbox" onclick="togglePassVisibility()"> Show Password</label>
            <button class="btn btn-primary" onclick="handleSignup()">Register</button>
            <button class="btn btn-secondary" onclick="toggleAuthMode('login')">Back to Login</button>
        </div>
    </div>

    <div id="game-screen">
        
        <div class="top-bar">
            <div class="stat-box" id="withdraw-btn" onclick="toggleWithdrawModal()">
                Withdraw
                <div id="withdraw-modal">
                    <input type="number" id="withdraw-amount" placeholder="Amount" class="auth-input" style="width:90%; margin:0;">
                    <button class="proceed-btn" onclick="processWithdraw()">PROCEED</button>
                </div>
            </div>
            <div class="stat-box" id="balance-display">1000.00</div>
        </div>

        <div class="history-bar" id="history-bar">
            </div>

        <div class="game-area" id="game-area">
            <div class="center-info">
                <div id="game-status">WAITING FOR NEXT ROUND</div>
                <div id="live-multiplier">1.00x</div>
                <div id="loading-bar" style="height:4px; background:red; width:0%; transition: width 0.1s;"></div>
            </div>
            <canvas id="gameCanvas"></canvas>
        </div>

        <div class="control-panel">
            <div class="stake-container">
                <div class="stake-label">STAKE</div>
                <input type="number" id="stake-input" value="10.00" min="1">
                <div style="display:flex; justify-content:space-around; margin-top:5px;">
                    <button style="background:#333; border:none; color:#fff; border-radius:4px;" onclick="adjustStake(-5)">-</button>
                    <button style="background:#333; border:none; color:#fff; border-radius:4px;" onclick="adjustStake(5)">+</button>
                </div>
            </div>

            <div class="action-btn-container">
                <button id="main-action-btn" onclick="handleMainAction()">
                    <span id="btn-text">BET</span>
                    <span id="btn-sub" class="btn-subtext">Next Round</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        /** * --- LOGIC & STATE MANAGEMENT --- 
         */
        
        // --- USER STATE ---
        let currentUser = null;
        let balance = 1000.00;

        // --- GAME STATE ---
        const STATE_WAITING = 0; // 5 second countdown
        const STATE_FLYING = 1;  // Plane moving, multiplier rising
        const STATE_BURST = 2;   // Plane flew away
        
        let gameState = STATE_WAITING;
        let currentMultiplier = 1.00;
        let crashPoint = 1.00;
        
        // --- BETTING STATE ---
        let stakeAmount = 10.00;
        let activeBet = null; // The bet placed for the current LIVE round
        let nextRoundBet = null; // The bet queued for the NEXT round
        
        // --- TIMING & LOOP ---
        let lastTime = 0;
        let countdownTimer = 5.00;
        let planeX = 0;
        let planeY = 0;
        let animationId;

        // --- CANVAS SETUP ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            canvas.width = document.getElementById('game-area').clientWidth;
            canvas.height = document.getElementById('game-area').clientHeight;
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        /* =========================================
           1. AUTHENTICATION LOGIC
           ========================================= */
        
        function toggleAuthMode(mode) {
            document.getElementById('login-box').style.display = mode === 'login' ? 'block' : 'none';
            document.getElementById('signup-box').style.display = mode === 'signup' ? 'block' : 'none';
        }

        function togglePassVisibility() {
            const p1 = document.getElementById('signup-pass');
            const p2 = document.getElementById('signup-confirm');
            p1.type = p1.type === 'password' ? 'text' : 'password';
            p2.type = p2.type === 'password' ? 'text' : 'password';
        }

        function handleSignup() {
            const phone = document.getElementById('signup-phone').value;
            const pass = document.getElementById('signup-pass').value;
            const confirm = document.getElementById('signup-confirm').value;

            if(pass !== confirm) { alert("Passwords do not match"); return; }
            if(!phone || !pass) { alert("Fill all fields"); return; }

            // Save to LocalStorage (Simulating DB)
            const user = { phone, pass, balance: 1000 };
            localStorage.setItem('user_' + phone, JSON.stringify(user));
            
            alert("Account created! Please log in.");
            toggleAuthMode('login');
            
            // ADMIN SIMULATION: Log new user
            console.log("[ADMIN] New User Registered:", phone);
        }

        function handleLogin() {
            const phone = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-pass').value;
            
            const storedData = localStorage.getItem('user_' + phone);
            if (!storedData) { alert("User not found"); return; }

            const user = JSON.parse(storedData);
            if (user.pass !== pass) { alert("Wrong password"); return; }

            // Success
            currentUser = user;
            balance = user.balance;
            updateBalanceUI();
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('game-screen').style.display = 'flex';
            
            resizeCanvas();
            startGameLoop();
            
            // Check if we should logout on visibility change
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'hidden') {
                    // User left tab or minimized
                    alert("Session timed out for security. Please log in again.");
                    location.reload();
                }
            });
        }

        /* =========================================
           2. GAME LOOP & LOGIC
           ========================================= */

        // Generate a crash point based on time (Nairobi Sim)
        // This ensures users roughly see the same result without a server
        function generateCrashPoint() {
            // Use current time rounded to 10 seconds as seed
            const seed = Math.floor(Date.now() / 10000); 
            // Simple pseudo-random generator based on seed
            const x = Math.sin(seed++) * 10000;
            let random = x - Math.floor(x); // 0.0 to 1.0
            
            // Aviator Logic: 
            // 1% chance of instant burst (1.00)
            // Otherwise generated using exponential distribution
            // E = 1 / (1-r) roughly
            
            let multiplier = 0.99 / (1 - random);
            if(multiplier < 1) multiplier = 1;
            if(random < 0.05) multiplier = 1.00; // Occasional instant loss
            
            // Cap at sensible high
            if(multiplier > 100) multiplier = 100;
            
            return parseFloat(multiplier.toFixed(2));
        }

        function startGameLoop() {
            lastTime = Date.now();
            requestAnimationFrame(update);
        }

        function update() {
            const now = Date.now();
            const dt = (now - lastTime) / 1000; // Delta time in seconds
            lastTime = now;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (gameState === STATE_WAITING) {
                updateWaiting(dt);
            } else if (gameState === STATE_FLYING) {
                updateFlying(dt);
            } else if (gameState === STATE_BURST) {
                updateBurst(dt);
            }

            updateUI();
            requestAnimationFrame(update);
        }

        function updateWaiting(dt) {
            countdownTimer -= dt;
            
            // Logic for next round bet
            // Users can cancel or bet during this time
            
            if (countdownTimer <= 0) {
                // START FLIGHT
                startFlight();
            }
        }

        function startFlight() {
            gameState = STATE_FLYING;
            crashPoint = generateCrashPoint();
            currentMultiplier = 1.00;
            planeX = 0;
            planeY = canvas.height;

            // ADMIN VIEW
            console.log(`[ADMIN] Round Started. Will crash at: ${crashPoint}x`);

            // Process Queue Bet
            if (nextRoundBet) {
                activeBet = nextRoundBet; // Move queued bet to active
                nextRoundBet = null; // Clear queue
                
                // Deduct Balance HERE (as per requirement logic: deduct when round starts/joined)
                balance -= activeBet.amount;
                updateBalanceUI();
            }
        }

        function updateFlying(dt) {
            // Increase Multiplier (Exponential curve)
            currentMultiplier += (currentMultiplier * 0.15 * dt) + 0.001;
            
            // Move Plane
            // X Axis: Moves right until 75% of screen
            const maxX = canvas.width * 0.75;
            const speedX = canvas.width * 0.2; // Speed across screen
            
            if (planeX < maxX) {
                planeX += speedX * dt;
                // Diagonal Up
                planeY = canvas.height - (planeX * 0.8); // Linear diagonal
            } else {
                // Waving Motion
                planeX = maxX;
                // Smooth Sine wave oscillation
                const waveSpeed = 3;
                const waveHeight = 50;
                // Base height + Sine wave
                const baseHeight = canvas.height * 0.25; // Stay high up
                planeY = baseHeight + Math.sin(Date.now() / 300) * waveHeight;
            }

            drawPlane(planeX, planeY);

            // Check Crash
            if (currentMultiplier >= crashPoint) {
                burst();
            }
        }

        function burst() {
            gameState = STATE_BURST;
            countdownTimer = 5.0; // Reset countdown for next round
            
            // Add to history
            const hist = document.getElementById('history-bar');
            const pill = document.createElement('div');
            pill.className = 'history-pill ' + (crashPoint >= 2.0 ? 'high' : '');
            pill.innerText = crashPoint.toFixed(2) + 'x';
            hist.prepend(pill);
            if(hist.children.length > 10) hist.removeChild(hist.lastChild);

            // Handle Loss logic
            if (activeBet) {
                // If activeBet still exists, they didn't cash out. LOSS.
                activeBet = null;
            }
        }

        function updateBurst(dt) {
            // Plane flies off screen rapidly
            planeX += 1000 * dt;
            planeY -= 500 * dt;
            drawPlane(planeX, planeY);

            // 2 second pause before countdown starts again
            if (planeX > canvas.width + 200) {
                // Wait slightly then go to waiting
                setTimeout(() => {
                    if(gameState === STATE_BURST) gameState = STATE_WAITING;
                }, 2000);
            }
        }

        /* =========================================
           3. DRAWING (VISUALS)
           ========================================= */
        function drawPlane(x, y) {
            ctx.fillStyle = "#E23D3D"; // Red Plane
            ctx.beginPath();
            // Simple Plane Shape
            ctx.moveTo(x, y);
            ctx.lineTo(x - 30, y + 10);
            ctx.lineTo(x - 30, y - 10);
            ctx.fill();
            
            // Trajectory Line (Curve)
            ctx.strokeStyle = "#E23D3D";
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, canvas.height);
            ctx.quadraticCurveTo(x/2, canvas.height, x, y);
            ctx.stroke();

            // Show Multiplier above plane if flying
            if (gameState === STATE_FLYING) {
                ctx.fillStyle = "white";
                ctx.font = "bold 20px Arial";
                ctx.fillText(currentMultiplier.toFixed(2) + "x", x - 20, y - 20);
            }
        }

        /* =========================================
           4. BETTING & CONTROLS LOGIC
           ========================================= */
        
        function updateUI() {
            const statusEl = document.getElementById('game-status');
            const multiEl = document.getElementById('live-multiplier');
            const btn = document.getElementById('main-action-btn');
            const btnText = document.getElementById('btn-text');
            const btnSub = document.getElementById('btn-sub');

            if (gameState === STATE_WAITING) {
                statusEl.innerText = "STARTING IN " + Math.ceil(countdownTimer) + "s";
                statusEl.style.color = "white";
                multiEl.innerText = "WAITING";
                document.getElementById('loading-bar').style.width = ((5 - countdownTimer)/5 * 100) + "%";
                
                // BUTTON LOGIC IN WAITING
                if (nextRoundBet) {
                    // User has placed a bet for the coming round
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Waiting for round";
                } else {
                    // Standard Bet Button
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = "Next Round";
                }

            } else if (gameState === STATE_FLYING) {
                statusEl.innerText = "LIVE ROUND";
                statusEl.style.color = "#28a745";
                multiEl.innerText = currentMultiplier.toFixed(2) + "x";
                
                // BUTTON LOGIC IN FLYING
                if (activeBet) {
                    // User is IN the game
                    btn.className = "btn-cashout";
                    // Calculate potential win
                    const winAmount = (activeBet.amount * currentMultiplier).toFixed(2);
                    btnText.innerText = "CASH OUT";
                    btnSub.innerText = winAmount;
                } else if (nextRoundBet) {
                    // User bet for NEXT round while this one is flying
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Wait for next round";
                } else {
                    // User missed round, can bet for next
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = "For Next Round";
                }

            } else if (gameState === STATE_BURST) {
                statusEl.innerText = "FLEW AWAY @ " + crashPoint.toFixed(2) + "x";
                statusEl.style.color = "#E23D3D"; // Red
                multiEl.innerText = crashPoint.toFixed(2) + "x";
                
                // Button behaves same as Waiting/End of round
                if (nextRoundBet) {
                    btn.className = "btn-cancel";
                    btnText.innerText = "CANCEL";
                    btnSub.innerText = "Waiting...";
                } else {
                    btn.className = "btn-bet";
                    btnText.innerText = "BET";
                    btnSub.innerText = "Next Round";
                }
            }
        }

        // Handle Main Button Click
        function handleMainAction() {
            const amount = parseFloat(document.getElementById('stake-input').value);

            // 1. CASHOUT (Priority if Flying and Active)
            if (gameState === STATE_FLYING && activeBet) {
                // SUCCESS!
                const winnings = activeBet.amount * currentMultiplier;
                balance += winnings;
                updateBalanceUI();
                activeBet = null; // Bet finished
                
                // ADMIN: Log Win
                console.log(`[ADMIN] User Won: ${winnings}`);
                return;
            }

            // 2. CANCEL (If waiting for next round)
            if (nextRoundBet) {
                // If cancelling a queued bet
                nextRoundBet = null;
                // Note: Balance wasn't deducted yet according to logic prompt
                // (Prompt said deduct immediately when round STARTS for active bets)
                // BUT prompt also said "receives back balance".
                // To simplify: We deduct when moving from Queue -> Active. 
                // So if it's just queued, we just remove the queue. No money moved yet.
                return;
            }

            // 3. PLACE BET (Queue for next round)
            if (!nextRoundBet && !activeBet) {
                if (amount > balance) { alert("Insufficient Balance"); return; }
                
                // Create Queued Bet
                nextRoundBet = { amount: amount };
                
                // If we are in WAITING phase (5s countdown), we can treat this as joining the coming draw
                // Logic check: Prompt says deduct immediately if clicked during waiting? 
                // Let's follow the "Deduct when round starts" logic for safety, 
                // unless user specifically wants immediate deduction. 
                // The visual cue "Waiting for next round" implies queue.
            }
        }

        function adjustStake(val) {
            let v = parseFloat(document.getElementById('stake-input').value);
            v += val;
            if(v < 1) v = 1;
            document.getElementById('stake-input').value = v;
        }

        function updateBalanceUI() {
            document.getElementById('balance-display').innerText = balance.toFixed(2);
            // Sync to storage
            if(currentUser) {
                currentUser.balance = balance;
                localStorage.setItem('user_' + currentUser.phone, JSON.stringify(currentUser));
            }
        }

        /* =========================================
           5. WITHDRAWAL LOGIC
           ========================================= */
        function toggleWithdrawModal() {
            const modal = document.getElementById('withdraw-modal');
            modal.style.display = (modal.style.display === 'block') ? 'none' : 'block';
        }

        function processWithdraw() {
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            if (isNaN(amt) || amt <= 0) return;
            if (amt > balance) { alert("Insufficient Balance"); return; }

            // Deduct
            balance -= amt;
            updateBalanceUI();

            // UI Feedback
            const btn = document.querySelector('.proceed-btn');
            const originalText = btn.innerText;
            btn.style.background = "green";
            btn.innerText = "SUBMITTED";

            // ADMIN LOG (Simulating Email)
            console.log(`[ADMIN EMAIL] WITHDRAW REQUEST: User ${currentUser.phone} requested ${amt}.`);

            setTimeout(() => {
                toggleWithdrawModal();
                btn.innerText = originalText;
                btn.style.background = "#007bff";
                document.getElementById('withdraw-amount').value = "";
            }, 1500);
        }

    </script>
</body>
</html>
